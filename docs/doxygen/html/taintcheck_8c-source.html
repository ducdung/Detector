<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html><head>
<meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1"/>
<meta name="keywords" content="TEMU, dynamic analysis, binary analysis, dynamic
taint analysis"/>
<meta name="description" content="C/C++/OCaml Source Code Documentation for the TEMU Project."/>
<title>TEMU: taintcheck.c Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css"/>
</head><body>
<p class="title">TEMU: Dynamic Binary Analysis Platform</p>
<!-- Generated by Doxygen 1.5.8 -->
<div class="navigation" id="top">
  <div class="tabs">
    <ul>
      <li><a href="index.html"><span>Main&nbsp;Page</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="annotated.html"><span>Data&nbsp;Structures</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
      <li><a href="dirs.html"><span>Directories</span></a></li>
    <li>
      <form action="search.php" method="get">
        <table cellspacing="0" cellpadding="0" border="0">
          <tr>
            <td><label>&nbsp;<u>S</u>earch&nbsp;for&nbsp;</label></td>
            <td><input type="text" name="query" value="" size="20" accesskey="s"/></td>
          </tr>
        </table>
      </form>
    </li>
    </ul>
  </div>
  <div class="tabs">
    <ul>
      <li><a href="files.html"><span>File&nbsp;List</span></a></li>
      <li><a href="globals.html"><span>Globals</span></a></li>
    </ul>
  </div>
  <div class="navpath"><a class="el" href="dir_4f22f3fd3d3cce94a331ff7cdf0bf085.html">temu-1.0</a>
  </div>
</div>
<div class="contents">
<h1>taintcheck.c</h1><a href="taintcheck_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="comment">/*</span>
<a name="l00002"></a>00002 <span class="comment">TEMU is Copyright (C) 2006-2009, BitBlaze Team.</span>
<a name="l00003"></a>00003 <span class="comment"></span>
<a name="l00004"></a>00004 <span class="comment">TEMU is based on QEMU, a whole-system emulator. You can redistribute</span>
<a name="l00005"></a>00005 <span class="comment">and modify it under the terms of the GNU LGPL, version 2.1 or later,</span>
<a name="l00006"></a>00006 <span class="comment">but it is made available WITHOUT ANY WARRANTY. See the top-level</span>
<a name="l00007"></a>00007 <span class="comment">README file for more details.</span>
<a name="l00008"></a>00008 <span class="comment"></span>
<a name="l00009"></a>00009 <span class="comment">For more information about TEMU and other BitBlaze software, see our</span>
<a name="l00010"></a>00010 <span class="comment">web site at: http://bitblaze.cs.berkeley.edu/</span>
<a name="l00011"></a>00011 <span class="comment">*/</span>
<a name="l00012"></a>00012 
<a name="l00013"></a>00013 <span class="comment">/********************************************************************</span>
<a name="l00014"></a>00014 <span class="comment"> * @brief This file contains the major functionality of maintaining taint </span>
<a name="l00015"></a>00015 <span class="comment"> * information in registers and memory and devices (like NIC and HD).</span>
<a name="l00016"></a>00016 <span class="comment"> */</span>
<a name="l00017"></a>00017 
<a name="l00018"></a>00018 
<a name="l00019"></a>00019 <span class="preprocessor">#include &lt;dlfcn.h&gt;</span>
<a name="l00020"></a>00020 <span class="preprocessor">#include &lt;assert.h&gt;</span>
<a name="l00021"></a>00021 <span class="preprocessor">#include &lt;sys/queue.h&gt;</span>
<a name="l00022"></a>00022 <span class="preprocessor">#include "hw/hw.h"</span>
<a name="l00023"></a>00023 <span class="preprocessor">#include "qemu-common.h"</span>
<a name="l00024"></a>00024 <span class="preprocessor">#include "sysemu.h"</span>
<a name="l00025"></a>00025 <span class="preprocessor">#include "hw/hw.h"</span> <span class="comment">/* {de,}register_savevm */</span>
<a name="l00026"></a>00026 <span class="preprocessor">#include "<a class="code" href="taintcheck_8h.html">taintcheck.h</a>"</span>
<a name="l00027"></a>00027 <span class="preprocessor">#include "<a class="code" href="TEMU__main_8h.html">TEMU_main.h</a>"</span>
<a name="l00028"></a>00028 
<a name="l00029"></a>00029 <span class="preprocessor">#if TAINT_ENABLED</span>
<a name="l00030"></a>00030 <span class="preprocessor"></span>
<a name="l00031"></a>00031 <span class="preprocessor">#define TAINTCHECK_DEBUG 0</span>
<a name="l00032"></a>00032 <span class="preprocessor"></span>
<a name="l00033"></a>00033 <span class="preprocessor">#ifdef IMPACT_ANALYSIS</span>
<a name="l00034"></a><a class="code" href="taintcheck_8h.html#715072d74cf2c64819bb46e850ad0879">00034</a> <span class="preprocessor"></span><span class="keywordtype">int</span> <a class="code" href="taintcheck_8c.html#715072d74cf2c64819bb46e850ad0879">impact_propagate</a> = 1;
<a name="l00035"></a>00035 <span class="preprocessor">#endif</span>
<a name="l00036"></a>00036 <span class="preprocessor"></span>
<a name="l00037"></a>00037 <span class="preprocessor">#define min(X,Y) ((X) &lt; (Y) ? (X) : (Y))</span>
<a name="l00038"></a>00038 <span class="preprocessor"></span><span class="comment"></span>
<a name="l00039"></a>00039 <span class="comment">/*!</span>
<a name="l00040"></a>00040 <span class="comment"> An internal data structure for holding 64-byte taint information in memory</span>
<a name="l00041"></a>00041 <span class="comment"> */</span>
<a name="l00042"></a><a class="code" href="struct__tpage__entry.html">00042</a> <span class="keyword">typedef</span> <span class="keyword">struct </span><a class="code" href="struct__tpage__entry.html">_tpage_entry</a> {
<a name="l00043"></a><a class="code" href="struct__tpage__entry.html#222b55ca1f0afa174750083b33ccd275">00043</a>   uint64_t <a class="code" href="struct__tpage__entry.html#222b55ca1f0afa174750083b33ccd275">bitmap</a>;              <span class="comment">/*!&lt;one bit for each byte. */</span>
<a name="l00044"></a><a class="code" href="struct__tpage__entry.html#5dca50c79db35c0fc6c510c7f6f3db2c">00044</a>   uint8_t <a class="code" href="struct__tpage__entry.html#5dca50c79db35c0fc6c510c7f6f3db2c">records</a>[0];           <span class="comment">/*!&lt;stores taint records defined by plugin. */</span>
<a name="l00045"></a>00045 } <a class="code" href="struct__tpage__entry.html">tpage_entry_t</a>;
<a name="l00046"></a>00046 
<a name="l00047"></a><a class="code" href="taintcheck_8h.html#5efcc8557acedd802898b6be6e743c77">00047</a> uint64_t <a class="code" href="taintcheck_8c.html#5efcc8557acedd802898b6be6e743c77" title="bitmap for registers">regs_bitmap</a> = 0; <span class="comment">//!&lt;bitmap for registers</span>
<a name="l00048"></a><a class="code" href="taintcheck_8h.html#ba165d9e6ff6e82b3c63a9be1f6c97cc">00048</a> <span class="comment"></span>uint8_t *<a class="code" href="taintcheck_8c.html#ba165d9e6ff6e82b3c63a9be1f6c97cc" title="taint records for registers">regs_records</a> = NULL; <span class="comment">//!&lt;taint records for registers</span>
<a name="l00049"></a><a class="code" href="taintcheck_8c.html#262a1531434f1b70825218019a06ec93">00049</a> <span class="comment"></span><span class="keyword">static</span> <a class="code" href="struct__tpage__entry.html">tpage_entry_t</a> **<a class="code" href="taintcheck_8c.html#262a1531434f1b70825218019a06ec93" title="memory page table">tpage_table</a> = NULL; <span class="comment">//!&lt;memory page table</span>
<a name="l00050"></a>00050 <span class="comment"></span>
<a name="l00051"></a><a class="code" href="taintcheck_8h.html#327231a22ed182c09b21712588339ef5">00051</a> uint64_t <a class="code" href="taintcheck_8c.html#327231a22ed182c09b21712588339ef5" title="bitmap for nic">nic_bitmap</a>[1024 * 32 / 64]; <span class="comment">//!&lt;bitmap for nic</span>
<a name="l00052"></a><a class="code" href="taintcheck_8h.html#e5345edd4e3618ea3fd53a7b8f46e832">00052</a> <span class="comment"></span>uint8_t *<a class="code" href="taintcheck_8c.html#e5345edd4e3618ea3fd53a7b8f46e832" title="taint records for nic">nic_records</a> = NULL; <span class="comment">//!&lt;taint records for nic</span>
<a name="l00053"></a>00053 <span class="comment"></span>
<a name="l00054"></a>00054 <span class="preprocessor">#if TAINT_FLAGS</span>
<a name="l00055"></a><a class="code" href="taintcheck_8c.html#855ce47fe535eabefb35fb2e80b8d927">00055</a> <span class="preprocessor"></span>uint32_t <a class="code" href="taintcheck_8c.html#855ce47fe535eabefb35fb2e80b8d927" title="bitmap for eflags">eflags_bitmap</a> = 0; <span class="comment">//!&lt;bitmap for eflags</span>
<a name="l00056"></a><a class="code" href="taintcheck_8c.html#761549a83ed3004382812e355cef7c1e">00056</a> <span class="comment"></span>uint8_t * <a class="code" href="taintcheck_8c.html#761549a83ed3004382812e355cef7c1e" title="taint records for eflags">eflags_records</a> = NULL; <span class="comment">//!&lt;taint records for eflags</span>
<a name="l00057"></a>00057 <span class="comment"></span><span class="preprocessor">#endif</span>
<a name="l00058"></a>00058 <span class="preprocessor"></span>
<a name="l00059"></a><a class="code" href="taintcheck_8c.html#71e88e58ade75bc77d27e73427431a8d">00059</a> <span class="keywordtype">int</span> <a class="code" href="taintcheck_8c.html#71e88e58ade75bc77d27e73427431a8d">taintcheck_keyorigin</a> = 0;
<a name="l00060"></a><a class="code" href="taintcheck_8h.html#8ba4dce789e7fe78985beb63f5f0f01a">00060</a> <span class="keywordtype">int</span> <a class="code" href="taintcheck_8c.html#8ba4dce789e7fe78985beb63f5f0f01a" title="flag that indicates if the current instruction propagates taint">insn_tainted</a> = 0; <span class="comment">//!&lt;flag that indicates if the current instruction propagates taint</span>
<a name="l00061"></a>00061 <span class="comment"></span>
<a name="l00062"></a><a class="code" href="taintcheck_8c.html#1ccca6d08d0095f0c7c74cd502c82900">00062</a> <span class="keyword">static</span> <span class="keyword">inline</span> uint64_t <a class="code" href="taintcheck_8c.html#1ccca6d08d0095f0c7c74cd502c82900">size_to_taint</a>(<span class="keywordtype">int</span> <a class="code" href="taintcheck_8h.html#c5171f8c3bbd36e5425e886a5e20e790">size</a>)  <span class="comment">//size&lt;=64</span>
<a name="l00063"></a>00063 {
<a name="l00064"></a>00064   <span class="keywordflow">return</span> (size &lt; 64) ? (1ULL &lt;&lt; size) - 1 : (uint64_t) (-1);
<a name="l00065"></a>00065 }
<a name="l00066"></a>00066 
<a name="l00067"></a>00067 
<a name="l00068"></a><a class="code" href="taintcheck_8c.html#76e98a9a904319586334f594defa87ed">00068</a> <span class="keyword">static</span> <span class="keyword">inline</span> uint8_t <a class="code" href="taintcheck_8c.html#76e98a9a904319586334f594defa87ed">taint_reg_check</a>(<span class="keywordtype">int</span> regidx, <span class="keywordtype">int</span> <a class="code" href="taintcheck_8h.html#c5171f8c3bbd36e5425e886a5e20e790">size</a>)
<a name="l00069"></a>00069 {
<a name="l00070"></a>00070   <span class="keywordflow">return</span> ((1ULL &lt;&lt; size) - 1) &amp; (<a class="code" href="taintcheck_8c.html#5efcc8557acedd802898b6be6e743c77" title="bitmap for registers">regs_bitmap</a> &gt;&gt; regidx);
<a name="l00071"></a>00071 }
<a name="l00072"></a>00072 <span class="comment"></span>
<a name="l00073"></a>00073 <span class="comment">///fast version memory taint check, without boundary check</span>
<a name="l00074"></a><a class="code" href="taintcheck_8c.html#7a240b504a8e7bf8935b5b091ea293c9">00074</a> <span class="comment"></span><span class="keyword">static</span> <span class="keyword">inline</span> uint64_t <a class="code" href="taintcheck_8c.html#7a240b504a8e7bf8935b5b091ea293c9" title="fast version memory taint check, without boundary check">fast_taint_mem_check</a>(uint32_t addr, <span class="keywordtype">int</span> <a class="code" href="taintcheck_8h.html#c5171f8c3bbd36e5425e886a5e20e790">size</a>)
<a name="l00075"></a>00075 {
<a name="l00076"></a>00076   <a class="code" href="struct__tpage__entry.html">tpage_entry_t</a> * entry = tpage_table[addr&gt;&gt;6];
<a name="l00077"></a>00077   <span class="keywordflow">return</span> entry? (entry-&gt;<a class="code" href="struct__tpage__entry.html#222b55ca1f0afa174750083b33ccd275">bitmap</a> &gt;&gt; (addr &amp;63)) &amp; <a class="code" href="taintcheck_8c.html#1ccca6d08d0095f0c7c74cd502c82900">size_to_taint</a>(size): 0; 
<a name="l00078"></a>00078 }
<a name="l00079"></a>00079 
<a name="l00080"></a><a class="code" href="taintcheck_8c.html#7ded7aac43f68faa84aaf843c2986afa">00080</a> <span class="keyword">static</span> <span class="keyword">inline</span> uint64_t <a class="code" href="taintcheck_8c.html#7ded7aac43f68faa84aaf843c2986afa">taint_mem_check</a>(uint32_t addr, <span class="keywordtype">int</span> <a class="code" href="taintcheck_8h.html#c5171f8c3bbd36e5425e886a5e20e790">size</a>) <span class="comment">//size &lt;=64</span>
<a name="l00081"></a>00081 {
<a name="l00082"></a>00082   uint32_t margin = 64 - (addr &amp; 63);
<a name="l00083"></a>00083   <span class="keywordflow">if</span>(size &lt;= margin)
<a name="l00084"></a>00084     <span class="keywordflow">return</span> <a class="code" href="taintcheck_8c.html#7a240b504a8e7bf8935b5b091ea293c9" title="fast version memory taint check, without boundary check">fast_taint_mem_check</a>(addr, size);
<a name="l00085"></a>00085   
<a name="l00086"></a>00086   uint64_t taint = <a class="code" href="taintcheck_8c.html#7a240b504a8e7bf8935b5b091ea293c9" title="fast version memory taint check, without boundary check">fast_taint_mem_check</a>(addr, margin);
<a name="l00087"></a>00087   taint |= (<a class="code" href="taintcheck_8c.html#7a240b504a8e7bf8935b5b091ea293c9" title="fast version memory taint check, without boundary check">fast_taint_mem_check</a>(addr + margin, size - margin) &lt;&lt; margin); 
<a name="l00088"></a>00088   <span class="keywordflow">return</span> taint;
<a name="l00089"></a>00089 }
<a name="l00090"></a>00090 
<a name="l00091"></a><a class="code" href="taintcheck_8c.html#3b2012dda04976904d8e143456b07dbd">00091</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="taintcheck_8c.html#3b2012dda04976904d8e143456b07dbd">fast_taint_memory</a>(uint32_t addr, <span class="keywordtype">int</span> <a class="code" href="taintcheck_8h.html#c5171f8c3bbd36e5425e886a5e20e790">size</a>, uint64_t taint)
<a name="l00092"></a>00092 {
<a name="l00093"></a>00093   uint32_t index = addr &gt;&gt; 6;
<a name="l00094"></a>00094   <a class="code" href="struct__tpage__entry.html">tpage_entry_t</a> *entry = tpage_table[index];
<a name="l00095"></a>00095   <span class="keywordflow">if</span>(entry == NULL) {
<a name="l00096"></a>00096     <span class="keywordflow">if</span>(taint == 0)
<a name="l00097"></a>00097       <span class="keywordflow">return</span>;
<a name="l00098"></a>00098     entry = (<a class="code" href="struct__tpage__entry.html">tpage_entry_t</a> *)qemu_mallocz(
<a name="l00099"></a>00099     <span class="keyword">sizeof</span>(<a class="code" href="struct__tpage__entry.html">tpage_entry_t</a>) + 64 * <a class="code" href="TEMU__main_8c.html#a93b5270782d60adbbe1e95b3f87befd">temu_plugin</a>-&gt;<a class="code" href="structplugin__interface__t.html#cf6b2847bc302d9e0c94ca21fd81a75d" title="size of taint record for each tainted byte. TEMU sees taint record as untyped buffer...">taint_record_size</a>);
<a name="l00100"></a>00100     <span class="keywordflow">if</span>(!entry) {
<a name="l00101"></a>00101       fprintf(stderr, <span class="stringliteral">"out of memory \n"</span>);
<a name="l00102"></a>00102       <span class="keywordflow">return</span>;
<a name="l00103"></a>00103     } 
<a name="l00104"></a>00104     tpage_table[index] = entry;
<a name="l00105"></a>00105     entry-&gt;<a class="code" href="struct__tpage__entry.html#222b55ca1f0afa174750083b33ccd275">bitmap</a> = taint &lt;&lt; (addr &amp; 63);
<a name="l00106"></a>00106   } <span class="keywordflow">else</span> {
<a name="l00107"></a>00107     uint32_t offset = addr &amp; 63;
<a name="l00108"></a>00108     entry-&gt;<a class="code" href="struct__tpage__entry.html#222b55ca1f0afa174750083b33ccd275">bitmap</a> &amp;= ~(<a class="code" href="taintcheck_8c.html#1ccca6d08d0095f0c7c74cd502c82900">size_to_taint</a>(size) &lt;&lt; offset);
<a name="l00109"></a>00109     entry-&gt;<a class="code" href="struct__tpage__entry.html#222b55ca1f0afa174750083b33ccd275">bitmap</a> |= (taint &lt;&lt; offset);
<a name="l00110"></a>00110     <span class="keywordflow">if</span> (entry-&gt;<a class="code" href="struct__tpage__entry.html#222b55ca1f0afa174750083b33ccd275">bitmap</a> == 0) {
<a name="l00111"></a>00111       qemu_free(entry);
<a name="l00112"></a>00112       tpage_table[index] = NULL;
<a name="l00113"></a>00113     }
<a name="l00114"></a>00114   }
<a name="l00115"></a>00115 }
<a name="l00116"></a>00116 
<a name="l00117"></a>00117 
<a name="l00118"></a><a class="code" href="taintcheck_8c.html#9282ff4d76a2b38f3cbc23e3991e6311">00118</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="taintcheck_8c.html#9282ff4d76a2b38f3cbc23e3991e6311">taint_memory</a>(uint32_t addr, <span class="keywordtype">int</span> <a class="code" href="taintcheck_8h.html#c5171f8c3bbd36e5425e886a5e20e790">size</a>, uint64_t taint)
<a name="l00119"></a>00119 {
<a name="l00120"></a>00120   uint32_t margin = 64 - (addr &amp; 63);
<a name="l00121"></a>00121 
<a name="l00122"></a>00122   <span class="keywordflow">if</span>(size &lt;= margin)
<a name="l00123"></a>00123     <a class="code" href="taintcheck_8c.html#3b2012dda04976904d8e143456b07dbd">fast_taint_memory</a>(addr, size, taint);
<a name="l00124"></a>00124   <span class="keywordflow">else</span> {
<a name="l00125"></a>00125     <a class="code" href="taintcheck_8c.html#3b2012dda04976904d8e143456b07dbd">fast_taint_memory</a>(addr, margin, taint &amp; <a class="code" href="taintcheck_8c.html#1ccca6d08d0095f0c7c74cd502c82900">size_to_taint</a>(margin));
<a name="l00126"></a>00126     <a class="code" href="taintcheck_8c.html#3b2012dda04976904d8e143456b07dbd">fast_taint_memory</a>(addr+margin, size-margin, taint&gt;&gt;margin);
<a name="l00127"></a>00127   }
<a name="l00128"></a>00128 }
<a name="l00129"></a>00129 
<a name="l00130"></a><a class="code" href="taintcheck_8c.html#9b183a641e8e6248fa11fe67d2c1d9a0">00130</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="taintcheck_8c.html#9b183a641e8e6248fa11fe67d2c1d9a0">fast_clean_memory</a>(uint32_t addr, <span class="keywordtype">int</span> <a class="code" href="taintcheck_8h.html#c5171f8c3bbd36e5425e886a5e20e790">size</a>)
<a name="l00131"></a>00131 {
<a name="l00132"></a>00132   <a class="code" href="struct__tpage__entry.html">tpage_entry_t</a> *entry;
<a name="l00133"></a>00133   uint32_t index = addr &gt;&gt; 6;
<a name="l00134"></a>00134   <span class="keywordflow">if</span>((entry = tpage_table[index])) {
<a name="l00135"></a>00135     uint32_t offset = addr &amp; 63;
<a name="l00136"></a>00136 <span class="preprocessor">#if 0 //def MEM_CLEAN</span>
<a name="l00137"></a>00137 <span class="preprocessor"></span>    uint64_t taint = (entry-&gt;<a class="code" href="struct__tpage__entry.html#222b55ca1f0afa174750083b33ccd275">bitmap</a> &gt;&gt; offset) &amp; <a class="code" href="taintcheck_8c.html#1ccca6d08d0095f0c7c74cd502c82900">size_to_taint</a>(size);
<a name="l00138"></a>00138     <span class="keywordflow">if</span>(taint) 
<a name="l00139"></a>00139       <a class="code" href="TEMU__main_8c.html#a93b5270782d60adbbe1e95b3f87befd">temu_plugin</a>-&gt;mem_clean(addr, size, taint, 
<a name="l00140"></a>00140     entry-&gt;<a class="code" href="struct__tpage__entry.html#5dca50c79db35c0fc6c510c7f6f3db2c">records</a>+offset*<a class="code" href="TEMU__main_8c.html#a93b5270782d60adbbe1e95b3f87befd">temu_plugin</a>-&gt;<a class="code" href="structplugin__interface__t.html#cf6b2847bc302d9e0c94ca21fd81a75d" title="size of taint record for each tainted byte. TEMU sees taint record as untyped buffer...">taint_record_size</a>);
<a name="l00141"></a>00141 <span class="preprocessor">#endif</span>
<a name="l00142"></a>00142 <span class="preprocessor"></span>    entry-&gt;<a class="code" href="struct__tpage__entry.html#222b55ca1f0afa174750083b33ccd275">bitmap</a> &amp;= ~(<a class="code" href="taintcheck_8c.html#1ccca6d08d0095f0c7c74cd502c82900">size_to_taint</a>(size) &lt;&lt; offset);
<a name="l00143"></a>00143     <span class="keywordflow">if</span> (entry-&gt;<a class="code" href="struct__tpage__entry.html#222b55ca1f0afa174750083b33ccd275">bitmap</a> == 0) {
<a name="l00144"></a>00144       qemu_free(entry);
<a name="l00145"></a>00145       tpage_table[index] = NULL;
<a name="l00146"></a>00146     }
<a name="l00147"></a>00147   }
<a name="l00148"></a>00148 }
<a name="l00149"></a>00149 
<a name="l00150"></a><a class="code" href="taintcheck_8c.html#741ed09f5bd96a9e703040433fecb3af">00150</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="taintcheck_8c.html#741ed09f5bd96a9e703040433fecb3af">clean_memory</a>(uint32_t addr, <span class="keywordtype">int</span> <a class="code" href="taintcheck_8h.html#c5171f8c3bbd36e5425e886a5e20e790">size</a>) <span class="comment">//size &lt;= 64</span>
<a name="l00151"></a>00151 {
<a name="l00152"></a>00152   uint32_t margin = 64 - (addr&amp;63);
<a name="l00153"></a>00153 
<a name="l00154"></a>00154   <span class="keywordflow">if</span>(size &lt;= margin) 
<a name="l00155"></a>00155     <a class="code" href="taintcheck_8c.html#9b183a641e8e6248fa11fe67d2c1d9a0">fast_clean_memory</a>(addr, size);
<a name="l00156"></a>00156   <span class="keywordflow">else</span> {
<a name="l00157"></a>00157     <a class="code" href="taintcheck_8c.html#9b183a641e8e6248fa11fe67d2c1d9a0">fast_clean_memory</a>(addr, margin);
<a name="l00158"></a>00158     <a class="code" href="taintcheck_8c.html#9b183a641e8e6248fa11fe67d2c1d9a0">fast_clean_memory</a>(addr + margin, size - margin);
<a name="l00159"></a>00159   }
<a name="l00160"></a>00160 }
<a name="l00161"></a>00161 
<a name="l00162"></a>00162 
<a name="l00163"></a><a class="code" href="taintcheck_8c.html#5297c0dd74a0ea8ab628243ab6d6b060">00163</a> <span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">void</span> <a class="code" href="taintcheck_8c.html#5297c0dd74a0ea8ab628243ab6d6b060">taint_register</a>(<span class="keywordtype">int</span> regidx, <span class="keywordtype">int</span> <a class="code" href="taintcheck_8h.html#c5171f8c3bbd36e5425e886a5e20e790">size</a>, uint64_t taint)
<a name="l00164"></a>00164 {
<a name="l00165"></a>00165 <span class="preprocessor">#ifdef STACK_REGISTER_NO_TAINT</span>
<a name="l00166"></a>00166 <span class="preprocessor"></span>  <span class="keywordflow">if</span>(regidx &gt;= 16 &amp;&amp; regidx &lt;24) <span class="keywordflow">return</span>; 
<a name="l00167"></a>00167 <span class="preprocessor">#endif</span>
<a name="l00168"></a>00168 <span class="preprocessor"></span>  uint64_t mask = (1ULL &lt;&lt; size) - 1;
<a name="l00169"></a>00169   <a class="code" href="taintcheck_8c.html#5efcc8557acedd802898b6be6e743c77" title="bitmap for registers">regs_bitmap</a> &amp;= ~(mask &lt;&lt; regidx);
<a name="l00170"></a>00170   <a class="code" href="taintcheck_8c.html#5efcc8557acedd802898b6be6e743c77" title="bitmap for registers">regs_bitmap</a> |= (taint &amp; mask) &lt;&lt; regidx;
<a name="l00171"></a>00171 }
<a name="l00172"></a>00172 
<a name="l00173"></a><a class="code" href="taintcheck_8c.html#974495ac1261e65922b3590a970613a6">00173</a> <span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">void</span> <a class="code" href="taintcheck_8c.html#974495ac1261e65922b3590a970613a6">clean_register</a>(<span class="keywordtype">int</span> regidx, <span class="keywordtype">int</span> <a class="code" href="taintcheck_8h.html#c5171f8c3bbd36e5425e886a5e20e790">size</a>)
<a name="l00174"></a>00174 {
<a name="l00175"></a>00175   uint64_t mask = (1ULL &lt;&lt; size) - 1;
<a name="l00176"></a>00176   <a class="code" href="taintcheck_8c.html#5efcc8557acedd802898b6be6e743c77" title="bitmap for registers">regs_bitmap</a> &amp;= ~(mask &lt;&lt; regidx);
<a name="l00177"></a>00177 }
<a name="l00178"></a>00178 
<a name="l00179"></a><a class="code" href="taintcheck_8c.html#e0354bf288bcec353063475b7a89bbf0">00179</a> <span class="keyword">static</span> <span class="keyword">inline</span> uint8_t <a class="code" href="taintcheck_8c.html#e0354bf288bcec353063475b7a89bbf0">clear_zero</a>(uint32_t value, <span class="keywordtype">int</span> <a class="code" href="taintcheck_8h.html#c5171f8c3bbd36e5425e886a5e20e790">size</a>, uint8_t taint)       <span class="comment">//size&lt;=4</span>
<a name="l00180"></a>00180 {
<a name="l00181"></a>00181 <span class="preprocessor">#if 1</span>
<a name="l00182"></a>00182 <span class="preprocessor"></span>  <span class="keywordtype">int</span> i;
<a name="l00183"></a>00183   uint32_t v = 0xff;
<a name="l00184"></a>00184   uint8_t taint2 = taint;
<a name="l00185"></a>00185 
<a name="l00186"></a>00186   <span class="keywordflow">for</span> (i = 0; i &lt; size; i++, v &lt;&lt;= 8) {
<a name="l00187"></a>00187     <span class="keywordflow">if</span> ((value &amp; v) == 0)
<a name="l00188"></a>00188       taint2 &amp;= ~(1 &lt;&lt; i);
<a name="l00189"></a>00189   }
<a name="l00190"></a>00190   <span class="keywordflow">return</span> taint2;
<a name="l00191"></a>00191 <span class="preprocessor">#endif</span>
<a name="l00192"></a>00192 <span class="preprocessor"></span><span class="comment">//  if (!value)</span>
<a name="l00193"></a>00193 <span class="comment">//    return 0;</span>
<a name="l00194"></a>00194   <span class="keywordflow">return</span> taint;
<a name="l00195"></a>00195 }
<a name="l00196"></a>00196 <span class="comment"></span>
<a name="l00197"></a>00197 <span class="comment">/// Propagate taint info from register to memory</span>
<a name="l00198"></a><a class="code" href="taintcheck_8h.html#0f23f812bbc43b0d3c03e7c405e6c822">00198</a> <span class="comment"></span><span class="keywordtype">void</span> <a class="code" href="taintcheck_8c.html#f975ece5cd68bb4f43b74c2161070975" title="Propagate taint info from register to memory.">__attribute__</a>((fastcall)) <a class="code" href="taintcheck_8h.html#23e63eea3b9485175199ba007ad7d7ce">taintcheck_reg2mem</a>(<span class="keywordtype">int</span> regidx, <span class="keywordtype">int</span> <a class="code" href="taintcheck_8h.html#c5171f8c3bbd36e5425e886a5e20e790">size</a>, <span class="keywordtype">void</span> *ptr)
<a name="l00199"></a>00199 {
<a name="l00200"></a>00200   <span class="keywordflow">if</span>(!<a class="code" href="group__main.html#gf24f155e5a9b6ee9bc9a6e6ef9c3987d" title="This flag tells if emulation mode is enabled.">TEMU_emulation_started</a>) <span class="keywordflow">return</span>;
<a name="l00201"></a>00201 
<a name="l00202"></a>00202   uint32_t addr = (uint8_t *) ptr - phys_ram_base;
<a name="l00203"></a>00203   <span class="keywordflow">if</span>(__builtin_expect(addr &gt;= ram_size, 0)) <span class="keywordflow">return</span>;
<a name="l00204"></a>00204 
<a name="l00205"></a>00205 <span class="preprocessor">#ifdef REG_CHECK</span>
<a name="l00206"></a>00206 <span class="preprocessor"></span>  <a class="code" href="TEMU__main_8c.html#a93b5270782d60adbbe1e95b3f87befd">temu_plugin</a>-&gt;<a class="code" href="structplugin__interface__t.html#f9db66146dd22bdad23b09bf2f013a6d" title="This callback is invoked when the current instruction reads a register.">reg_read</a>(regidx, size);
<a name="l00207"></a>00207 <span class="preprocessor">#endif</span>
<a name="l00208"></a>00208 <span class="preprocessor"></span>
<a name="l00209"></a>00209 <span class="preprocessor">#ifdef PRE_MEM_WRITE</span>
<a name="l00210"></a>00210 <span class="preprocessor"></span>  <a class="code" href="TEMU__main_8c.html#a93b5270782d60adbbe1e95b3f87befd">temu_plugin</a>-&gt;<a class="code" href="structplugin__interface__t.html#655dd7f42359c9e4fc0c00186492d4ba">pre_mem_write</a>(cpu_single_env-&gt;regs[R_A0], addr, size);
<a name="l00211"></a>00211 <span class="preprocessor">#endif</span>
<a name="l00212"></a>00212 <span class="preprocessor"></span>
<a name="l00213"></a>00213 
<a name="l00214"></a>00214 <span class="preprocessor">#ifndef NO_PROPAGATE</span>
<a name="l00215"></a>00215 <span class="preprocessor"></span>  uint8_t taint;
<a name="l00216"></a>00216   uint32_t offset = addr &amp; 63;
<a name="l00217"></a>00217 
<a name="l00218"></a>00218   <span class="keywordflow">if</span> (offset + size &lt;= 64) {
<a name="l00219"></a>00219     taint = <a class="code" href="taintcheck_8c.html#76e98a9a904319586334f594defa87ed">taint_reg_check</a>(regidx, size);
<a name="l00220"></a>00220 <span class="preprocessor">#ifdef TAINTCHECK_CLEAR_ZERO</span>
<a name="l00221"></a>00221 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (taint)
<a name="l00222"></a>00222       taint = <a class="code" href="taintcheck_8c.html#e0354bf288bcec353063475b7a89bbf0">clear_zero</a>(cpu_single_env-&gt;regs[regidx &gt;&gt; 2] &gt;&gt; (regidx &amp; 3),
<a name="l00223"></a>00223                        size, taint);
<a name="l00224"></a>00224 <span class="preprocessor">#endif</span>
<a name="l00225"></a>00225 <span class="preprocessor"></span>
<a name="l00226"></a>00226     <span class="keywordflow">if</span>(taint) {
<a name="l00227"></a>00227       <a class="code" href="taintcheck_8c.html#3b2012dda04976904d8e143456b07dbd">fast_taint_memory</a>(addr, size, taint);
<a name="l00228"></a>00228       <a class="code" href="taintcheck_8c.html#8ba4dce789e7fe78985beb63f5f0f01a" title="flag that indicates if the current instruction propagates taint">insn_tainted</a> = 1;
<a name="l00229"></a>00229       <a class="code" href="structtaint__operand__t.html">taint_operand_t</a> src, dst;
<a name="l00230"></a>00230       src.<a class="code" href="structtaint__operand__t.html#578c2946959431293fc2d85dfb4e8a89">type</a> = 0; dst.<a class="code" href="structtaint__operand__t.html#578c2946959431293fc2d85dfb4e8a89">type</a> = 1;
<a name="l00231"></a>00231       src.<a class="code" href="structtaint__operand__t.html#4950a2ce5b28b9e1c9fc99fe6c5c4149">size</a> = dst.<a class="code" href="structtaint__operand__t.html#4950a2ce5b28b9e1c9fc99fe6c5c4149">size</a> = size;
<a name="l00232"></a>00232       dst.<a class="code" href="structtaint__operand__t.html#0b7d021002413c1ac97f5414612db18f">taint</a> = src.<a class="code" href="structtaint__operand__t.html#0b7d021002413c1ac97f5414612db18f">taint</a> = taint;
<a name="l00233"></a>00233       src.<a class="code" href="structtaint__operand__t.html#9b9f04ae0f4017c6231a5b21244d4646">addr</a> = regidx, dst.<a class="code" href="structtaint__operand__t.html#9b9f04ae0f4017c6231a5b21244d4646">addr</a> = addr;
<a name="l00234"></a>00234       src.<a class="code" href="structtaint__operand__t.html#dec24928b14ad823f99afff44dfbe045">records</a> =
<a name="l00235"></a>00235         <a class="code" href="taintcheck_8c.html#ba165d9e6ff6e82b3c63a9be1f6c97cc" title="taint records for registers">regs_records</a> + regidx * <a class="code" href="TEMU__main_8c.html#a93b5270782d60adbbe1e95b3f87befd">temu_plugin</a>-&gt;<a class="code" href="structplugin__interface__t.html#cf6b2847bc302d9e0c94ca21fd81a75d" title="size of taint record for each tainted byte. TEMU sees taint record as untyped buffer...">taint_record_size</a>;
<a name="l00236"></a>00236       dst.<a class="code" href="structtaint__operand__t.html#dec24928b14ad823f99afff44dfbe045">records</a> =
<a name="l00237"></a>00237         tpage_table[addr &gt;&gt; 6]-&gt;<a class="code" href="struct__tpage__entry.html#5dca50c79db35c0fc6c510c7f6f3db2c">records</a> + offset * <a class="code" href="TEMU__main_8c.html#a93b5270782d60adbbe1e95b3f87befd">temu_plugin</a>-&gt;<a class="code" href="structplugin__interface__t.html#cf6b2847bc302d9e0c94ca21fd81a75d" title="size of taint record for each tainted byte. TEMU sees taint record as untyped buffer...">taint_record_size</a>;
<a name="l00238"></a>00238       <a class="code" href="TEMU__main_8c.html#a93b5270782d60adbbe1e95b3f87befd">temu_plugin</a>-&gt;<a class="code" href="structplugin__interface__t.html#9d9c6f38a85ffe4738755a465115c94f" title="This callback customizes its own policy for taint propagation.">taint_propagate</a>(1, &amp;src, &amp;dst, PROP_MODE_MOVE);
<a name="l00239"></a>00239     } <span class="keywordflow">else</span>
<a name="l00240"></a>00240       <a class="code" href="taintcheck_8c.html#9b183a641e8e6248fa11fe67d2c1d9a0">fast_clean_memory</a>(addr, size);
<a name="l00241"></a>00241   } <span class="keywordflow">else</span> {
<a name="l00242"></a>00242     <span class="keywordtype">int</span> size1 = 64-offset, size2 = size - size1;
<a name="l00243"></a>00243     taint = <a class="code" href="taintcheck_8c.html#76e98a9a904319586334f594defa87ed">taint_reg_check</a>(regidx, size1);
<a name="l00244"></a>00244 <span class="preprocessor">#ifdef TAINTCHECK_CLEAR_ZERO</span>
<a name="l00245"></a>00245 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (taint)
<a name="l00246"></a>00246       taint = <a class="code" href="taintcheck_8c.html#e0354bf288bcec353063475b7a89bbf0">clear_zero</a>(cpu_single_env-&gt;regs[regidx &gt;&gt; 2] &gt;&gt; (regidx &amp; 3),
<a name="l00247"></a>00247                        size1, taint);
<a name="l00248"></a>00248 <span class="preprocessor">#endif</span>
<a name="l00249"></a>00249 <span class="preprocessor"></span>
<a name="l00250"></a>00250     <span class="keywordflow">if</span>(taint) {
<a name="l00251"></a>00251       <a class="code" href="taintcheck_8c.html#3b2012dda04976904d8e143456b07dbd">fast_taint_memory</a>(addr, size1, taint);
<a name="l00252"></a>00252       <a class="code" href="taintcheck_8c.html#8ba4dce789e7fe78985beb63f5f0f01a" title="flag that indicates if the current instruction propagates taint">insn_tainted</a> = 1;
<a name="l00253"></a>00253       <a class="code" href="structtaint__operand__t.html">taint_operand_t</a> src, dst;
<a name="l00254"></a>00254       src.<a class="code" href="structtaint__operand__t.html#578c2946959431293fc2d85dfb4e8a89">type</a> = 0; dst.<a class="code" href="structtaint__operand__t.html#578c2946959431293fc2d85dfb4e8a89">type</a> = 1;
<a name="l00255"></a>00255       src.<a class="code" href="structtaint__operand__t.html#4950a2ce5b28b9e1c9fc99fe6c5c4149">size</a> = dst.<a class="code" href="structtaint__operand__t.html#4950a2ce5b28b9e1c9fc99fe6c5c4149">size</a> = size1;
<a name="l00256"></a>00256       dst.<a class="code" href="structtaint__operand__t.html#0b7d021002413c1ac97f5414612db18f">taint</a> = src.<a class="code" href="structtaint__operand__t.html#0b7d021002413c1ac97f5414612db18f">taint</a> = taint;
<a name="l00257"></a>00257       src.<a class="code" href="structtaint__operand__t.html#9b9f04ae0f4017c6231a5b21244d4646">addr</a> = regidx, dst.<a class="code" href="structtaint__operand__t.html#9b9f04ae0f4017c6231a5b21244d4646">addr</a> = addr;
<a name="l00258"></a>00258       src.<a class="code" href="structtaint__operand__t.html#dec24928b14ad823f99afff44dfbe045">records</a> =
<a name="l00259"></a>00259         <a class="code" href="taintcheck_8c.html#ba165d9e6ff6e82b3c63a9be1f6c97cc" title="taint records for registers">regs_records</a> + regidx * <a class="code" href="TEMU__main_8c.html#a93b5270782d60adbbe1e95b3f87befd">temu_plugin</a>-&gt;<a class="code" href="structplugin__interface__t.html#cf6b2847bc302d9e0c94ca21fd81a75d" title="size of taint record for each tainted byte. TEMU sees taint record as untyped buffer...">taint_record_size</a>;
<a name="l00260"></a>00260       dst.<a class="code" href="structtaint__operand__t.html#dec24928b14ad823f99afff44dfbe045">records</a> =
<a name="l00261"></a>00261         tpage_table[addr &gt;&gt; 6]-&gt;<a class="code" href="struct__tpage__entry.html#5dca50c79db35c0fc6c510c7f6f3db2c">records</a> + offset * <a class="code" href="TEMU__main_8c.html#a93b5270782d60adbbe1e95b3f87befd">temu_plugin</a>-&gt;<a class="code" href="structplugin__interface__t.html#cf6b2847bc302d9e0c94ca21fd81a75d" title="size of taint record for each tainted byte. TEMU sees taint record as untyped buffer...">taint_record_size</a>;
<a name="l00262"></a>00262       <a class="code" href="TEMU__main_8c.html#a93b5270782d60adbbe1e95b3f87befd">temu_plugin</a>-&gt;<a class="code" href="structplugin__interface__t.html#9d9c6f38a85ffe4738755a465115c94f" title="This callback customizes its own policy for taint propagation.">taint_propagate</a>(1, &amp;src, &amp;dst, PROP_MODE_MOVE);
<a name="l00263"></a>00263     } <span class="keywordflow">else</span> 
<a name="l00264"></a>00264       <a class="code" href="taintcheck_8c.html#9b183a641e8e6248fa11fe67d2c1d9a0">fast_clean_memory</a>(addr, size1);
<a name="l00265"></a>00265 
<a name="l00266"></a>00266     taint = <a class="code" href="taintcheck_8c.html#76e98a9a904319586334f594defa87ed">taint_reg_check</a>(regidx+size1, size2);
<a name="l00267"></a>00267 <span class="preprocessor">#ifdef TAINTCHECK_CLEAR_ZERO</span>
<a name="l00268"></a>00268 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (taint)
<a name="l00269"></a>00269       taint = <a class="code" href="taintcheck_8c.html#e0354bf288bcec353063475b7a89bbf0">clear_zero</a>(cpu_single_env-&gt;regs[regidx &gt;&gt; 2] &gt;&gt; ((regidx+size1)&amp; 3),
<a name="l00270"></a>00270                        size2, taint);
<a name="l00271"></a>00271 <span class="preprocessor">#endif</span>
<a name="l00272"></a>00272 <span class="preprocessor"></span>    <span class="keywordflow">if</span>(taint) {
<a name="l00273"></a>00273       <a class="code" href="taintcheck_8c.html#3b2012dda04976904d8e143456b07dbd">fast_taint_memory</a>(addr+size1, size2, taint);
<a name="l00274"></a>00274       <a class="code" href="taintcheck_8c.html#8ba4dce789e7fe78985beb63f5f0f01a" title="flag that indicates if the current instruction propagates taint">insn_tainted</a> = 1;
<a name="l00275"></a>00275       <a class="code" href="structtaint__operand__t.html">taint_operand_t</a> src, dst;
<a name="l00276"></a>00276       src.<a class="code" href="structtaint__operand__t.html#578c2946959431293fc2d85dfb4e8a89">type</a> = 0; dst.<a class="code" href="structtaint__operand__t.html#578c2946959431293fc2d85dfb4e8a89">type</a> = 1;
<a name="l00277"></a>00277       src.<a class="code" href="structtaint__operand__t.html#4950a2ce5b28b9e1c9fc99fe6c5c4149">size</a> = dst.<a class="code" href="structtaint__operand__t.html#4950a2ce5b28b9e1c9fc99fe6c5c4149">size</a> = size2;
<a name="l00278"></a>00278       dst.<a class="code" href="structtaint__operand__t.html#0b7d021002413c1ac97f5414612db18f">taint</a> = src.<a class="code" href="structtaint__operand__t.html#0b7d021002413c1ac97f5414612db18f">taint</a> = taint;
<a name="l00279"></a>00279       src.<a class="code" href="structtaint__operand__t.html#9b9f04ae0f4017c6231a5b21244d4646">addr</a> = regidx + size1, dst.<a class="code" href="structtaint__operand__t.html#9b9f04ae0f4017c6231a5b21244d4646">addr</a> = addr + size1;
<a name="l00280"></a>00280       src.<a class="code" href="structtaint__operand__t.html#dec24928b14ad823f99afff44dfbe045">records</a> =
<a name="l00281"></a>00281         <a class="code" href="taintcheck_8c.html#ba165d9e6ff6e82b3c63a9be1f6c97cc" title="taint records for registers">regs_records</a> + (regidx+size1)*<a class="code" href="TEMU__main_8c.html#a93b5270782d60adbbe1e95b3f87befd">temu_plugin</a>-&gt;<a class="code" href="structplugin__interface__t.html#cf6b2847bc302d9e0c94ca21fd81a75d" title="size of taint record for each tainted byte. TEMU sees taint record as untyped buffer...">taint_record_size</a>;
<a name="l00282"></a>00282       dst.<a class="code" href="structtaint__operand__t.html#dec24928b14ad823f99afff44dfbe045">records</a> = tpage_table[(addr&gt;&gt;6)+1]-&gt;<a class="code" href="struct__tpage__entry.html#5dca50c79db35c0fc6c510c7f6f3db2c">records</a>;
<a name="l00283"></a>00283       <a class="code" href="TEMU__main_8c.html#a93b5270782d60adbbe1e95b3f87befd">temu_plugin</a>-&gt;<a class="code" href="structplugin__interface__t.html#9d9c6f38a85ffe4738755a465115c94f" title="This callback customizes its own policy for taint propagation.">taint_propagate</a>(1, &amp;src, &amp;dst, PROP_MODE_MOVE);
<a name="l00284"></a>00284     } <span class="keywordflow">else</span> 
<a name="l00285"></a>00285       <a class="code" href="taintcheck_8c.html#9b183a641e8e6248fa11fe67d2c1d9a0">fast_clean_memory</a>(addr+size1, size2);
<a name="l00286"></a>00286   }
<a name="l00287"></a>00287 <span class="preprocessor">#endif //NO_PROPAGATE</span>
<a name="l00288"></a>00288 <span class="preprocessor"></span>
<a name="l00289"></a>00289 <span class="preprocessor">#ifdef MEM_CHECK</span>
<a name="l00290"></a>00290 <span class="preprocessor"></span>  <a class="code" href="TEMU__main_8c.html#a93b5270782d60adbbe1e95b3f87befd">temu_plugin</a>-&gt;<a class="code" href="structplugin__interface__t.html#dd4182588b3fe9c6d815c5b38b9f4625" title="This callback is invoked when the current instruction writes a memory region.">mem_write</a>(cpu_single_env-&gt;regs[R_A0], addr, size);
<a name="l00291"></a>00291 <span class="preprocessor">#endif</span>
<a name="l00292"></a>00292 <span class="preprocessor"></span>}
<a name="l00293"></a>00293 
<a name="l00294"></a>00294 
<a name="l00295"></a>00295 <span class="keywordtype">void</span> <a class="code" href="taintcheck_8c.html#f975ece5cd68bb4f43b74c2161070975" title="Propagate taint info from register to memory.">__attribute__</a>((fastcall)) <a class="code" href="taintcheck_8h.html#a59de35e3cf6276a15845cbe7bc8b0c3">taintcheck_mem2reg</a>(<span class="keywordtype">void</span> *ptr, <span class="keywordtype">int</span> <a class="code" href="taintcheck_8h.html#c5171f8c3bbd36e5425e886a5e20e790">size</a>, <span class="keywordtype">int</span> regidx)
<a name="l00296"></a>00296 {
<a name="l00297"></a>00297   <span class="keywordflow">if</span>(!<a class="code" href="group__main.html#gf24f155e5a9b6ee9bc9a6e6ef9c3987d" title="This flag tells if emulation mode is enabled.">TEMU_emulation_started</a>) <span class="keywordflow">return</span>;
<a name="l00298"></a>00298 
<a name="l00299"></a>00299   uint32_t addr = (uint8_t *) ptr - phys_ram_base;
<a name="l00300"></a>00300   <span class="keywordflow">if</span>(__builtin_expect(addr &gt;= ram_size, 0)) <span class="keywordflow">return</span>;
<a name="l00301"></a>00301 
<a name="l00302"></a>00302 <span class="preprocessor">#ifdef MEM_CHECK</span>
<a name="l00303"></a>00303 <span class="preprocessor"></span>  <a class="code" href="TEMU__main_8c.html#a93b5270782d60adbbe1e95b3f87befd">temu_plugin</a>-&gt;<a class="code" href="structplugin__interface__t.html#2ee53fc1918838c58f2c574562b24e40" title="This callback is invoked when the current instruction reads a memory region.">mem_read</a>(cpu_single_env-&gt;regs[R_A0], addr, size);
<a name="l00304"></a>00304 <span class="preprocessor">#endif</span>
<a name="l00305"></a>00305 <span class="preprocessor"></span>
<a name="l00306"></a>00306 <span class="preprocessor">#ifndef NO_PROPAGATE</span>
<a name="l00307"></a>00307 <span class="preprocessor"></span>  uint8_t taint, taint1;
<a name="l00308"></a>00308   uint32_t offset = addr &amp; 63;
<a name="l00309"></a>00309   uint8_t index_taint = <a class="code" href="taintcheck_8c.html#76e98a9a904319586334f594defa87ed">taint_reg_check</a>(R_A0 * 4, 4);
<a name="l00310"></a>00310 
<a name="l00311"></a>00311   <span class="keywordflow">if</span>(offset + size &lt;= 64) {
<a name="l00312"></a>00312     taint1 = <a class="code" href="taintcheck_8c.html#7a240b504a8e7bf8935b5b091ea293c9" title="fast version memory taint check, without boundary check">fast_taint_mem_check</a>(addr, size);
<a name="l00313"></a>00313     taint = index_taint? (1&lt;&lt;size)-1 : taint1;
<a name="l00314"></a>00314     <span class="keywordflow">if</span> (taint) {
<a name="l00315"></a>00315       <a class="code" href="taintcheck_8c.html#8ba4dce789e7fe78985beb63f5f0f01a" title="flag that indicates if the current instruction propagates taint">insn_tainted</a> = 1;
<a name="l00316"></a>00316       <a class="code" href="taintcheck_8c.html#5297c0dd74a0ea8ab628243ab6d6b060">taint_register</a>(regidx, size, taint);
<a name="l00317"></a>00317       <a class="code" href="structtaint__operand__t.html">taint_operand_t</a> src[2], dst;
<a name="l00318"></a>00318       src[0].<a class="code" href="structtaint__operand__t.html#578c2946959431293fc2d85dfb4e8a89">type</a> = 1; <span class="comment">//memory</span>
<a name="l00319"></a>00319       dst.<a class="code" href="structtaint__operand__t.html#578c2946959431293fc2d85dfb4e8a89">type</a> = 0;                 <span class="comment">//register</span>
<a name="l00320"></a>00320       src[0].<a class="code" href="structtaint__operand__t.html#4950a2ce5b28b9e1c9fc99fe6c5c4149">size</a> = dst.<a class="code" href="structtaint__operand__t.html#4950a2ce5b28b9e1c9fc99fe6c5c4149">size</a> = size;
<a name="l00321"></a>00321       src[0].<a class="code" href="structtaint__operand__t.html#0b7d021002413c1ac97f5414612db18f">taint</a> = taint1;
<a name="l00322"></a>00322 
<a name="l00323"></a>00323       dst.<a class="code" href="structtaint__operand__t.html#0b7d021002413c1ac97f5414612db18f">taint</a> = taint;
<a name="l00324"></a>00324       src[0].<a class="code" href="structtaint__operand__t.html#9b9f04ae0f4017c6231a5b21244d4646">addr</a> = addr, dst.<a class="code" href="structtaint__operand__t.html#9b9f04ae0f4017c6231a5b21244d4646">addr</a> = regidx;
<a name="l00325"></a>00325       src[0].<a class="code" href="structtaint__operand__t.html#dec24928b14ad823f99afff44dfbe045">records</a> = tpage_table[addr&gt;&gt;6]-&gt;<a class="code" href="struct__tpage__entry.html#5dca50c79db35c0fc6c510c7f6f3db2c">records</a> + 
<a name="l00326"></a>00326         offset*<a class="code" href="TEMU__main_8c.html#a93b5270782d60adbbe1e95b3f87befd">temu_plugin</a>-&gt;<a class="code" href="structplugin__interface__t.html#cf6b2847bc302d9e0c94ca21fd81a75d" title="size of taint record for each tainted byte. TEMU sees taint record as untyped buffer...">taint_record_size</a>;
<a name="l00327"></a>00327       dst.<a class="code" href="structtaint__operand__t.html#dec24928b14ad823f99afff44dfbe045">records</a> = <a class="code" href="taintcheck_8c.html#ba165d9e6ff6e82b3c63a9be1f6c97cc" title="taint records for registers">regs_records</a> + <a class="code" href="TEMU__main_8c.html#a93b5270782d60adbbe1e95b3f87befd">temu_plugin</a>-&gt;<a class="code" href="structplugin__interface__t.html#cf6b2847bc302d9e0c94ca21fd81a75d" title="size of taint record for each tainted byte. TEMU sees taint record as untyped buffer...">taint_record_size</a>*regidx;
<a name="l00328"></a>00328 
<a name="l00329"></a>00329       <span class="keywordflow">if</span>(index_taint) {
<a name="l00330"></a>00330         src[1].<a class="code" href="structtaint__operand__t.html#578c2946959431293fc2d85dfb4e8a89">type</a> = 0;
<a name="l00331"></a>00331         src[1].<a class="code" href="structtaint__operand__t.html#4950a2ce5b28b9e1c9fc99fe6c5c4149">size</a> = 4;
<a name="l00332"></a>00332         src[1].<a class="code" href="structtaint__operand__t.html#0b7d021002413c1ac97f5414612db18f">taint</a> = index_taint;
<a name="l00333"></a>00333         src[1].<a class="code" href="structtaint__operand__t.html#dec24928b14ad823f99afff44dfbe045">records</a> = <a class="code" href="taintcheck_8c.html#ba165d9e6ff6e82b3c63a9be1f6c97cc" title="taint records for registers">regs_records</a> + <a class="code" href="TEMU__main_8c.html#a93b5270782d60adbbe1e95b3f87befd">temu_plugin</a>-&gt;<a class="code" href="structplugin__interface__t.html#cf6b2847bc302d9e0c94ca21fd81a75d" title="size of taint record for each tainted byte. TEMU sees taint record as untyped buffer...">taint_record_size</a> * R_A0 * 4;
<a name="l00334"></a>00334         src[1].<a class="code" href="structtaint__operand__t.html#9b9f04ae0f4017c6231a5b21244d4646">addr</a> = R_A0 * 4;
<a name="l00335"></a>00335       }
<a name="l00336"></a>00336       <a class="code" href="TEMU__main_8c.html#a93b5270782d60adbbe1e95b3f87befd">temu_plugin</a>-&gt;<a class="code" href="structplugin__interface__t.html#9d9c6f38a85ffe4738755a465115c94f" title="This callback customizes its own policy for taint propagation.">taint_propagate</a>(index_taint? 2:1, src, &amp;dst, PROP_MODE_MOVE);
<a name="l00337"></a>00337     } <span class="keywordflow">else</span> 
<a name="l00338"></a>00338      <a class="code" href="taintcheck_8c.html#974495ac1261e65922b3590a970613a6">clean_register</a>(regidx, size);
<a name="l00339"></a>00339   } 
<a name="l00340"></a>00340   <span class="keywordflow">else</span> {
<a name="l00341"></a>00341     <span class="keywordtype">int</span> size1 = 64 - offset;
<a name="l00342"></a>00342     <span class="keywordtype">int</span> size2 = size - size1;
<a name="l00343"></a>00343     <a class="code" href="structtaint__operand__t.html">taint_operand_t</a> src[2], dst;
<a name="l00344"></a>00344     <span class="keywordflow">if</span>(index_taint) {
<a name="l00345"></a>00345       src[1].<a class="code" href="structtaint__operand__t.html#578c2946959431293fc2d85dfb4e8a89">type</a> = 0;
<a name="l00346"></a>00346       src[1].<a class="code" href="structtaint__operand__t.html#4950a2ce5b28b9e1c9fc99fe6c5c4149">size</a> = 4;
<a name="l00347"></a>00347       src[1].<a class="code" href="structtaint__operand__t.html#0b7d021002413c1ac97f5414612db18f">taint</a> = index_taint;
<a name="l00348"></a>00348       src[1].<a class="code" href="structtaint__operand__t.html#dec24928b14ad823f99afff44dfbe045">records</a> = <a class="code" href="taintcheck_8c.html#ba165d9e6ff6e82b3c63a9be1f6c97cc" title="taint records for registers">regs_records</a> + <a class="code" href="TEMU__main_8c.html#a93b5270782d60adbbe1e95b3f87befd">temu_plugin</a>-&gt;<a class="code" href="structplugin__interface__t.html#cf6b2847bc302d9e0c94ca21fd81a75d" title="size of taint record for each tainted byte. TEMU sees taint record as untyped buffer...">taint_record_size</a> * R_A0 * 4;
<a name="l00349"></a>00349       src[1].<a class="code" href="structtaint__operand__t.html#9b9f04ae0f4017c6231a5b21244d4646">addr</a> = R_A0 * 4;
<a name="l00350"></a>00350     }
<a name="l00351"></a>00351 
<a name="l00352"></a>00352     taint1 = <a class="code" href="taintcheck_8c.html#7a240b504a8e7bf8935b5b091ea293c9" title="fast version memory taint check, without boundary check">fast_taint_mem_check</a>(addr, size1);
<a name="l00353"></a>00353     taint = index_taint? (1&lt;&lt;size1)-1 : taint1;
<a name="l00354"></a>00354     <span class="keywordflow">if</span> (taint) {
<a name="l00355"></a>00355       <a class="code" href="taintcheck_8c.html#8ba4dce789e7fe78985beb63f5f0f01a" title="flag that indicates if the current instruction propagates taint">insn_tainted</a> = 1;
<a name="l00356"></a>00356       <a class="code" href="taintcheck_8c.html#5297c0dd74a0ea8ab628243ab6d6b060">taint_register</a>(regidx, size1, taint);
<a name="l00357"></a>00357       src[0].<a class="code" href="structtaint__operand__t.html#578c2946959431293fc2d85dfb4e8a89">type</a> = 1; <span class="comment">//memory</span>
<a name="l00358"></a>00358       dst.<a class="code" href="structtaint__operand__t.html#578c2946959431293fc2d85dfb4e8a89">type</a> = 0;                 <span class="comment">//register</span>
<a name="l00359"></a>00359       src[0].<a class="code" href="structtaint__operand__t.html#4950a2ce5b28b9e1c9fc99fe6c5c4149">size</a> = dst.<a class="code" href="structtaint__operand__t.html#4950a2ce5b28b9e1c9fc99fe6c5c4149">size</a> = size1;
<a name="l00360"></a>00360       src[0].<a class="code" href="structtaint__operand__t.html#0b7d021002413c1ac97f5414612db18f">taint</a> = taint1;
<a name="l00361"></a>00361 
<a name="l00362"></a>00362       dst.<a class="code" href="structtaint__operand__t.html#0b7d021002413c1ac97f5414612db18f">taint</a> = taint;
<a name="l00363"></a>00363       src[0].<a class="code" href="structtaint__operand__t.html#9b9f04ae0f4017c6231a5b21244d4646">addr</a> = addr, dst.<a class="code" href="structtaint__operand__t.html#9b9f04ae0f4017c6231a5b21244d4646">addr</a> = regidx;
<a name="l00364"></a>00364       src[0].<a class="code" href="structtaint__operand__t.html#dec24928b14ad823f99afff44dfbe045">records</a> = tpage_table[addr&gt;&gt;6]-&gt;<a class="code" href="struct__tpage__entry.html#5dca50c79db35c0fc6c510c7f6f3db2c">records</a> + 
<a name="l00365"></a>00365         offset*<a class="code" href="TEMU__main_8c.html#a93b5270782d60adbbe1e95b3f87befd">temu_plugin</a>-&gt;<a class="code" href="structplugin__interface__t.html#cf6b2847bc302d9e0c94ca21fd81a75d" title="size of taint record for each tainted byte. TEMU sees taint record as untyped buffer...">taint_record_size</a>;
<a name="l00366"></a>00366       dst.<a class="code" href="structtaint__operand__t.html#dec24928b14ad823f99afff44dfbe045">records</a> = <a class="code" href="taintcheck_8c.html#ba165d9e6ff6e82b3c63a9be1f6c97cc" title="taint records for registers">regs_records</a> + <a class="code" href="TEMU__main_8c.html#a93b5270782d60adbbe1e95b3f87befd">temu_plugin</a>-&gt;<a class="code" href="structplugin__interface__t.html#cf6b2847bc302d9e0c94ca21fd81a75d" title="size of taint record for each tainted byte. TEMU sees taint record as untyped buffer...">taint_record_size</a>*regidx;
<a name="l00367"></a>00367       <a class="code" href="TEMU__main_8c.html#a93b5270782d60adbbe1e95b3f87befd">temu_plugin</a>-&gt;<a class="code" href="structplugin__interface__t.html#9d9c6f38a85ffe4738755a465115c94f" title="This callback customizes its own policy for taint propagation.">taint_propagate</a>(index_taint? 2:1, src, &amp;dst, PROP_MODE_MOVE);
<a name="l00368"></a>00368     } <span class="keywordflow">else</span> 
<a name="l00369"></a>00369      <a class="code" href="taintcheck_8c.html#974495ac1261e65922b3590a970613a6">clean_register</a>(regidx, size1);
<a name="l00370"></a>00370 
<a name="l00371"></a>00371     taint1 = <a class="code" href="taintcheck_8c.html#7a240b504a8e7bf8935b5b091ea293c9" title="fast version memory taint check, without boundary check">fast_taint_mem_check</a>(addr+size1, size2);
<a name="l00372"></a>00372     taint = index_taint? (1&lt;&lt;size2)-1 : taint1;
<a name="l00373"></a>00373     <span class="keywordflow">if</span> (taint) {
<a name="l00374"></a>00374       <a class="code" href="taintcheck_8c.html#8ba4dce789e7fe78985beb63f5f0f01a" title="flag that indicates if the current instruction propagates taint">insn_tainted</a> = 1;
<a name="l00375"></a>00375       <a class="code" href="taintcheck_8c.html#5297c0dd74a0ea8ab628243ab6d6b060">taint_register</a>(regidx+size1, size2, taint);
<a name="l00376"></a>00376       src[0].<a class="code" href="structtaint__operand__t.html#578c2946959431293fc2d85dfb4e8a89">type</a> = 1; <span class="comment">//memory</span>
<a name="l00377"></a>00377       dst.<a class="code" href="structtaint__operand__t.html#578c2946959431293fc2d85dfb4e8a89">type</a> = 0;                 <span class="comment">//register</span>
<a name="l00378"></a>00378       src[0].<a class="code" href="structtaint__operand__t.html#4950a2ce5b28b9e1c9fc99fe6c5c4149">size</a> = dst.<a class="code" href="structtaint__operand__t.html#4950a2ce5b28b9e1c9fc99fe6c5c4149">size</a> = size2;
<a name="l00379"></a>00379       src[0].<a class="code" href="structtaint__operand__t.html#0b7d021002413c1ac97f5414612db18f">taint</a> = taint1;
<a name="l00380"></a>00380 
<a name="l00381"></a>00381       dst.<a class="code" href="structtaint__operand__t.html#0b7d021002413c1ac97f5414612db18f">taint</a> = taint;
<a name="l00382"></a>00382       src[0].<a class="code" href="structtaint__operand__t.html#9b9f04ae0f4017c6231a5b21244d4646">addr</a> = addr+size1, dst.<a class="code" href="structtaint__operand__t.html#9b9f04ae0f4017c6231a5b21244d4646">addr</a> = regidx+size1;
<a name="l00383"></a>00383       src[0].<a class="code" href="structtaint__operand__t.html#dec24928b14ad823f99afff44dfbe045">records</a> = tpage_table[(addr&gt;&gt;6)+1]-&gt;records;
<a name="l00384"></a>00384       dst.<a class="code" href="structtaint__operand__t.html#dec24928b14ad823f99afff44dfbe045">records</a> = <a class="code" href="taintcheck_8c.html#ba165d9e6ff6e82b3c63a9be1f6c97cc" title="taint records for registers">regs_records</a> + <a class="code" href="TEMU__main_8c.html#a93b5270782d60adbbe1e95b3f87befd">temu_plugin</a>-&gt;<a class="code" href="structplugin__interface__t.html#cf6b2847bc302d9e0c94ca21fd81a75d" title="size of taint record for each tainted byte. TEMU sees taint record as untyped buffer...">taint_record_size</a>*(regidx+size1);
<a name="l00385"></a>00385       <a class="code" href="TEMU__main_8c.html#a93b5270782d60adbbe1e95b3f87befd">temu_plugin</a>-&gt;<a class="code" href="structplugin__interface__t.html#9d9c6f38a85ffe4738755a465115c94f" title="This callback customizes its own policy for taint propagation.">taint_propagate</a>(index_taint? 2:1, src, &amp;dst, PROP_MODE_MOVE);
<a name="l00386"></a>00386     } <span class="keywordflow">else</span> 
<a name="l00387"></a>00387      <a class="code" href="taintcheck_8c.html#974495ac1261e65922b3590a970613a6">clean_register</a>(regidx+size1, size2);
<a name="l00388"></a>00388   }
<a name="l00389"></a>00389 
<a name="l00390"></a>00390 <span class="preprocessor">#endif //NO_PROPAGATE</span>
<a name="l00391"></a>00391 <span class="preprocessor"></span>
<a name="l00392"></a>00392 <span class="preprocessor">#ifdef REG_CHECK</span>
<a name="l00393"></a>00393 <span class="preprocessor"></span>  <a class="code" href="TEMU__main_8c.html#a93b5270782d60adbbe1e95b3f87befd">temu_plugin</a>-&gt;<a class="code" href="structplugin__interface__t.html#80ee4e68586dbf9579df2f774001b01b" title="This callback is invoked when the current instruction writes a register.">reg_write</a>(regidx, size);
<a name="l00394"></a>00394 <span class="preprocessor">#endif</span>
<a name="l00395"></a>00395 <span class="preprocessor"></span>
<a name="l00396"></a>00396 }
<a name="l00397"></a>00397 
<a name="l00398"></a>00398 
<a name="l00399"></a>00399 <span class="keywordtype">void</span> <a class="code" href="taintcheck_8c.html#f975ece5cd68bb4f43b74c2161070975" title="Propagate taint info from register to memory.">__attribute__</a>((fastcall)) taintcheck_mem2reg_nolookup(uint32_t paddr, uint32_t vaddr, <span class="keywordtype">int</span> size, <span class="keywordtype">int</span> regidx)
<a name="l00400"></a>00400 {
<a name="l00401"></a>00401   <span class="keywordflow">if</span>(!<a class="code" href="group__main.html#gf24f155e5a9b6ee9bc9a6e6ef9c3987d" title="This flag tells if emulation mode is enabled.">TEMU_emulation_started</a>) <span class="keywordflow">return</span>;
<a name="l00402"></a>00402   <span class="keywordflow">if</span>(__builtin_expect(paddr &gt;= ram_size, 0)) <span class="keywordflow">return</span>;
<a name="l00403"></a>00403 
<a name="l00404"></a>00404 <span class="preprocessor">#ifdef MEM_CHECK</span>
<a name="l00405"></a>00405 <span class="preprocessor"></span>  <a class="code" href="TEMU__main_8c.html#a93b5270782d60adbbe1e95b3f87befd">temu_plugin</a>-&gt;<a class="code" href="structplugin__interface__t.html#2ee53fc1918838c58f2c574562b24e40" title="This callback is invoked when the current instruction reads a memory region.">mem_read</a>(vaddr, paddr, size);
<a name="l00406"></a>00406 <span class="preprocessor">#endif</span>
<a name="l00407"></a>00407 <span class="preprocessor"></span>
<a name="l00408"></a>00408 <span class="preprocessor">#ifndef NO_PROPAGATE</span>
<a name="l00409"></a>00409 <span class="preprocessor"></span>  uint8_t taint = 0;
<a name="l00410"></a>00410   uint32_t offset = paddr &amp; 63;
<a name="l00411"></a>00411   
<a name="l00412"></a>00412   <span class="keywordflow">if</span> (offset + size &lt;= 64) {
<a name="l00413"></a>00413     taint = <a class="code" href="taintcheck_8c.html#7ded7aac43f68faa84aaf843c2986afa">taint_mem_check</a>(paddr, size);
<a name="l00414"></a>00414     <span class="keywordflow">if</span> (taint) {
<a name="l00415"></a>00415       <a class="code" href="taintcheck_8c.html#8ba4dce789e7fe78985beb63f5f0f01a" title="flag that indicates if the current instruction propagates taint">insn_tainted</a> = 1;
<a name="l00416"></a>00416       <a class="code" href="taintcheck_8c.html#5297c0dd74a0ea8ab628243ab6d6b060">taint_register</a>(regidx, size, taint);
<a name="l00417"></a>00417       <a class="code" href="structtaint__operand__t.html">taint_operand_t</a> src, dst;
<a name="l00418"></a>00418       src.<a class="code" href="structtaint__operand__t.html#578c2946959431293fc2d85dfb4e8a89">type</a> = 1;              <span class="comment">//memory</span>
<a name="l00419"></a>00419       dst.<a class="code" href="structtaint__operand__t.html#578c2946959431293fc2d85dfb4e8a89">type</a> = 0;              <span class="comment">//register</span>
<a name="l00420"></a>00420       src.<a class="code" href="structtaint__operand__t.html#4950a2ce5b28b9e1c9fc99fe6c5c4149">size</a> = dst.<a class="code" href="structtaint__operand__t.html#4950a2ce5b28b9e1c9fc99fe6c5c4149">size</a> = size;
<a name="l00421"></a>00421       src.<a class="code" href="structtaint__operand__t.html#0b7d021002413c1ac97f5414612db18f">taint</a> = dst.<a class="code" href="structtaint__operand__t.html#0b7d021002413c1ac97f5414612db18f">taint</a> = taint;
<a name="l00422"></a>00422       src.<a class="code" href="structtaint__operand__t.html#9b9f04ae0f4017c6231a5b21244d4646">addr</a> = paddr, dst.<a class="code" href="structtaint__operand__t.html#9b9f04ae0f4017c6231a5b21244d4646">addr</a> = regidx;
<a name="l00423"></a>00423       src.<a class="code" href="structtaint__operand__t.html#dec24928b14ad823f99afff44dfbe045">records</a> = tpage_table[paddr &gt;&gt; 6]-&gt;<a class="code" href="struct__tpage__entry.html#5dca50c79db35c0fc6c510c7f6f3db2c">records</a> +
<a name="l00424"></a>00424             offset * <a class="code" href="TEMU__main_8c.html#a93b5270782d60adbbe1e95b3f87befd">temu_plugin</a>-&gt;<a class="code" href="structplugin__interface__t.html#cf6b2847bc302d9e0c94ca21fd81a75d" title="size of taint record for each tainted byte. TEMU sees taint record as untyped buffer...">taint_record_size</a>;
<a name="l00425"></a>00425       dst.<a class="code" href="structtaint__operand__t.html#dec24928b14ad823f99afff44dfbe045">records</a> = <a class="code" href="taintcheck_8c.html#ba165d9e6ff6e82b3c63a9be1f6c97cc" title="taint records for registers">regs_records</a> + <a class="code" href="TEMU__main_8c.html#a93b5270782d60adbbe1e95b3f87befd">temu_plugin</a>-&gt;<a class="code" href="structplugin__interface__t.html#cf6b2847bc302d9e0c94ca21fd81a75d" title="size of taint record for each tainted byte. TEMU sees taint record as untyped buffer...">taint_record_size</a> * regidx;
<a name="l00426"></a>00426       <a class="code" href="TEMU__main_8c.html#a93b5270782d60adbbe1e95b3f87befd">temu_plugin</a>-&gt;<a class="code" href="structplugin__interface__t.html#9d9c6f38a85ffe4738755a465115c94f" title="This callback customizes its own policy for taint propagation.">taint_propagate</a>(1, &amp;src, &amp;dst, PROP_MODE_MOVE);
<a name="l00427"></a>00427     } <span class="keywordflow">else</span>     
<a name="l00428"></a>00428       <a class="code" href="taintcheck_8c.html#974495ac1261e65922b3590a970613a6">clean_register</a>(regidx, size);
<a name="l00429"></a>00429   } 
<a name="l00430"></a>00430   <span class="keywordflow">else</span> {
<a name="l00431"></a>00431     <span class="keywordtype">int</span> size1 = 64 - offset;
<a name="l00432"></a>00432     <span class="keywordtype">int</span> size2 = size - size1;
<a name="l00433"></a>00433     taint = <a class="code" href="taintcheck_8c.html#7ded7aac43f68faa84aaf843c2986afa">taint_mem_check</a>(paddr, size1);
<a name="l00434"></a>00434     <span class="keywordflow">if</span> (taint) {
<a name="l00435"></a>00435       <a class="code" href="taintcheck_8c.html#8ba4dce789e7fe78985beb63f5f0f01a" title="flag that indicates if the current instruction propagates taint">insn_tainted</a> = 1;
<a name="l00436"></a>00436       <a class="code" href="taintcheck_8c.html#5297c0dd74a0ea8ab628243ab6d6b060">taint_register</a>(regidx, size1, taint);
<a name="l00437"></a>00437       <a class="code" href="structtaint__operand__t.html">taint_operand_t</a> src, dst;
<a name="l00438"></a>00438       src.<a class="code" href="structtaint__operand__t.html#578c2946959431293fc2d85dfb4e8a89">type</a> = 1;              <span class="comment">//memory</span>
<a name="l00439"></a>00439       dst.<a class="code" href="structtaint__operand__t.html#578c2946959431293fc2d85dfb4e8a89">type</a> = 0;                 <span class="comment">//register</span>
<a name="l00440"></a>00440       src.<a class="code" href="structtaint__operand__t.html#4950a2ce5b28b9e1c9fc99fe6c5c4149">size</a> = dst.<a class="code" href="structtaint__operand__t.html#4950a2ce5b28b9e1c9fc99fe6c5c4149">size</a> = size1;
<a name="l00441"></a>00441       src.<a class="code" href="structtaint__operand__t.html#0b7d021002413c1ac97f5414612db18f">taint</a> = dst.<a class="code" href="structtaint__operand__t.html#0b7d021002413c1ac97f5414612db18f">taint</a> = taint;
<a name="l00442"></a>00442       src.<a class="code" href="structtaint__operand__t.html#9b9f04ae0f4017c6231a5b21244d4646">addr</a> = paddr, dst.<a class="code" href="structtaint__operand__t.html#9b9f04ae0f4017c6231a5b21244d4646">addr</a> = regidx;
<a name="l00443"></a>00443       src.<a class="code" href="structtaint__operand__t.html#dec24928b14ad823f99afff44dfbe045">records</a> = tpage_table[paddr &gt;&gt; 6]-&gt;<a class="code" href="struct__tpage__entry.html#5dca50c79db35c0fc6c510c7f6f3db2c">records</a> +
<a name="l00444"></a>00444             offset * <a class="code" href="TEMU__main_8c.html#a93b5270782d60adbbe1e95b3f87befd">temu_plugin</a>-&gt;<a class="code" href="structplugin__interface__t.html#cf6b2847bc302d9e0c94ca21fd81a75d" title="size of taint record for each tainted byte. TEMU sees taint record as untyped buffer...">taint_record_size</a>;
<a name="l00445"></a>00445       dst.<a class="code" href="structtaint__operand__t.html#dec24928b14ad823f99afff44dfbe045">records</a> = <a class="code" href="taintcheck_8c.html#ba165d9e6ff6e82b3c63a9be1f6c97cc" title="taint records for registers">regs_records</a> + <a class="code" href="TEMU__main_8c.html#a93b5270782d60adbbe1e95b3f87befd">temu_plugin</a>-&gt;<a class="code" href="structplugin__interface__t.html#cf6b2847bc302d9e0c94ca21fd81a75d" title="size of taint record for each tainted byte. TEMU sees taint record as untyped buffer...">taint_record_size</a> * regidx;
<a name="l00446"></a>00446       <a class="code" href="TEMU__main_8c.html#a93b5270782d60adbbe1e95b3f87befd">temu_plugin</a>-&gt;<a class="code" href="structplugin__interface__t.html#9d9c6f38a85ffe4738755a465115c94f" title="This callback customizes its own policy for taint propagation.">taint_propagate</a>(1, &amp;src, &amp;dst, PROP_MODE_MOVE);
<a name="l00447"></a>00447     } <span class="keywordflow">else</span>     
<a name="l00448"></a>00448       <a class="code" href="taintcheck_8c.html#974495ac1261e65922b3590a970613a6">clean_register</a>(regidx, size1);
<a name="l00449"></a>00449 
<a name="l00450"></a>00450     taint = <a class="code" href="taintcheck_8c.html#7ded7aac43f68faa84aaf843c2986afa">taint_mem_check</a>(paddr+size1, size2);
<a name="l00451"></a>00451     <span class="keywordflow">if</span> (taint) {
<a name="l00452"></a>00452       <a class="code" href="taintcheck_8c.html#8ba4dce789e7fe78985beb63f5f0f01a" title="flag that indicates if the current instruction propagates taint">insn_tainted</a> = 1;
<a name="l00453"></a>00453       <a class="code" href="taintcheck_8c.html#5297c0dd74a0ea8ab628243ab6d6b060">taint_register</a>(regidx+size1, size2, taint);
<a name="l00454"></a>00454       <a class="code" href="structtaint__operand__t.html">taint_operand_t</a> src, dst;
<a name="l00455"></a>00455       src.<a class="code" href="structtaint__operand__t.html#578c2946959431293fc2d85dfb4e8a89">type</a> = 1;              <span class="comment">//memory</span>
<a name="l00456"></a>00456       dst.<a class="code" href="structtaint__operand__t.html#578c2946959431293fc2d85dfb4e8a89">type</a> = 0;                 <span class="comment">//register</span>
<a name="l00457"></a>00457       src.<a class="code" href="structtaint__operand__t.html#4950a2ce5b28b9e1c9fc99fe6c5c4149">size</a> = dst.<a class="code" href="structtaint__operand__t.html#4950a2ce5b28b9e1c9fc99fe6c5c4149">size</a> = size2;
<a name="l00458"></a>00458       src.<a class="code" href="structtaint__operand__t.html#0b7d021002413c1ac97f5414612db18f">taint</a> = dst.<a class="code" href="structtaint__operand__t.html#0b7d021002413c1ac97f5414612db18f">taint</a> = taint;
<a name="l00459"></a>00459       src.<a class="code" href="structtaint__operand__t.html#9b9f04ae0f4017c6231a5b21244d4646">addr</a> = paddr+size1, dst.<a class="code" href="structtaint__operand__t.html#9b9f04ae0f4017c6231a5b21244d4646">addr</a> = regidx+size1;
<a name="l00460"></a>00460       src.<a class="code" href="structtaint__operand__t.html#dec24928b14ad823f99afff44dfbe045">records</a> = tpage_table[(paddr&gt;&gt;6) + 1]-&gt;records;
<a name="l00461"></a>00461       dst.<a class="code" href="structtaint__operand__t.html#dec24928b14ad823f99afff44dfbe045">records</a> = <a class="code" href="taintcheck_8c.html#ba165d9e6ff6e82b3c63a9be1f6c97cc" title="taint records for registers">regs_records</a> + <a class="code" href="TEMU__main_8c.html#a93b5270782d60adbbe1e95b3f87befd">temu_plugin</a>-&gt;<a class="code" href="structplugin__interface__t.html#cf6b2847bc302d9e0c94ca21fd81a75d" title="size of taint record for each tainted byte. TEMU sees taint record as untyped buffer...">taint_record_size</a> * (regidx+size1);
<a name="l00462"></a>00462       <a class="code" href="TEMU__main_8c.html#a93b5270782d60adbbe1e95b3f87befd">temu_plugin</a>-&gt;<a class="code" href="structplugin__interface__t.html#9d9c6f38a85ffe4738755a465115c94f" title="This callback customizes its own policy for taint propagation.">taint_propagate</a>(1, &amp;src, &amp;dst, PROP_MODE_MOVE);
<a name="l00463"></a>00463     } <span class="keywordflow">else</span>     
<a name="l00464"></a>00464       <a class="code" href="taintcheck_8c.html#974495ac1261e65922b3590a970613a6">clean_register</a>(regidx+size1, size2);
<a name="l00465"></a>00465   }
<a name="l00466"></a>00466 <span class="preprocessor">#endif //NO_PROPAGATE</span>
<a name="l00467"></a>00467 <span class="preprocessor"></span>
<a name="l00468"></a>00468 <span class="preprocessor">#ifdef REG_CHECK</span>
<a name="l00469"></a>00469 <span class="preprocessor"></span>  <a class="code" href="TEMU__main_8c.html#a93b5270782d60adbbe1e95b3f87befd">temu_plugin</a>-&gt;<a class="code" href="structplugin__interface__t.html#80ee4e68586dbf9579df2f774001b01b" title="This callback is invoked when the current instruction writes a register.">reg_write</a>(regidx, size);
<a name="l00470"></a>00470 <span class="preprocessor">#endif</span>
<a name="l00471"></a>00471 <span class="preprocessor"></span>
<a name="l00472"></a>00472 }
<a name="l00473"></a>00473 
<a name="l00474"></a>00474 
<a name="l00475"></a><a class="code" href="taintcheck_8c.html#2a22fb27cb7b9a245da96fa2cedc3e11">00475</a> <span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">void</span> <a class="code" href="taintcheck_8c.html#2a22fb27cb7b9a245da96fa2cedc3e11">reg2reg_internal</a>(<span class="keywordtype">int</span> sregidx, <span class="keywordtype">int</span> dregidx, 
<a name="l00476"></a>00476   <span class="keywordtype">int</span> size)
<a name="l00477"></a>00477 {
<a name="l00478"></a>00478   uint8_t taint;
<a name="l00479"></a>00479 
<a name="l00480"></a>00480   <span class="keywordflow">if</span>(<a class="code" href="taintcheck_8c.html#5efcc8557acedd802898b6be6e743c77" title="bitmap for registers">regs_bitmap</a> == 0)
<a name="l00481"></a>00481   <span class="keywordflow">return</span>;
<a name="l00482"></a>00482 
<a name="l00483"></a>00483   taint = <a class="code" href="taintcheck_8c.html#76e98a9a904319586334f594defa87ed">taint_reg_check</a>(sregidx, size);
<a name="l00484"></a>00484 <span class="preprocessor">#ifdef TAINTCHECK_CLEAR_ZERO</span>
<a name="l00485"></a>00485 <span class="preprocessor"></span>  <span class="keywordflow">if</span> (__builtin_expect(taint, 0))
<a name="l00486"></a>00486     taint = <a class="code" href="taintcheck_8c.html#e0354bf288bcec353063475b7a89bbf0">clear_zero</a>(cpu_single_env-&gt;regs[sregidx &gt;&gt; 2] &gt;&gt; (sregidx &amp; 3),
<a name="l00487"></a>00487                        size, taint);
<a name="l00488"></a>00488 <span class="preprocessor">#endif</span>
<a name="l00489"></a>00489 <span class="preprocessor"></span>  <span class="keywordflow">if</span>(!taint) {
<a name="l00490"></a>00490   <a class="code" href="taintcheck_8c.html#974495ac1261e65922b3590a970613a6">clean_register</a>(dregidx, size);
<a name="l00491"></a>00491   <span class="keywordflow">return</span>;
<a name="l00492"></a>00492   }
<a name="l00493"></a>00493 
<a name="l00494"></a>00494   <a class="code" href="taintcheck_8c.html#5297c0dd74a0ea8ab628243ab6d6b060">taint_register</a>(dregidx, size, taint);
<a name="l00495"></a>00495   <a class="code" href="taintcheck_8c.html#8ba4dce789e7fe78985beb63f5f0f01a" title="flag that indicates if the current instruction propagates taint">insn_tainted</a> = 1;
<a name="l00496"></a>00496   <a class="code" href="structtaint__operand__t.html">taint_operand_t</a> src, dst;
<a name="l00497"></a>00497   src.<a class="code" href="structtaint__operand__t.html#578c2946959431293fc2d85dfb4e8a89">type</a> = dst.<a class="code" href="structtaint__operand__t.html#578c2946959431293fc2d85dfb4e8a89">type</a> = 0;
<a name="l00498"></a>00498   src.<a class="code" href="structtaint__operand__t.html#4950a2ce5b28b9e1c9fc99fe6c5c4149">size</a> = dst.<a class="code" href="structtaint__operand__t.html#4950a2ce5b28b9e1c9fc99fe6c5c4149">size</a> = size;
<a name="l00499"></a>00499   src.<a class="code" href="structtaint__operand__t.html#0b7d021002413c1ac97f5414612db18f">taint</a> = dst.<a class="code" href="structtaint__operand__t.html#0b7d021002413c1ac97f5414612db18f">taint</a> = taint;
<a name="l00500"></a>00500   src.<a class="code" href="structtaint__operand__t.html#9b9f04ae0f4017c6231a5b21244d4646">addr</a> = sregidx, dst.<a class="code" href="structtaint__operand__t.html#9b9f04ae0f4017c6231a5b21244d4646">addr</a> = dregidx;
<a name="l00501"></a>00501   src.<a class="code" href="structtaint__operand__t.html#dec24928b14ad823f99afff44dfbe045">records</a> =
<a name="l00502"></a>00502       <a class="code" href="taintcheck_8c.html#ba165d9e6ff6e82b3c63a9be1f6c97cc" title="taint records for registers">regs_records</a> + sregidx * <a class="code" href="TEMU__main_8c.html#a93b5270782d60adbbe1e95b3f87befd">temu_plugin</a>-&gt;<a class="code" href="structplugin__interface__t.html#cf6b2847bc302d9e0c94ca21fd81a75d" title="size of taint record for each tainted byte. TEMU sees taint record as untyped buffer...">taint_record_size</a>;
<a name="l00503"></a>00503   dst.<a class="code" href="structtaint__operand__t.html#dec24928b14ad823f99afff44dfbe045">records</a> =
<a name="l00504"></a>00504       <a class="code" href="taintcheck_8c.html#ba165d9e6ff6e82b3c63a9be1f6c97cc" title="taint records for registers">regs_records</a> + dregidx * <a class="code" href="TEMU__main_8c.html#a93b5270782d60adbbe1e95b3f87befd">temu_plugin</a>-&gt;<a class="code" href="structplugin__interface__t.html#cf6b2847bc302d9e0c94ca21fd81a75d" title="size of taint record for each tainted byte. TEMU sees taint record as untyped buffer...">taint_record_size</a>;
<a name="l00505"></a>00505   <a class="code" href="TEMU__main_8c.html#a93b5270782d60adbbe1e95b3f87befd">temu_plugin</a>-&gt;<a class="code" href="structplugin__interface__t.html#9d9c6f38a85ffe4738755a465115c94f" title="This callback customizes its own policy for taint propagation.">taint_propagate</a>(1, &amp;src, &amp;dst, PROP_MODE_MOVE);
<a name="l00506"></a>00506 }
<a name="l00507"></a>00507 
<a name="l00508"></a>00508 
<a name="l00509"></a>00509 <span class="keywordtype">void</span> <a class="code" href="taintcheck_8c.html#f975ece5cd68bb4f43b74c2161070975" title="Propagate taint info from register to memory.">__attribute__</a>((fastcall)) <a class="code" href="taintcheck_8h.html#4120a768d0dbb8afcf2fddb01f4e9ff1">taintcheck_reg2reg</a>(<span class="keywordtype">int</span> sreg, <span class="keywordtype">int</span> <a class="code" href="taintcheck_8h.html#94b2b352b08d650c49bcb263a0cbb7a4">dreg</a>, <span class="keywordtype">int</span> size)
<a name="l00510"></a>00510 {
<a name="l00511"></a>00511   <span class="keywordflow">if</span>(!<a class="code" href="group__main.html#gf24f155e5a9b6ee9bc9a6e6ef9c3987d" title="This flag tells if emulation mode is enabled.">TEMU_emulation_started</a>) <span class="keywordflow">return</span>;
<a name="l00512"></a>00512 <span class="preprocessor">#ifdef REG_CHECK</span>
<a name="l00513"></a>00513 <span class="preprocessor"></span>  <a class="code" href="TEMU__main_8c.html#a93b5270782d60adbbe1e95b3f87befd">temu_plugin</a>-&gt;<a class="code" href="structplugin__interface__t.html#f9db66146dd22bdad23b09bf2f013a6d" title="This callback is invoked when the current instruction reads a register.">reg_read</a>(sreg&lt;&lt;2, size);
<a name="l00514"></a>00514 <span class="preprocessor">#endif</span>
<a name="l00515"></a>00515 <span class="preprocessor"></span>
<a name="l00516"></a>00516 <span class="preprocessor">#ifndef NO_PROPAGATE</span>
<a name="l00517"></a>00517 <span class="preprocessor"></span>  <a class="code" href="taintcheck_8c.html#2a22fb27cb7b9a245da96fa2cedc3e11">reg2reg_internal</a>(sreg&lt;&lt;2, dreg&lt;&lt;2, size);
<a name="l00518"></a>00518 <span class="preprocessor">#endif  </span>
<a name="l00519"></a>00519 <span class="preprocessor"></span>
<a name="l00520"></a>00520 <span class="preprocessor">#ifdef REG_CHECK</span>
<a name="l00521"></a>00521 <span class="preprocessor"></span>  <a class="code" href="TEMU__main_8c.html#a93b5270782d60adbbe1e95b3f87befd">temu_plugin</a>-&gt;<a class="code" href="structplugin__interface__t.html#80ee4e68586dbf9579df2f774001b01b" title="This callback is invoked when the current instruction writes a register.">reg_write</a>(dreg&lt;&lt;2, size);
<a name="l00522"></a>00522 <span class="preprocessor">#endif</span>
<a name="l00523"></a>00523 <span class="preprocessor"></span>}
<a name="l00524"></a>00524 
<a name="l00525"></a>00525 
<a name="l00526"></a>00526 <span class="keywordtype">void</span> <a class="code" href="taintcheck_8c.html#f975ece5cd68bb4f43b74c2161070975" title="Propagate taint info from register to memory.">__attribute__</a>((fastcall)) <a class="code" href="taintcheck_8h.html#41a4825f78d427d602a03ac29a0bf03f">taintcheck_reg2reg_shift</a>(<span class="keywordtype">int</span> sregidx, <span class="keywordtype">int</span> dregidx, <span class="keywordtype">int</span> size)
<a name="l00527"></a>00527 {
<a name="l00528"></a>00528   <span class="keywordflow">if</span>(!<a class="code" href="group__main.html#gf24f155e5a9b6ee9bc9a6e6ef9c3987d" title="This flag tells if emulation mode is enabled.">TEMU_emulation_started</a>) <span class="keywordflow">return</span>;
<a name="l00529"></a>00529 
<a name="l00530"></a>00530 <span class="preprocessor">#ifdef REG_CHECK</span>
<a name="l00531"></a>00531 <span class="preprocessor"></span>   <a class="code" href="TEMU__main_8c.html#a93b5270782d60adbbe1e95b3f87befd">temu_plugin</a>-&gt;<a class="code" href="structplugin__interface__t.html#f9db66146dd22bdad23b09bf2f013a6d" title="This callback is invoked when the current instruction reads a register.">reg_read</a>(sregidx, size);
<a name="l00532"></a>00532 <span class="preprocessor">#endif</span>
<a name="l00533"></a>00533 <span class="preprocessor"></span>
<a name="l00534"></a>00534 <span class="preprocessor">#ifndef NO_PROPAGATE</span>
<a name="l00535"></a>00535 <span class="preprocessor"></span>  <a class="code" href="taintcheck_8c.html#2a22fb27cb7b9a245da96fa2cedc3e11">reg2reg_internal</a>(sregidx, dregidx, size);
<a name="l00536"></a>00536 <span class="preprocessor">#endif  </span>
<a name="l00537"></a>00537 <span class="preprocessor"></span>
<a name="l00538"></a>00538 <span class="preprocessor">#ifdef REG_CHECK</span>
<a name="l00539"></a>00539 <span class="preprocessor"></span>  <a class="code" href="TEMU__main_8c.html#a93b5270782d60adbbe1e95b3f87befd">temu_plugin</a>-&gt;<a class="code" href="structplugin__interface__t.html#80ee4e68586dbf9579df2f774001b01b" title="This callback is invoked when the current instruction writes a register.">reg_write</a>(dregidx, size);
<a name="l00540"></a>00540 <span class="preprocessor">#endif</span>
<a name="l00541"></a>00541 <span class="preprocessor"></span>}
<a name="l00542"></a>00542 
<a name="l00543"></a>00543 <span class="keywordtype">void</span> <a class="code" href="taintcheck_8c.html#f975ece5cd68bb4f43b74c2161070975" title="Propagate taint info from register to memory.">__attribute__</a>((fastcall)) <a class="code" href="taintcheck_8h.html#4821d812760d44483d3d4296a83268a2">taintcheck_reg_clean</a>(<span class="keywordtype">int</span> reg)
<a name="l00544"></a>00544 {
<a name="l00545"></a>00545   <span class="keywordflow">if</span>(!<a class="code" href="group__main.html#gf24f155e5a9b6ee9bc9a6e6ef9c3987d" title="This flag tells if emulation mode is enabled.">TEMU_emulation_started</a>) <span class="keywordflow">return</span>;
<a name="l00546"></a>00546 <span class="preprocessor">#ifndef NO_PROPAGATE</span>
<a name="l00547"></a>00547 <span class="preprocessor"></span>  <a class="code" href="taintcheck_8c.html#974495ac1261e65922b3590a970613a6">clean_register</a>(reg &lt;&lt; 2, 4);
<a name="l00548"></a>00548 <span class="preprocessor">#endif  </span>
<a name="l00549"></a>00549 <span class="preprocessor"></span>}
<a name="l00550"></a>00550 
<a name="l00551"></a>00551 <span class="keywordtype">void</span> <a class="code" href="taintcheck_8c.html#f975ece5cd68bb4f43b74c2161070975" title="Propagate taint info from register to memory.">__attribute__</a>((fastcall)) <a class="code" href="taintcheck_8h.html#f8fab57ec0b47bb4d800e7e133e8d1a4">taintcheck_reg_clean2</a>(<span class="keywordtype">int</span> regidx, <span class="keywordtype">int</span> size)
<a name="l00552"></a>00552 {
<a name="l00553"></a>00553   <span class="keywordflow">if</span>(!<a class="code" href="group__main.html#gf24f155e5a9b6ee9bc9a6e6ef9c3987d" title="This flag tells if emulation mode is enabled.">TEMU_emulation_started</a>) <span class="keywordflow">return</span>;
<a name="l00554"></a>00554 <span class="preprocessor">#ifndef NO_PROPAGATE</span>
<a name="l00555"></a>00555 <span class="preprocessor"></span>  <a class="code" href="taintcheck_8c.html#974495ac1261e65922b3590a970613a6">clean_register</a>(regidx, size);
<a name="l00556"></a>00556 <span class="preprocessor">#endif  </span>
<a name="l00557"></a>00557 <span class="preprocessor"></span>}
<a name="l00558"></a>00558 
<a name="l00559"></a>00559 <span class="keywordtype">void</span> <a class="code" href="taintcheck_8c.html#f975ece5cd68bb4f43b74c2161070975" title="Propagate taint info from register to memory.">__attribute__</a>((fastcall)) <a class="code" href="taintcheck_8h.html#7c2754f30df90a588e62ad40d6f27b72">taintcheck_mem_clean</a>(<span class="keywordtype">void</span> *ptr, <span class="keywordtype">int</span> size)
<a name="l00560"></a>00560 {
<a name="l00561"></a>00561   <span class="keywordflow">if</span> (!<a class="code" href="group__main.html#gf24f155e5a9b6ee9bc9a6e6ef9c3987d" title="This flag tells if emulation mode is enabled.">TEMU_emulation_started</a>) <span class="keywordflow">return</span>;
<a name="l00562"></a>00562   uint32_t addr = (uint8_t *) ptr - phys_ram_base;
<a name="l00563"></a>00563   <span class="keywordflow">if</span> (__builtin_expect(addr + size &gt;= ram_size, 0)) <span class="keywordflow">return</span>;
<a name="l00564"></a>00564 
<a name="l00565"></a>00565   uint32_t i, len;
<a name="l00566"></a>00566   <span class="keywordflow">for</span> (i = 0; i &lt; size; i += 64) {
<a name="l00567"></a>00567     len = min(64, size - i);
<a name="l00568"></a>00568     <a class="code" href="taintcheck_8c.html#741ed09f5bd96a9e703040433fecb3af">clean_memory</a>(addr + i, len);
<a name="l00569"></a>00569   }
<a name="l00570"></a>00570 }
<a name="l00571"></a>00571 
<a name="l00572"></a>00572 <span class="keywordtype">void</span> <a class="code" href="taintcheck_8c.html#f975ece5cd68bb4f43b74c2161070975" title="Propagate taint info from register to memory.">__attribute__</a>((fastcall)) <a class="code" href="taintcheck_8h.html#169d85fbf803610ea0fcb193e66f0108">taintcheck_clean_memory</a>(uint32_t phys_addr, <span class="keywordtype">int</span> size)
<a name="l00573"></a>00573 {
<a name="l00574"></a>00574   <span class="keywordflow">if</span> (!<a class="code" href="group__main.html#gf24f155e5a9b6ee9bc9a6e6ef9c3987d" title="This flag tells if emulation mode is enabled.">TEMU_emulation_started</a>) <span class="keywordflow">return</span>;
<a name="l00575"></a>00575   <span class="keywordflow">if</span> (__builtin_expect(phys_addr + size &gt;= ram_size, 0)) <span class="keywordflow">return</span>;
<a name="l00576"></a>00576 
<a name="l00577"></a>00577   uint32_t i, len;
<a name="l00578"></a>00578   <span class="keywordflow">for</span> (i = 0; i &lt; size; i += 64) {
<a name="l00579"></a>00579     len = min(64, size - i);
<a name="l00580"></a>00580     <a class="code" href="taintcheck_8c.html#741ed09f5bd96a9e703040433fecb3af">clean_memory</a>(phys_addr + i, len);
<a name="l00581"></a>00581   }
<a name="l00582"></a>00582 }
<a name="l00583"></a>00583 
<a name="l00584"></a>00584 
<a name="l00585"></a>00585 
<a name="l00586"></a>00586 <span class="keywordtype">void</span> <a class="code" href="taintcheck_8c.html#f975ece5cd68bb4f43b74c2161070975" title="Propagate taint info from register to memory.">__attribute__</a>((fastcall)) <a class="code" href="taintcheck_8h.html#2b9ea0df94914201af1b80de379e9d11">taintcheck_bswap</a>(<span class="keywordtype">int</span> reg, <span class="keywordtype">int</span> size)
<a name="l00587"></a>00587 {
<a name="l00588"></a>00588   <span class="keywordflow">if</span>(__builtin_expect(!<a class="code" href="group__main.html#gf24f155e5a9b6ee9bc9a6e6ef9c3987d" title="This flag tells if emulation mode is enabled.">TEMU_emulation_started</a>, 0)) <span class="keywordflow">return</span>;
<a name="l00589"></a>00589 
<a name="l00590"></a>00590 <span class="preprocessor">#ifndef NO_PROPAGATE</span>
<a name="l00591"></a>00591 <span class="preprocessor"></span>  uint8_t taint, taint2 = 0;
<a name="l00592"></a>00592   <span class="keywordtype">int</span> i, regidx;
<a name="l00593"></a>00593   <span class="keywordtype">char</span> *record2 = NULL;
<a name="l00594"></a>00594 
<a name="l00595"></a>00595   regidx = reg &lt;&lt; 2;
<a name="l00596"></a>00596   <span class="keywordflow">if</span> (!(taint = <a class="code" href="taintcheck_8c.html#76e98a9a904319586334f594defa87ed">taint_reg_check</a>(regidx, size)))
<a name="l00597"></a>00597     return ;
<a name="l00598"></a>00598   <span class="keywordflow">if</span> (!(record2 = qemu_mallocz(<a class="code" href="TEMU__main_8c.html#a93b5270782d60adbbe1e95b3f87befd">temu_plugin</a>-&gt;<a class="code" href="structplugin__interface__t.html#cf6b2847bc302d9e0c94ca21fd81a75d" title="size of taint record for each tainted byte. TEMU sees taint record as untyped buffer...">taint_record_size</a> * size)))
<a name="l00599"></a>00599     <span class="keywordflow">return</span>;
<a name="l00600"></a>00600 
<a name="l00601"></a>00601   <a class="code" href="taintcheck_8c.html#8ba4dce789e7fe78985beb63f5f0f01a" title="flag that indicates if the current instruction propagates taint">insn_tainted</a> = 1;
<a name="l00602"></a>00602   <span class="keywordflow">for</span> (i = 0; i &lt; size; i++) {
<a name="l00603"></a>00603     <span class="keywordflow">if</span> (taint &amp; (1 &lt;&lt; i)) {
<a name="l00604"></a>00604       taint2 |= 1 &lt;&lt; (size - i - 1);
<a name="l00605"></a>00605       memcpy(record2 + (size - i - 1) * <a class="code" href="TEMU__main_8c.html#a93b5270782d60adbbe1e95b3f87befd">temu_plugin</a>-&gt;<a class="code" href="structplugin__interface__t.html#cf6b2847bc302d9e0c94ca21fd81a75d" title="size of taint record for each tainted byte. TEMU sees taint record as untyped buffer...">taint_record_size</a>,
<a name="l00606"></a>00606              <a class="code" href="taintcheck_8c.html#ba165d9e6ff6e82b3c63a9be1f6c97cc" title="taint records for registers">regs_records</a> + (regidx + i) * <a class="code" href="TEMU__main_8c.html#a93b5270782d60adbbe1e95b3f87befd">temu_plugin</a>-&gt;<a class="code" href="structplugin__interface__t.html#cf6b2847bc302d9e0c94ca21fd81a75d" title="size of taint record for each tainted byte. TEMU sees taint record as untyped buffer...">taint_record_size</a>,
<a name="l00607"></a>00607              <a class="code" href="TEMU__main_8c.html#a93b5270782d60adbbe1e95b3f87befd">temu_plugin</a>-&gt;<a class="code" href="structplugin__interface__t.html#cf6b2847bc302d9e0c94ca21fd81a75d" title="size of taint record for each tainted byte. TEMU sees taint record as untyped buffer...">taint_record_size</a>);
<a name="l00608"></a>00608     }
<a name="l00609"></a>00609   }
<a name="l00610"></a>00610   memcpy(<a class="code" href="taintcheck_8c.html#ba165d9e6ff6e82b3c63a9be1f6c97cc" title="taint records for registers">regs_records</a> + regidx * <a class="code" href="TEMU__main_8c.html#a93b5270782d60adbbe1e95b3f87befd">temu_plugin</a>-&gt;<a class="code" href="structplugin__interface__t.html#cf6b2847bc302d9e0c94ca21fd81a75d" title="size of taint record for each tainted byte. TEMU sees taint record as untyped buffer...">taint_record_size</a>, record2,
<a name="l00611"></a>00611          size * <a class="code" href="TEMU__main_8c.html#a93b5270782d60adbbe1e95b3f87befd">temu_plugin</a>-&gt;<a class="code" href="structplugin__interface__t.html#cf6b2847bc302d9e0c94ca21fd81a75d" title="size of taint record for each tainted byte. TEMU sees taint record as untyped buffer...">taint_record_size</a>);
<a name="l00612"></a>00612 
<a name="l00613"></a>00613   <a class="code" href="taintcheck_8c.html#5297c0dd74a0ea8ab628243ab6d6b060">taint_register</a>(regidx, size, taint2);
<a name="l00614"></a>00614   <span class="comment">//may call taint_propagate here</span>
<a name="l00615"></a>00615 
<a name="l00616"></a>00616   qemu_free(record2);
<a name="l00617"></a>00617 <span class="preprocessor">#endif //NO_PROPAGATE</span>
<a name="l00618"></a>00618 <span class="preprocessor"></span>}
<a name="l00619"></a>00619 
<a name="l00620"></a>00620 <span class="keywordtype">void</span> <a class="code" href="taintcheck_8c.html#f975ece5cd68bb4f43b74c2161070975" title="Propagate taint info from register to memory.">__attribute__</a>((fastcall)) <a class="code" href="taintcheck_8h.html#1fe38009dc4136067a95a9f53d9098d4">taintcheck_fn1reg</a>(<span class="keywordtype">int</span> reg, <span class="keywordtype">int</span> size)        <span class="comment">//size&lt;=4</span>
<a name="l00621"></a>00621 {
<a name="l00622"></a>00622   <span class="keywordflow">if</span>(__builtin_expect(!<a class="code" href="group__main.html#gf24f155e5a9b6ee9bc9a6e6ef9c3987d" title="This flag tells if emulation mode is enabled.">TEMU_emulation_started</a>, 0)) <span class="keywordflow">return</span>;
<a name="l00623"></a>00623 
<a name="l00624"></a>00624 <span class="preprocessor">#ifdef REG_CHECK</span>
<a name="l00625"></a>00625 <span class="preprocessor"></span>  <a class="code" href="TEMU__main_8c.html#a93b5270782d60adbbe1e95b3f87befd">temu_plugin</a>-&gt;<a class="code" href="structplugin__interface__t.html#f9db66146dd22bdad23b09bf2f013a6d" title="This callback is invoked when the current instruction reads a register.">reg_read</a>(reg&lt;&lt;2, size);
<a name="l00626"></a>00626 <span class="preprocessor">#endif</span>
<a name="l00627"></a>00627 <span class="preprocessor"></span>
<a name="l00628"></a>00628 <span class="preprocessor">#ifndef NO_PROPAGATE</span>
<a name="l00629"></a>00629 <span class="preprocessor"></span>  uint8_t taint;
<a name="l00630"></a>00630   <span class="keywordtype">int</span> regid = reg &lt;&lt; 2;
<a name="l00631"></a>00631 
<a name="l00632"></a>00632   <span class="keywordflow">if</span> (__builtin_expect(!(taint = <a class="code" href="taintcheck_8c.html#76e98a9a904319586334f594defa87ed">taint_reg_check</a>(regid, size)), 1))
<a name="l00633"></a>00633     <span class="keywordflow">return</span>;
<a name="l00634"></a>00634 
<a name="l00635"></a>00635   <a class="code" href="taintcheck_8c.html#5297c0dd74a0ea8ab628243ab6d6b060">taint_register</a>(regid, size, (1 &lt;&lt; size) - 1);
<a name="l00636"></a>00636 
<a name="l00637"></a>00637   <a class="code" href="taintcheck_8c.html#8ba4dce789e7fe78985beb63f5f0f01a" title="flag that indicates if the current instruction propagates taint">insn_tainted</a> = 1;
<a name="l00638"></a>00638   <a class="code" href="structtaint__operand__t.html">taint_operand_t</a> oprnd;
<a name="l00639"></a>00639   oprnd.<a class="code" href="structtaint__operand__t.html#578c2946959431293fc2d85dfb4e8a89">type</a> = 0;
<a name="l00640"></a>00640   oprnd.<a class="code" href="structtaint__operand__t.html#4950a2ce5b28b9e1c9fc99fe6c5c4149">size</a> = size;
<a name="l00641"></a>00641   oprnd.<a class="code" href="structtaint__operand__t.html#0b7d021002413c1ac97f5414612db18f">taint</a> = taint;
<a name="l00642"></a>00642   oprnd.<a class="code" href="structtaint__operand__t.html#9b9f04ae0f4017c6231a5b21244d4646">addr</a> = regid;
<a name="l00643"></a>00643   oprnd.<a class="code" href="structtaint__operand__t.html#dec24928b14ad823f99afff44dfbe045">records</a> =
<a name="l00644"></a>00644       <a class="code" href="taintcheck_8c.html#ba165d9e6ff6e82b3c63a9be1f6c97cc" title="taint records for registers">regs_records</a> + <a class="code" href="TEMU__main_8c.html#a93b5270782d60adbbe1e95b3f87befd">temu_plugin</a>-&gt;<a class="code" href="structplugin__interface__t.html#cf6b2847bc302d9e0c94ca21fd81a75d" title="size of taint record for each tainted byte. TEMU sees taint record as untyped buffer...">taint_record_size</a> * regid;
<a name="l00645"></a>00645 
<a name="l00646"></a>00646   <a class="code" href="TEMU__main_8c.html#a93b5270782d60adbbe1e95b3f87befd">temu_plugin</a>-&gt;<a class="code" href="structplugin__interface__t.html#9d9c6f38a85ffe4738755a465115c94f" title="This callback customizes its own policy for taint propagation.">taint_propagate</a>(1, &amp;oprnd, &amp;oprnd, PROP_MODE_XFORM);
<a name="l00647"></a>00647 <span class="preprocessor">#endif  </span>
<a name="l00648"></a>00648 <span class="preprocessor"></span>
<a name="l00649"></a>00649 <span class="preprocessor">#ifdef REG_CHECK</span>
<a name="l00650"></a>00650 <span class="preprocessor"></span>  <a class="code" href="TEMU__main_8c.html#a93b5270782d60adbbe1e95b3f87befd">temu_plugin</a>-&gt;<a class="code" href="structplugin__interface__t.html#80ee4e68586dbf9579df2f774001b01b" title="This callback is invoked when the current instruction writes a register.">reg_write</a>(reg&lt;&lt;2, size);
<a name="l00651"></a>00651 <span class="preprocessor">#endif</span>
<a name="l00652"></a>00652 <span class="preprocessor"></span>
<a name="l00653"></a>00653 }
<a name="l00654"></a>00654 
<a name="l00655"></a>00655 <span class="keywordtype">void</span> <a class="code" href="taintcheck_8c.html#f975ece5cd68bb4f43b74c2161070975" title="Propagate taint info from register to memory.">__attribute__</a>((fastcall)) 
<a name="l00656"></a>00656 <a class="code" href="taintcheck_8h.html#0b668d7779aba29ec1ddfc194618d519">taintcheck_fn2regs</a>(<span class="keywordtype">int</span> sreg1, <span class="keywordtype">int</span> <a class="code" href="taintcheck_8h.html#12e0e320f6bb29a02a75fb592b018622">sreg2</a>, <span class="keywordtype">int</span> dreg, <span class="keywordtype">int</span> size)        <span class="comment">//size&lt;=4</span>
<a name="l00657"></a>00657 {
<a name="l00658"></a>00658   <span class="keywordflow">if</span>(__builtin_expect(!<a class="code" href="group__main.html#gf24f155e5a9b6ee9bc9a6e6ef9c3987d" title="This flag tells if emulation mode is enabled.">TEMU_emulation_started</a>, 0)) <span class="keywordflow">return</span>;
<a name="l00659"></a>00659 
<a name="l00660"></a>00660 <span class="preprocessor">#ifdef REG_CHECK</span>
<a name="l00661"></a>00661 <span class="preprocessor"></span>  <a class="code" href="TEMU__main_8c.html#a93b5270782d60adbbe1e95b3f87befd">temu_plugin</a>-&gt;<a class="code" href="structplugin__interface__t.html#f9db66146dd22bdad23b09bf2f013a6d" title="This callback is invoked when the current instruction reads a register.">reg_read</a>(sreg1&lt;&lt;2, size);
<a name="l00662"></a>00662   <a class="code" href="TEMU__main_8c.html#a93b5270782d60adbbe1e95b3f87befd">temu_plugin</a>-&gt;<a class="code" href="structplugin__interface__t.html#f9db66146dd22bdad23b09bf2f013a6d" title="This callback is invoked when the current instruction reads a register.">reg_read</a>(sreg2&lt;&lt;2, size);
<a name="l00663"></a>00663 <span class="preprocessor">#endif</span>
<a name="l00664"></a>00664 <span class="preprocessor"></span>
<a name="l00665"></a>00665 <span class="preprocessor">#ifndef NO_PROPAGATE</span>
<a name="l00666"></a>00666 <span class="preprocessor"></span>  <span class="keywordtype">int</span> sregid1 = sreg1 &lt;&lt; 2, sregid2 = sreg2 &lt;&lt; 2, dregid = dreg &lt;&lt; 2;
<a name="l00667"></a>00667   uint8_t taint1, taint2, taint;
<a name="l00668"></a>00668 
<a name="l00669"></a>00669   taint1 = (sreg1 &lt; 0) ? 0 : <a class="code" href="taintcheck_8c.html#76e98a9a904319586334f594defa87ed">taint_reg_check</a>(sregid1, size);
<a name="l00670"></a>00670   taint2 = (sreg2 &lt; 0) ? 0 : <a class="code" href="taintcheck_8c.html#76e98a9a904319586334f594defa87ed">taint_reg_check</a>(sregid2, size);
<a name="l00671"></a>00671   <span class="keywordflow">if</span> (__builtin_expect(taint1 == 0 &amp;&amp;  taint2== 0, 1)) {
<a name="l00672"></a>00672   <a class="code" href="taintcheck_8c.html#974495ac1261e65922b3590a970613a6">clean_register</a>(dregid, size);
<a name="l00673"></a>00673   <span class="keywordflow">return</span>;
<a name="l00674"></a>00674   }
<a name="l00675"></a>00675 
<a name="l00676"></a>00676   taint = (1&lt;&lt;size) -1;
<a name="l00677"></a>00677   <a class="code" href="taintcheck_8c.html#5297c0dd74a0ea8ab628243ab6d6b060">taint_register</a>(dregid, size, taint);
<a name="l00678"></a>00678 
<a name="l00679"></a>00679   <a class="code" href="taintcheck_8c.html#8ba4dce789e7fe78985beb63f5f0f01a" title="flag that indicates if the current instruction propagates taint">insn_tainted</a> = 1;
<a name="l00680"></a>00680   <a class="code" href="structtaint__operand__t.html">taint_operand_t</a> src[2], dst;
<a name="l00681"></a>00681   src[0].<a class="code" href="structtaint__operand__t.html#578c2946959431293fc2d85dfb4e8a89">type</a> = src[1].<a class="code" href="structtaint__operand__t.html#578c2946959431293fc2d85dfb4e8a89">type</a> = dst.<a class="code" href="structtaint__operand__t.html#578c2946959431293fc2d85dfb4e8a89">type</a> = 0;
<a name="l00682"></a>00682   src[0].<a class="code" href="structtaint__operand__t.html#4950a2ce5b28b9e1c9fc99fe6c5c4149">size</a> = src[1].<a class="code" href="structtaint__operand__t.html#4950a2ce5b28b9e1c9fc99fe6c5c4149">size</a> = dst.<a class="code" href="structtaint__operand__t.html#4950a2ce5b28b9e1c9fc99fe6c5c4149">size</a> = size;
<a name="l00683"></a>00683   src[0].<a class="code" href="structtaint__operand__t.html#0b7d021002413c1ac97f5414612db18f">taint</a> = taint1, src[1].<a class="code" href="structtaint__operand__t.html#0b7d021002413c1ac97f5414612db18f">taint</a> = taint2;
<a name="l00684"></a>00684   src[0].<a class="code" href="structtaint__operand__t.html#9b9f04ae0f4017c6231a5b21244d4646">addr</a> = sregid1, src[1].<a class="code" href="structtaint__operand__t.html#9b9f04ae0f4017c6231a5b21244d4646">addr</a> = sregid2, dst.<a class="code" href="structtaint__operand__t.html#9b9f04ae0f4017c6231a5b21244d4646">addr</a> = dregid;
<a name="l00685"></a>00685   src[0].<a class="code" href="structtaint__operand__t.html#dec24928b14ad823f99afff44dfbe045">records</a> =
<a name="l00686"></a>00686       <a class="code" href="taintcheck_8c.html#ba165d9e6ff6e82b3c63a9be1f6c97cc" title="taint records for registers">regs_records</a> + <a class="code" href="TEMU__main_8c.html#a93b5270782d60adbbe1e95b3f87befd">temu_plugin</a>-&gt;<a class="code" href="structplugin__interface__t.html#cf6b2847bc302d9e0c94ca21fd81a75d" title="size of taint record for each tainted byte. TEMU sees taint record as untyped buffer...">taint_record_size</a> * sregid1;
<a name="l00687"></a>00687   src[1].<a class="code" href="structtaint__operand__t.html#dec24928b14ad823f99afff44dfbe045">records</a> =
<a name="l00688"></a>00688       <a class="code" href="taintcheck_8c.html#ba165d9e6ff6e82b3c63a9be1f6c97cc" title="taint records for registers">regs_records</a> + <a class="code" href="TEMU__main_8c.html#a93b5270782d60adbbe1e95b3f87befd">temu_plugin</a>-&gt;<a class="code" href="structplugin__interface__t.html#cf6b2847bc302d9e0c94ca21fd81a75d" title="size of taint record for each tainted byte. TEMU sees taint record as untyped buffer...">taint_record_size</a> * sregid2;
<a name="l00689"></a>00689   dst.<a class="code" href="structtaint__operand__t.html#dec24928b14ad823f99afff44dfbe045">records</a> = <a class="code" href="taintcheck_8c.html#ba165d9e6ff6e82b3c63a9be1f6c97cc" title="taint records for registers">regs_records</a> + <a class="code" href="TEMU__main_8c.html#a93b5270782d60adbbe1e95b3f87befd">temu_plugin</a>-&gt;<a class="code" href="structplugin__interface__t.html#cf6b2847bc302d9e0c94ca21fd81a75d" title="size of taint record for each tainted byte. TEMU sees taint record as untyped buffer...">taint_record_size</a> * dregid;
<a name="l00690"></a>00690   <a class="code" href="TEMU__main_8c.html#a93b5270782d60adbbe1e95b3f87befd">temu_plugin</a>-&gt;<a class="code" href="structplugin__interface__t.html#9d9c6f38a85ffe4738755a465115c94f" title="This callback customizes its own policy for taint propagation.">taint_propagate</a>(2, src, &amp;dst, PROP_MODE_XFORM);
<a name="l00691"></a>00691 <span class="preprocessor">#endif</span>
<a name="l00692"></a>00692 <span class="preprocessor"></span>
<a name="l00693"></a>00693 <span class="preprocessor">#ifdef REG_CHECK</span>
<a name="l00694"></a>00694 <span class="preprocessor"></span>  <a class="code" href="TEMU__main_8c.html#a93b5270782d60adbbe1e95b3f87befd">temu_plugin</a>-&gt;<a class="code" href="structplugin__interface__t.html#80ee4e68586dbf9579df2f774001b01b" title="This callback is invoked when the current instruction writes a register.">reg_write</a>(dreg&lt;&lt;2, size);
<a name="l00695"></a>00695 <span class="preprocessor">#endif</span>
<a name="l00696"></a>00696 <span class="preprocessor"></span>
<a name="l00697"></a>00697 }
<a name="l00698"></a>00698 
<a name="l00699"></a>00699 <span class="preprocessor">#if TAINT_FLAGS</span>
<a name="l00700"></a>00700 <span class="preprocessor"></span>
<a name="l00701"></a>00701 <span class="keywordtype">void</span> <a class="code" href="taintcheck_8c.html#f975ece5cd68bb4f43b74c2161070975" title="Propagate taint info from register to memory.">__attribute__</a>((fastcall)) 
<a name="l00702"></a>00702 <a class="code" href="taintcheck_8h.html#1b3e09cd07088486afc2a77cf535aa90">taintcheck_update_eflags</a>(uint32_t mask)
<a name="l00703"></a>00703 {
<a name="l00704"></a>00704 <span class="preprocessor">#ifndef NO_PROPAGATE</span>
<a name="l00705"></a>00705 <span class="preprocessor"></span>  <span class="keywordflow">if</span>(__builtin_expect(!<a class="code" href="group__main.html#gf24f155e5a9b6ee9bc9a6e6ef9c3987d" title="This flag tells if emulation mode is enabled.">TEMU_emulation_started</a>, 0)) 
<a name="l00706"></a>00706   <span class="keywordflow">return</span>;
<a name="l00707"></a>00707 
<a name="l00708"></a>00708   uint8_t taint1, taint2;
<a name="l00709"></a>00709 
<a name="l00710"></a>00710   taint1 = <a class="code" href="taintcheck_8c.html#76e98a9a904319586334f594defa87ed">taint_reg_check</a>(R_CC_SRC*4, 4);
<a name="l00711"></a>00711   taint2 = <a class="code" href="taintcheck_8c.html#76e98a9a904319586334f594defa87ed">taint_reg_check</a>(R_CC_DST*4, 4);
<a name="l00712"></a>00712   <span class="keywordflow">if</span> (taint1 == 0 &amp;&amp; taint2== 0) {
<a name="l00713"></a>00713   <a class="code" href="taintcheck_8c.html#855ce47fe535eabefb35fb2e80b8d927" title="bitmap for eflags">eflags_bitmap</a> &amp;= ~mask;
<a name="l00714"></a>00714   <span class="keywordflow">return</span>;
<a name="l00715"></a>00715   }
<a name="l00716"></a>00716 
<a name="l00717"></a>00717   <a class="code" href="taintcheck_8c.html#855ce47fe535eabefb35fb2e80b8d927" title="bitmap for eflags">eflags_bitmap</a> |= mask;
<a name="l00718"></a>00718   <a class="code" href="taintcheck_8c.html#8ba4dce789e7fe78985beb63f5f0f01a" title="flag that indicates if the current instruction propagates taint">insn_tainted</a> = 1;
<a name="l00719"></a>00719 
<a name="l00720"></a>00720   <span class="keywordtype">int</span> i;
<a name="l00721"></a>00721   uint8_t *dst_rec, *src_rec=NULL;
<a name="l00722"></a>00722 
<a name="l00723"></a>00723   <span class="keywordflow">if</span>(taint1) {
<a name="l00724"></a>00724    <span class="keywordflow">for</span> (i = 0; i &lt; 4; i++) 
<a name="l00725"></a>00725     <span class="keywordflow">if</span>(taint1 &amp; (1 &lt;&lt; i)) {
<a name="l00726"></a>00726       src_rec = <a class="code" href="taintcheck_8c.html#ba165d9e6ff6e82b3c63a9be1f6c97cc" title="taint records for registers">regs_records</a> + (R_CC_SRC*4 + i) * <a class="code" href="TEMU__main_8c.html#a93b5270782d60adbbe1e95b3f87befd">temu_plugin</a>-&gt;<a class="code" href="structplugin__interface__t.html#cf6b2847bc302d9e0c94ca21fd81a75d" title="size of taint record for each tainted byte. TEMU sees taint record as untyped buffer...">taint_record_size</a>;
<a name="l00727"></a>00727       <span class="keywordflow">break</span>;
<a name="l00728"></a>00728     }
<a name="l00729"></a>00729   }
<a name="l00730"></a>00730   <span class="keywordflow">if</span>(src_rec == NULL) {
<a name="l00731"></a>00731    <span class="keywordflow">for</span> (i = 0; i &lt; 4; i++) 
<a name="l00732"></a>00732     <span class="keywordflow">if</span>(taint2 &amp; (1 &lt;&lt; i)) {
<a name="l00733"></a>00733       src_rec = <a class="code" href="taintcheck_8c.html#ba165d9e6ff6e82b3c63a9be1f6c97cc" title="taint records for registers">regs_records</a> + (R_CC_DST*4 + i) * <a class="code" href="TEMU__main_8c.html#a93b5270782d60adbbe1e95b3f87befd">temu_plugin</a>-&gt;<a class="code" href="structplugin__interface__t.html#cf6b2847bc302d9e0c94ca21fd81a75d" title="size of taint record for each tainted byte. TEMU sees taint record as untyped buffer...">taint_record_size</a>;
<a name="l00734"></a>00734       <span class="keywordflow">break</span>;
<a name="l00735"></a>00735     }
<a name="l00736"></a>00736   }
<a name="l00737"></a>00737 
<a name="l00738"></a>00738   <span class="keywordflow">for</span> (i = 0; i &lt; 12; i++) { <span class="comment">//the highest bit is 12 for cc_eflags</span>
<a name="l00739"></a>00739     <span class="keywordflow">if</span>(mask &amp; (1&lt;&lt;i)) {
<a name="l00740"></a>00740       dst_rec = <a class="code" href="taintcheck_8c.html#761549a83ed3004382812e355cef7c1e" title="taint records for eflags">eflags_records</a> + i*<a class="code" href="TEMU__main_8c.html#a93b5270782d60adbbe1e95b3f87befd">temu_plugin</a>-&gt;<a class="code" href="structplugin__interface__t.html#cf6b2847bc302d9e0c94ca21fd81a75d" title="size of taint record for each tainted byte. TEMU sees taint record as untyped buffer...">taint_record_size</a>;
<a name="l00741"></a>00741       memcpy(dst_rec, src_rec, <a class="code" href="TEMU__main_8c.html#a93b5270782d60adbbe1e95b3f87befd">temu_plugin</a>-&gt;<a class="code" href="structplugin__interface__t.html#cf6b2847bc302d9e0c94ca21fd81a75d" title="size of taint record for each tainted byte. TEMU sees taint record as untyped buffer...">taint_record_size</a>);
<a name="l00742"></a>00742     }
<a name="l00743"></a>00743   }
<a name="l00744"></a>00744 
<a name="l00745"></a>00745 <span class="preprocessor">#endif</span>
<a name="l00746"></a>00746 <span class="preprocessor"></span>}
<a name="l00747"></a>00747 
<a name="l00748"></a>00748 
<a name="l00749"></a>00749 <span class="keywordtype">void</span>  <a class="code" href="taintcheck_8c.html#f975ece5cd68bb4f43b74c2161070975" title="Propagate taint info from register to memory.">__attribute__</a>((fastcall)) 
<a name="l00750"></a>00750 <a class="code" href="taintcheck_8h.html#e132d930bc6062035221370dd974e3ef">taintcheck_flag2reg</a>(uint32_t mask, <span class="keywordtype">int</span> regidx, <span class="keywordtype">int</span> size) 
<a name="l00751"></a>00751 {
<a name="l00752"></a>00752 <span class="preprocessor">#ifndef NO_PROPAGATE</span>
<a name="l00753"></a>00753 <span class="preprocessor"></span>  <span class="keywordflow">if</span>(__builtin_expect(!<a class="code" href="group__main.html#gf24f155e5a9b6ee9bc9a6e6ef9c3987d" title="This flag tells if emulation mode is enabled.">TEMU_emulation_started</a>, 0)) 
<a name="l00754"></a>00754   <span class="keywordflow">return</span>;
<a name="l00755"></a>00755 
<a name="l00756"></a>00756   uint32_t taint = mask &amp; <a class="code" href="taintcheck_8c.html#855ce47fe535eabefb35fb2e80b8d927" title="bitmap for eflags">eflags_bitmap</a>;
<a name="l00757"></a>00757   <span class="keywordflow">if</span> (!taint) {
<a name="l00758"></a>00758     <a class="code" href="taintcheck_8c.html#974495ac1261e65922b3590a970613a6">clean_register</a>(regidx, size);
<a name="l00759"></a>00759     <span class="keywordflow">return</span>;
<a name="l00760"></a>00760   }  
<a name="l00761"></a>00761 
<a name="l00762"></a>00762   <a class="code" href="taintcheck_8c.html#5297c0dd74a0ea8ab628243ab6d6b060">taint_register</a>(regidx, size, (1&lt;&lt;size)-1);
<a name="l00763"></a>00763   <a class="code" href="taintcheck_8c.html#8ba4dce789e7fe78985beb63f5f0f01a" title="flag that indicates if the current instruction propagates taint">insn_tainted</a> = 1;
<a name="l00764"></a>00764 
<a name="l00765"></a>00765   <span class="keywordtype">int</span> i;
<a name="l00766"></a>00766   uint8_t *dst_rec, *src_rec=NULL;
<a name="l00767"></a>00767   <span class="keywordflow">for</span> (i = 0; i &lt; 13; i++) 
<a name="l00768"></a>00768     <span class="keywordflow">if</span>(taint &amp; (1 &lt;&lt; i)) { <span class="comment">//the highest bit is 12 for cc_eflags</span>
<a name="l00769"></a>00769       src_rec = <a class="code" href="taintcheck_8c.html#761549a83ed3004382812e355cef7c1e" title="taint records for eflags">eflags_records</a> + i * <a class="code" href="TEMU__main_8c.html#a93b5270782d60adbbe1e95b3f87befd">temu_plugin</a>-&gt;<a class="code" href="structplugin__interface__t.html#cf6b2847bc302d9e0c94ca21fd81a75d" title="size of taint record for each tainted byte. TEMU sees taint record as untyped buffer...">taint_record_size</a>;
<a name="l00770"></a>00770       <span class="keywordflow">break</span>;
<a name="l00771"></a>00771     }
<a name="l00772"></a>00772 
<a name="l00773"></a>00773   <span class="keywordflow">for</span> (i = 0; i &lt; size; i++) { 
<a name="l00774"></a>00774     dst_rec = <a class="code" href="taintcheck_8c.html#ba165d9e6ff6e82b3c63a9be1f6c97cc" title="taint records for registers">regs_records</a> + (regidx+i)*<a class="code" href="TEMU__main_8c.html#a93b5270782d60adbbe1e95b3f87befd">temu_plugin</a>-&gt;<a class="code" href="structplugin__interface__t.html#cf6b2847bc302d9e0c94ca21fd81a75d" title="size of taint record for each tainted byte. TEMU sees taint record as untyped buffer...">taint_record_size</a>;
<a name="l00775"></a>00775     memcpy(dst_rec, src_rec, <a class="code" href="TEMU__main_8c.html#a93b5270782d60adbbe1e95b3f87befd">temu_plugin</a>-&gt;<a class="code" href="structplugin__interface__t.html#cf6b2847bc302d9e0c94ca21fd81a75d" title="size of taint record for each tainted byte. TEMU sees taint record as untyped buffer...">taint_record_size</a>);
<a name="l00776"></a>00776   }
<a name="l00777"></a>00777 
<a name="l00778"></a>00778 <span class="preprocessor">#endif //NO_PROPAGATE</span>
<a name="l00779"></a>00779 <span class="preprocessor"></span>} 
<a name="l00780"></a>00780 
<a name="l00781"></a>00781 <span class="keywordtype">void</span> <a class="code" href="taintcheck_8c.html#f975ece5cd68bb4f43b74c2161070975" title="Propagate taint info from register to memory.">__attribute__</a>((fastcall)) 
<a name="l00782"></a>00782 <a class="code" href="taintcheck_8h.html#af09c58dfa4c43568e9f1ff4466f4d05">taintcheck_reg2flag</a>(<span class="keywordtype">int</span> regidx, <span class="keywordtype">int</span> size, uint32_t mask)
<a name="l00783"></a>00783 {
<a name="l00784"></a>00784 <span class="preprocessor">#ifndef NO_PROPAGATE</span>
<a name="l00785"></a>00785 <span class="preprocessor"></span>  <span class="keywordflow">if</span>(__builtin_expect(!<a class="code" href="group__main.html#gf24f155e5a9b6ee9bc9a6e6ef9c3987d" title="This flag tells if emulation mode is enabled.">TEMU_emulation_started</a>, 0)) 
<a name="l00786"></a>00786   <span class="keywordflow">return</span>;
<a name="l00787"></a>00787 
<a name="l00788"></a>00788   uint32_t taint = <a class="code" href="taintcheck_8c.html#76e98a9a904319586334f594defa87ed">taint_reg_check</a>(regidx, size);
<a name="l00789"></a>00789   <span class="keywordflow">if</span> (!taint) {
<a name="l00790"></a>00790     eflags_bitmap &amp;= ~mask;
<a name="l00791"></a>00791     <span class="keywordflow">return</span>;
<a name="l00792"></a>00792   }  
<a name="l00793"></a>00793 
<a name="l00794"></a>00794   eflags_bitmap |= mask;
<a name="l00795"></a>00795   <a class="code" href="taintcheck_8c.html#8ba4dce789e7fe78985beb63f5f0f01a" title="flag that indicates if the current instruction propagates taint">insn_tainted</a> = 1;
<a name="l00796"></a>00796 
<a name="l00797"></a>00797   <span class="keywordtype">int</span> i;
<a name="l00798"></a>00798   uint8_t *dst_rec, *src_rec=NULL;
<a name="l00799"></a>00799   <span class="keywordflow">for</span> (i = 0; i &lt; size; i++) 
<a name="l00800"></a>00800     <span class="keywordflow">if</span>(taint &amp; (1 &lt;&lt; i)) {
<a name="l00801"></a>00801       src_rec = <a class="code" href="taintcheck_8c.html#ba165d9e6ff6e82b3c63a9be1f6c97cc" title="taint records for registers">regs_records</a> + i * <a class="code" href="TEMU__main_8c.html#a93b5270782d60adbbe1e95b3f87befd">temu_plugin</a>-&gt;<a class="code" href="structplugin__interface__t.html#cf6b2847bc302d9e0c94ca21fd81a75d" title="size of taint record for each tainted byte. TEMU sees taint record as untyped buffer...">taint_record_size</a>;
<a name="l00802"></a>00802       <span class="keywordflow">break</span>;
<a name="l00803"></a>00803     }
<a name="l00804"></a>00804 
<a name="l00805"></a>00805   <span class="keywordflow">for</span> (i = 0; i &lt; size*8; i++) {
<a name="l00806"></a>00806     <span class="keywordflow">if</span>(mask &amp; (1&lt;&lt;i)) { 
<a name="l00807"></a>00807       dst_rec = <a class="code" href="taintcheck_8c.html#761549a83ed3004382812e355cef7c1e" title="taint records for eflags">eflags_records</a> + i*<a class="code" href="TEMU__main_8c.html#a93b5270782d60adbbe1e95b3f87befd">temu_plugin</a>-&gt;<a class="code" href="structplugin__interface__t.html#cf6b2847bc302d9e0c94ca21fd81a75d" title="size of taint record for each tainted byte. TEMU sees taint record as untyped buffer...">taint_record_size</a>;
<a name="l00808"></a>00808       memcpy(dst_rec, src_rec, <a class="code" href="TEMU__main_8c.html#a93b5270782d60adbbe1e95b3f87befd">temu_plugin</a>-&gt;<a class="code" href="structplugin__interface__t.html#cf6b2847bc302d9e0c94ca21fd81a75d" title="size of taint record for each tainted byte. TEMU sees taint record as untyped buffer...">taint_record_size</a>);
<a name="l00809"></a>00809     }
<a name="l00810"></a>00810   }
<a name="l00811"></a>00811 
<a name="l00812"></a>00812 <span class="preprocessor">#endif //NO_PROPAGATE</span>
<a name="l00813"></a>00813 <span class="preprocessor"></span>}
<a name="l00814"></a>00814 
<a name="l00815"></a>00815 
<a name="l00816"></a>00816 <span class="preprocessor">#endif</span>
<a name="l00817"></a>00817 <span class="preprocessor"></span>
<a name="l00818"></a>00818 
<a name="l00819"></a>00819 <span class="keywordtype">void</span> <a class="code" href="taintcheck_8c.html#f975ece5cd68bb4f43b74c2161070975" title="Propagate taint info from register to memory.">__attribute__</a>((fastcall)) taintcheck_logic_T0_T1()
<a name="l00820"></a>00820 {
<a name="l00821"></a>00821   <span class="keywordflow">if</span>(__builtin_expect(!<a class="code" href="group__main.html#gf24f155e5a9b6ee9bc9a6e6ef9c3987d" title="This flag tells if emulation mode is enabled.">TEMU_emulation_started</a>, 0)) <span class="keywordflow">return</span>;
<a name="l00822"></a>00822 
<a name="l00823"></a>00823 <span class="preprocessor">#ifndef NO_PROPAGATE</span>
<a name="l00824"></a>00824 <span class="preprocessor"></span>  uint8_t taint1, taint2, taint;
<a name="l00825"></a>00825   taint1 = <a class="code" href="taintcheck_8c.html#76e98a9a904319586334f594defa87ed">taint_reg_check</a>(R_T0*4, 4);
<a name="l00826"></a>00826   taint2 = <a class="code" href="taintcheck_8c.html#76e98a9a904319586334f594defa87ed">taint_reg_check</a>(R_T1*4, 4);
<a name="l00827"></a>00827   taint = taint1 | taint2;
<a name="l00828"></a>00828   <span class="keywordflow">if</span>(__builtin_expect(0 == taint, 1)) <span class="keywordflow">return</span>;
<a name="l00829"></a>00829  
<a name="l00830"></a>00830   <a class="code" href="taintcheck_8c.html#5297c0dd74a0ea8ab628243ab6d6b060">taint_register</a>(R_T0*4, 4, taint);
<a name="l00831"></a>00831   <a class="code" href="taintcheck_8c.html#8ba4dce789e7fe78985beb63f5f0f01a" title="flag that indicates if the current instruction propagates taint">insn_tainted</a> = 1;
<a name="l00832"></a>00832   <a class="code" href="structtaint__operand__t.html">taint_operand_t</a> src[2], dst;
<a name="l00833"></a>00833   <span class="keywordtype">int</span> i;
<a name="l00834"></a>00834   src[0].<a class="code" href="structtaint__operand__t.html#578c2946959431293fc2d85dfb4e8a89">type</a> = src[1].<a class="code" href="structtaint__operand__t.html#578c2946959431293fc2d85dfb4e8a89">type</a> = dst.<a class="code" href="structtaint__operand__t.html#578c2946959431293fc2d85dfb4e8a89">type</a> = 0; <span class="comment">//register</span>
<a name="l00835"></a>00835   src[0].<a class="code" href="structtaint__operand__t.html#4950a2ce5b28b9e1c9fc99fe6c5c4149">size</a> = src[1].<a class="code" href="structtaint__operand__t.html#4950a2ce5b28b9e1c9fc99fe6c5c4149">size</a> = dst.<a class="code" href="structtaint__operand__t.html#4950a2ce5b28b9e1c9fc99fe6c5c4149">size</a> = 1; <span class="comment">//we do it byte by byte</span>
<a name="l00836"></a>00836   <span class="keywordflow">for</span> (i=0; i&lt;4; i++) {
<a name="l00837"></a>00837     <span class="keywordflow">if</span>(!(taint &amp; (1&lt;&lt;i))) <span class="keywordflow">continue</span>;
<a name="l00838"></a>00838     
<a name="l00839"></a>00839     src[0].<a class="code" href="structtaint__operand__t.html#0b7d021002413c1ac97f5414612db18f">taint</a> = (taint1 &gt;&gt; i) &amp; 1;
<a name="l00840"></a>00840     src[1].<a class="code" href="structtaint__operand__t.html#0b7d021002413c1ac97f5414612db18f">taint</a> = (taint2 &gt;&gt; i) &amp; 1;
<a name="l00841"></a>00841     dst.<a class="code" href="structtaint__operand__t.html#9b9f04ae0f4017c6231a5b21244d4646">addr</a> = src[0].<a class="code" href="structtaint__operand__t.html#9b9f04ae0f4017c6231a5b21244d4646">addr</a> = R_T0*4 + i;
<a name="l00842"></a>00842     src[1].<a class="code" href="structtaint__operand__t.html#9b9f04ae0f4017c6231a5b21244d4646">addr</a> = R_T1*4 + i;
<a name="l00843"></a>00843     src[0].<a class="code" href="structtaint__operand__t.html#dec24928b14ad823f99afff44dfbe045">records</a> = <a class="code" href="taintcheck_8c.html#ba165d9e6ff6e82b3c63a9be1f6c97cc" title="taint records for registers">regs_records</a> + <a class="code" href="TEMU__main_8c.html#a93b5270782d60adbbe1e95b3f87befd">temu_plugin</a>-&gt;<a class="code" href="structplugin__interface__t.html#cf6b2847bc302d9e0c94ca21fd81a75d" title="size of taint record for each tainted byte. TEMU sees taint record as untyped buffer...">taint_record_size</a> * src[0].<a class="code" href="structtaint__operand__t.html#9b9f04ae0f4017c6231a5b21244d4646">addr</a>;
<a name="l00844"></a>00844     src[1].<a class="code" href="structtaint__operand__t.html#dec24928b14ad823f99afff44dfbe045">records</a> = <a class="code" href="taintcheck_8c.html#ba165d9e6ff6e82b3c63a9be1f6c97cc" title="taint records for registers">regs_records</a> + <a class="code" href="TEMU__main_8c.html#a93b5270782d60adbbe1e95b3f87befd">temu_plugin</a>-&gt;<a class="code" href="structplugin__interface__t.html#cf6b2847bc302d9e0c94ca21fd81a75d" title="size of taint record for each tainted byte. TEMU sees taint record as untyped buffer...">taint_record_size</a> * src[1].<a class="code" href="structtaint__operand__t.html#9b9f04ae0f4017c6231a5b21244d4646">addr</a>;
<a name="l00845"></a>00845     dst.<a class="code" href="structtaint__operand__t.html#dec24928b14ad823f99afff44dfbe045">records</a> = src[0].<a class="code" href="structtaint__operand__t.html#dec24928b14ad823f99afff44dfbe045">records</a>;
<a name="l00846"></a>00846     <a class="code" href="TEMU__main_8c.html#a93b5270782d60adbbe1e95b3f87befd">temu_plugin</a>-&gt;<a class="code" href="structplugin__interface__t.html#9d9c6f38a85ffe4738755a465115c94f" title="This callback customizes its own policy for taint propagation.">taint_propagate</a>(2, src, &amp;dst, PROP_MODE_XFORM);
<a name="l00847"></a>00847   }
<a name="l00848"></a>00848 
<a name="l00849"></a>00849 <span class="preprocessor">#endif</span>
<a name="l00850"></a>00850 <span class="preprocessor"></span>}
<a name="l00851"></a>00851 
<a name="l00852"></a><a class="code" href="taintcheck_8h.html#00c06d06632761e54b659ea35d40665b">00852</a> <span class="keywordtype">void</span> <a class="code" href="taintcheck_8c.html#00c06d06632761e54b659ea35d40665b">taintcheck_clear_ones</a>(<span class="keywordtype">int</span> reg, <span class="keywordtype">int</span> size, uint32_t val)     <span class="comment">//size&lt;=4</span>
<a name="l00853"></a>00853 {
<a name="l00854"></a>00854 <span class="preprocessor">#ifndef NO_PROPAGATE</span>
<a name="l00855"></a>00855 <span class="preprocessor"></span>  <span class="keywordflow">if</span>(__builtin_expect(!<a class="code" href="group__main.html#gf24f155e5a9b6ee9bc9a6e6ef9c3987d" title="This flag tells if emulation mode is enabled.">TEMU_emulation_started</a>, 0)) <span class="keywordflow">return</span>;
<a name="l00856"></a>00856 
<a name="l00857"></a>00857   <span class="keywordtype">int</span> i;
<a name="l00858"></a>00858   uint8_t taint = <a class="code" href="taintcheck_8c.html#76e98a9a904319586334f594defa87ed">taint_reg_check</a>(reg &lt;&lt; 2, size);
<a name="l00859"></a>00859   <span class="keywordflow">if</span> (!taint)
<a name="l00860"></a>00860     <span class="keywordflow">return</span>;
<a name="l00861"></a>00861 
<a name="l00862"></a>00862   <span class="keywordflow">for</span> (i = 0; i &lt; size; i++) {
<a name="l00863"></a>00863     <span class="keywordflow">if</span> (((val &gt;&gt; i) &amp; 0xff) == 0xff)
<a name="l00864"></a>00864       taint &amp;= ~(1 &lt;&lt; i);
<a name="l00865"></a>00865   }
<a name="l00866"></a>00866   <a class="code" href="taintcheck_8c.html#5297c0dd74a0ea8ab628243ab6d6b060">taint_register</a>(reg &lt;&lt; 2, size, taint);
<a name="l00867"></a>00867 <span class="preprocessor">#endif</span>
<a name="l00868"></a>00868 <span class="preprocessor"></span>}
<a name="l00869"></a>00869 
<a name="l00870"></a><a class="code" href="taintcheck_8h.html#cb369d1a7bd44fbac77116568ecaf790">00870</a> <span class="keywordtype">void</span> <a class="code" href="taintcheck_8c.html#cb369d1a7bd44fbac77116568ecaf790">taintcheck_clear_zeros</a>(<span class="keywordtype">int</span> reg, <span class="keywordtype">int</span> size, uint32_t val)    <span class="comment">//size&lt;=4</span>
<a name="l00871"></a>00871 {
<a name="l00872"></a>00872 <span class="preprocessor">#ifndef NO_PROPAGATE</span>
<a name="l00873"></a>00873 <span class="preprocessor"></span>  <span class="keywordflow">if</span> (__builtin_expect(!<a class="code" href="group__main.html#gf24f155e5a9b6ee9bc9a6e6ef9c3987d" title="This flag tells if emulation mode is enabled.">TEMU_emulation_started</a>, 0)) <span class="keywordflow">return</span>;
<a name="l00874"></a>00874 
<a name="l00875"></a>00875   uint8_t taint = <a class="code" href="taintcheck_8c.html#76e98a9a904319586334f594defa87ed">taint_reg_check</a>(reg &lt;&lt; 2, size);
<a name="l00876"></a>00876   <span class="keywordflow">if</span> (__builtin_expect(!taint, 1))
<a name="l00877"></a>00877     <span class="keywordflow">return</span>;
<a name="l00878"></a>00878   taint = <a class="code" href="taintcheck_8c.html#e0354bf288bcec353063475b7a89bbf0">clear_zero</a>(val, size, taint);
<a name="l00879"></a>00879   <a class="code" href="taintcheck_8c.html#5297c0dd74a0ea8ab628243ab6d6b060">taint_register</a>(reg &lt;&lt; 2, size, taint);
<a name="l00880"></a>00880 <span class="preprocessor">#endif</span>
<a name="l00881"></a>00881 <span class="preprocessor"></span>}
<a name="l00882"></a>00882 
<a name="l00883"></a>00883 <span class="keywordtype">void</span> <a class="code" href="taintcheck_8c.html#f975ece5cd68bb4f43b74c2161070975" title="Propagate taint info from register to memory.">__attribute__</a>((fastcall)) 
<a name="l00884"></a>00884 taintcheck_fn3regs(<span class="keywordtype">int</span> sreg1, <span class="keywordtype">int</span> sreg2, <span class="keywordtype">int</span> <a class="code" href="taintcheck_8h.html#8b45c02728a0c3524893e92daaa59f9c">sreg3</a>, <span class="keywordtype">int</span> dreg, <span class="keywordtype">int</span> size)     <span class="comment">//size&lt;=4</span>
<a name="l00885"></a>00885 {
<a name="l00886"></a>00886   <span class="keywordflow">if</span>(__builtin_expect(!<a class="code" href="group__main.html#gf24f155e5a9b6ee9bc9a6e6ef9c3987d" title="This flag tells if emulation mode is enabled.">TEMU_emulation_started</a>, 0)) <span class="keywordflow">return</span>;
<a name="l00887"></a>00887 
<a name="l00888"></a>00888 <span class="preprocessor">#ifdef REG_CHECK</span>
<a name="l00889"></a>00889 <span class="preprocessor"></span>  <a class="code" href="TEMU__main_8c.html#a93b5270782d60adbbe1e95b3f87befd">temu_plugin</a>-&gt;<a class="code" href="structplugin__interface__t.html#f9db66146dd22bdad23b09bf2f013a6d" title="This callback is invoked when the current instruction reads a register.">reg_read</a>(sreg1&lt;&lt;2, size);
<a name="l00890"></a>00890   <a class="code" href="TEMU__main_8c.html#a93b5270782d60adbbe1e95b3f87befd">temu_plugin</a>-&gt;<a class="code" href="structplugin__interface__t.html#f9db66146dd22bdad23b09bf2f013a6d" title="This callback is invoked when the current instruction reads a register.">reg_read</a>(sreg2&lt;&lt;2, size);
<a name="l00891"></a>00891   <a class="code" href="TEMU__main_8c.html#a93b5270782d60adbbe1e95b3f87befd">temu_plugin</a>-&gt;<a class="code" href="structplugin__interface__t.html#f9db66146dd22bdad23b09bf2f013a6d" title="This callback is invoked when the current instruction reads a register.">reg_read</a>(sreg3&lt;&lt;2, size);
<a name="l00892"></a>00892 <span class="preprocessor">#endif</span>
<a name="l00893"></a>00893 <span class="preprocessor"></span>
<a name="l00894"></a>00894 
<a name="l00895"></a>00895 <span class="preprocessor">#ifndef NO_PROPAGATE</span>
<a name="l00896"></a>00896 <span class="preprocessor"></span>  <span class="keywordtype">int</span> sregid1 = sreg1 &lt;&lt; 2, sregid2 = sreg2 &lt;&lt; 2, sregid3 =
<a name="l00897"></a>00897       sreg3 &lt;&lt; 2, dregid = dreg &lt;&lt; 2;
<a name="l00898"></a>00898   uint8_t taint1, taint2, taint3, taint = 0;
<a name="l00899"></a>00899 
<a name="l00900"></a>00900   taint1 = <a class="code" href="taintcheck_8c.html#76e98a9a904319586334f594defa87ed">taint_reg_check</a>(sregid1, size);
<a name="l00901"></a>00901   taint2 = <a class="code" href="taintcheck_8c.html#76e98a9a904319586334f594defa87ed">taint_reg_check</a>(sregid2, size);
<a name="l00902"></a>00902   taint3 = <a class="code" href="taintcheck_8c.html#76e98a9a904319586334f594defa87ed">taint_reg_check</a>(sregid3, size);
<a name="l00903"></a>00903   <span class="keywordflow">if</span> (__builtin_expect(!taint1 &amp;&amp; !taint2 &amp;&amp; !taint3, 1)) {
<a name="l00904"></a>00904     <a class="code" href="taintcheck_8c.html#974495ac1261e65922b3590a970613a6">clean_register</a>(dregid, size);
<a name="l00905"></a>00905     <span class="keywordflow">return</span>;
<a name="l00906"></a>00906   }
<a name="l00907"></a>00907 
<a name="l00908"></a>00908   taint = (1 &lt;&lt; size) - 1;
<a name="l00909"></a>00909   <a class="code" href="taintcheck_8c.html#5297c0dd74a0ea8ab628243ab6d6b060">taint_register</a>(dregid, size, taint);
<a name="l00910"></a>00910   <a class="code" href="taintcheck_8c.html#8ba4dce789e7fe78985beb63f5f0f01a" title="flag that indicates if the current instruction propagates taint">insn_tainted</a> = 1;
<a name="l00911"></a>00911   <a class="code" href="structtaint__operand__t.html">taint_operand_t</a> src[3], dst;
<a name="l00912"></a>00912   src[0].<a class="code" href="structtaint__operand__t.html#578c2946959431293fc2d85dfb4e8a89">type</a> = src[1].<a class="code" href="structtaint__operand__t.html#578c2946959431293fc2d85dfb4e8a89">type</a> = src[2].<a class="code" href="structtaint__operand__t.html#578c2946959431293fc2d85dfb4e8a89">type</a> = dst.<a class="code" href="structtaint__operand__t.html#578c2946959431293fc2d85dfb4e8a89">type</a> = 0;
<a name="l00913"></a>00913   src[0].<a class="code" href="structtaint__operand__t.html#4950a2ce5b28b9e1c9fc99fe6c5c4149">size</a> = src[1].<a class="code" href="structtaint__operand__t.html#4950a2ce5b28b9e1c9fc99fe6c5c4149">size</a> = src[2].<a class="code" href="structtaint__operand__t.html#4950a2ce5b28b9e1c9fc99fe6c5c4149">size</a> = dst.<a class="code" href="structtaint__operand__t.html#4950a2ce5b28b9e1c9fc99fe6c5c4149">size</a> = size;
<a name="l00914"></a>00914  
<a name="l00915"></a>00915   src[0].<a class="code" href="structtaint__operand__t.html#0b7d021002413c1ac97f5414612db18f">taint</a> = taint1, src[1].<a class="code" href="structtaint__operand__t.html#0b7d021002413c1ac97f5414612db18f">taint</a> = taint2, src[2].<a class="code" href="structtaint__operand__t.html#0b7d021002413c1ac97f5414612db18f">taint</a> = taint3;
<a name="l00916"></a>00916   src[0].<a class="code" href="structtaint__operand__t.html#9b9f04ae0f4017c6231a5b21244d4646">addr</a> = sregid1, src[1].<a class="code" href="structtaint__operand__t.html#9b9f04ae0f4017c6231a5b21244d4646">addr</a> = sregid2, src[2].<a class="code" href="structtaint__operand__t.html#9b9f04ae0f4017c6231a5b21244d4646">addr</a> =
<a name="l00917"></a>00917       sregid3, dst.<a class="code" href="structtaint__operand__t.html#9b9f04ae0f4017c6231a5b21244d4646">addr</a> = dregid;
<a name="l00918"></a>00918   src[0].<a class="code" href="structtaint__operand__t.html#dec24928b14ad823f99afff44dfbe045">records</a> =
<a name="l00919"></a>00919       <a class="code" href="taintcheck_8c.html#ba165d9e6ff6e82b3c63a9be1f6c97cc" title="taint records for registers">regs_records</a> + <a class="code" href="TEMU__main_8c.html#a93b5270782d60adbbe1e95b3f87befd">temu_plugin</a>-&gt;<a class="code" href="structplugin__interface__t.html#cf6b2847bc302d9e0c94ca21fd81a75d" title="size of taint record for each tainted byte. TEMU sees taint record as untyped buffer...">taint_record_size</a> * sregid1;
<a name="l00920"></a>00920   src[1].<a class="code" href="structtaint__operand__t.html#dec24928b14ad823f99afff44dfbe045">records</a> =
<a name="l00921"></a>00921       <a class="code" href="taintcheck_8c.html#ba165d9e6ff6e82b3c63a9be1f6c97cc" title="taint records for registers">regs_records</a> + <a class="code" href="TEMU__main_8c.html#a93b5270782d60adbbe1e95b3f87befd">temu_plugin</a>-&gt;<a class="code" href="structplugin__interface__t.html#cf6b2847bc302d9e0c94ca21fd81a75d" title="size of taint record for each tainted byte. TEMU sees taint record as untyped buffer...">taint_record_size</a> * sregid2;
<a name="l00922"></a>00922   src[2].<a class="code" href="structtaint__operand__t.html#dec24928b14ad823f99afff44dfbe045">records</a> =
<a name="l00923"></a>00923       <a class="code" href="taintcheck_8c.html#ba165d9e6ff6e82b3c63a9be1f6c97cc" title="taint records for registers">regs_records</a> + <a class="code" href="TEMU__main_8c.html#a93b5270782d60adbbe1e95b3f87befd">temu_plugin</a>-&gt;<a class="code" href="structplugin__interface__t.html#cf6b2847bc302d9e0c94ca21fd81a75d" title="size of taint record for each tainted byte. TEMU sees taint record as untyped buffer...">taint_record_size</a> * sregid3;
<a name="l00924"></a>00924   dst.<a class="code" href="structtaint__operand__t.html#dec24928b14ad823f99afff44dfbe045">records</a> = <a class="code" href="taintcheck_8c.html#ba165d9e6ff6e82b3c63a9be1f6c97cc" title="taint records for registers">regs_records</a> + <a class="code" href="TEMU__main_8c.html#a93b5270782d60adbbe1e95b3f87befd">temu_plugin</a>-&gt;<a class="code" href="structplugin__interface__t.html#cf6b2847bc302d9e0c94ca21fd81a75d" title="size of taint record for each tainted byte. TEMU sees taint record as untyped buffer...">taint_record_size</a> * dregid;
<a name="l00925"></a>00925 
<a name="l00926"></a>00926   <a class="code" href="TEMU__main_8c.html#a93b5270782d60adbbe1e95b3f87befd">temu_plugin</a>-&gt;<a class="code" href="structplugin__interface__t.html#9d9c6f38a85ffe4738755a465115c94f" title="This callback customizes its own policy for taint propagation.">taint_propagate</a>(3, src, &amp;dst, PROP_MODE_XFORM);
<a name="l00927"></a>00927 <span class="preprocessor">#endif</span>
<a name="l00928"></a>00928 <span class="preprocessor"></span>
<a name="l00929"></a>00929 <span class="preprocessor">#ifdef REG_CHECK</span>
<a name="l00930"></a>00930 <span class="preprocessor"></span>  <a class="code" href="TEMU__main_8c.html#a93b5270782d60adbbe1e95b3f87befd">temu_plugin</a>-&gt;<a class="code" href="structplugin__interface__t.html#80ee4e68586dbf9579df2f774001b01b" title="This callback is invoked when the current instruction writes a register.">reg_write</a>(dreg&lt;&lt;2, size);
<a name="l00931"></a>00931 <span class="preprocessor">#endif</span>
<a name="l00932"></a>00932 <span class="preprocessor"></span>}
<a name="l00933"></a>00933 
<a name="l00934"></a><a class="code" href="structdisk__record.html">00934</a> <span class="keyword">typedef</span> <span class="keyword">struct </span><a class="code" href="structdisk__record.html">disk_record</a>{
<a name="l00935"></a><a class="code" href="structdisk__record.html#6f9e4b28d8a0f4668f0aed37975a4cba">00935</a>   <span class="keywordtype">void</span> *<a class="code" href="structdisk__record.html#6f9e4b28d8a0f4668f0aed37975a4cba">bs</a>;
<a name="l00936"></a><a class="code" href="structdisk__record.html#46687f5b8517d581376fe61ce771ee67">00936</a>   uint64_t <a class="code" href="structdisk__record.html#46687f5b8517d581376fe61ce771ee67">index</a>;
<a name="l00937"></a><a class="code" href="structdisk__record.html#32996293ceaeea3aeebf60ea925f8175">00937</a>   uint64_t <a class="code" href="structdisk__record.html#32996293ceaeea3aeebf60ea925f8175">bitmap</a>;
<a name="l00938"></a>00938   LIST_ENTRY(<a class="code" href="structdisk__record.html">disk_record</a>) entry;
<a name="l00939"></a>00939   uint8_t records[0];
<a name="l00940"></a>00940 } <a class="code" href="structdisk__record.html">disk_record_t</a>;
<a name="l00941"></a>00941 
<a name="l00942"></a>00942 <span class="preprocessor">#define DISK_HTAB_SIZE (1024)</span>
<a name="l00943"></a><a class="code" href="taintcheck_8c.html#449de6996a71abd00e90bca1e762c2c2">00943</a> <span class="preprocessor"></span><span class="keyword">static</span> <a class="code" href="taintcheck_8c.html#449de6996a71abd00e90bca1e762c2c2">LIST_HEAD</a>(disk_record_list_head, <a class="code" href="structdisk__record.html">disk_record</a>) 
<a name="l00944"></a>00944   disk_record_heads[DISK_HTAB_SIZE];
<a name="l00945"></a>00945 <span class="comment">//static struct list_head disk_records_htab[DISK_HTAB_SIZE];</span>
<a name="l00946"></a>00946 
<a name="l00947"></a>00947 <span class="keywordtype">int</span> <a class="code" href="taintcheck_8h.html#5f5f47ceccbe47ac9205cefd0c36db4e">taintcheck_taint_disk</a>(uint64_t <a class="code" href="structdisk__record.html#46687f5b8517d581376fe61ce771ee67">index</a>, uint64_t taint, <span class="keywordtype">int</span> offset,
<a name="l00948"></a>00948                           <span class="keywordtype">int</span> size, uint8_t * record, <span class="keywordtype">void</span> *<a class="code" href="structdisk__record.html#6f9e4b28d8a0f4668f0aed37975a4cba">bs</a>)
<a name="l00949"></a>00949 {
<a name="l00950"></a>00950   <span class="keywordflow">if</span>(!<a class="code" href="group__main.html#gf24f155e5a9b6ee9bc9a6e6ef9c3987d" title="This flag tells if emulation mode is enabled.">TEMU_emulation_started</a>) <span class="keywordflow">return</span> 0;
<a name="l00951"></a>00951 
<a name="l00952"></a>00952 <span class="preprocessor">#ifndef NO_PROPAGATE</span>
<a name="l00953"></a>00953 <span class="preprocessor"></span>  <span class="keyword">struct </span>disk_record_list_head *head =
<a name="l00954"></a>00954       &amp;disk_record_heads[index &amp; (DISK_HTAB_SIZE - 1)];
<a name="l00955"></a>00955   <a class="code" href="structdisk__record.html">disk_record_t</a> *drec,  *new_drec;
<a name="l00956"></a>00956   <span class="keywordtype">int</span> found = 0;
<a name="l00957"></a>00957   <span class="keywordtype">int</span> size2 = 0;
<a name="l00958"></a>00958   uint64_t taint2 = 0;
<a name="l00959"></a>00959 
<a name="l00960"></a>00960   <span class="keywordflow">if</span> (offset + size &gt; 64) {
<a name="l00961"></a>00961     size = 64 - offset, taint &amp;= <a class="code" href="taintcheck_8c.html#1ccca6d08d0095f0c7c74cd502c82900">size_to_taint</a>(size);
<a name="l00962"></a>00962     size2 = offset + size - 64;
<a name="l00963"></a>00963     taint2 = taint &gt;&gt; offset;
<a name="l00964"></a>00964   }
<a name="l00965"></a>00965 
<a name="l00966"></a>00966   LIST_FOREACH(drec, head, entry) {
<a name="l00967"></a>00967     <span class="keywordflow">if</span> (drec-&gt;index == index &amp;&amp; drec-&gt;bs == bs) {
<a name="l00968"></a>00968       found = 1;
<a name="l00969"></a>00969       <span class="keywordflow">break</span>;
<a name="l00970"></a>00970     }
<a name="l00971"></a>00971     <span class="keywordflow">if</span> (drec-&gt;index &gt; index)
<a name="l00972"></a>00972       <span class="keywordflow">break</span>;
<a name="l00973"></a>00973   }
<a name="l00974"></a>00974   <span class="keywordflow">if</span> (!found) {
<a name="l00975"></a>00975     <span class="keywordflow">if</span> (!taint)
<a name="l00976"></a>00976       <span class="keywordflow">return</span> 0;
<a name="l00977"></a>00977 
<a name="l00978"></a>00978     <span class="keywordflow">if</span> (!(new_drec = qemu_mallocz(<span class="keyword">sizeof</span>(<a class="code" href="structdisk__record.html">disk_record_t</a>) +
<a name="l00979"></a>00979                               64 * <a class="code" href="TEMU__main_8c.html#a93b5270782d60adbbe1e95b3f87befd">temu_plugin</a>-&gt;<a class="code" href="structplugin__interface__t.html#cf6b2847bc302d9e0c94ca21fd81a75d" title="size of taint record for each tainted byte. TEMU sees taint record as untyped buffer...">taint_record_size</a>)))
<a name="l00980"></a>00980       <span class="keywordflow">return</span> 0;
<a name="l00981"></a>00981 
<a name="l00982"></a>00982     new_drec-&gt;index = index;
<a name="l00983"></a>00983     new_drec-&gt;bs = bs;
<a name="l00984"></a>00984     new_drec-&gt;bitmap = taint &lt;&lt; offset;
<a name="l00985"></a>00985     memcpy(new_drec-&gt;records + offset * <a class="code" href="TEMU__main_8c.html#a93b5270782d60adbbe1e95b3f87befd">temu_plugin</a>-&gt;<a class="code" href="structplugin__interface__t.html#cf6b2847bc302d9e0c94ca21fd81a75d" title="size of taint record for each tainted byte. TEMU sees taint record as untyped buffer...">taint_record_size</a>,
<a name="l00986"></a>00986            record, size * <a class="code" href="TEMU__main_8c.html#a93b5270782d60adbbe1e95b3f87befd">temu_plugin</a>-&gt;<a class="code" href="structplugin__interface__t.html#cf6b2847bc302d9e0c94ca21fd81a75d" title="size of taint record for each tainted byte. TEMU sees taint record as untyped buffer...">taint_record_size</a>);
<a name="l00987"></a>00987     LIST_INSERT_HEAD(head, new_drec, entry);
<a name="l00988"></a>00988   }
<a name="l00989"></a>00989   <span class="keywordflow">else</span> {
<a name="l00990"></a>00990     drec-&gt;bitmap &amp;= ~(<a class="code" href="taintcheck_8c.html#1ccca6d08d0095f0c7c74cd502c82900">size_to_taint</a>(size) &lt;&lt; offset);
<a name="l00991"></a>00991     <span class="keywordflow">if</span> (taint) {
<a name="l00992"></a>00992       drec-&gt;bitmap |= taint &lt;&lt; offset;
<a name="l00993"></a>00993       memcpy(drec-&gt;records + offset * <a class="code" href="TEMU__main_8c.html#a93b5270782d60adbbe1e95b3f87befd">temu_plugin</a>-&gt;<a class="code" href="structplugin__interface__t.html#cf6b2847bc302d9e0c94ca21fd81a75d" title="size of taint record for each tainted byte. TEMU sees taint record as untyped buffer...">taint_record_size</a>,
<a name="l00994"></a>00994              record, size * <a class="code" href="TEMU__main_8c.html#a93b5270782d60adbbe1e95b3f87befd">temu_plugin</a>-&gt;<a class="code" href="structplugin__interface__t.html#cf6b2847bc302d9e0c94ca21fd81a75d" title="size of taint record for each tainted byte. TEMU sees taint record as untyped buffer...">taint_record_size</a>);
<a name="l00995"></a>00995     }
<a name="l00996"></a>00996     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!drec-&gt;bitmap) {
<a name="l00997"></a>00997       LIST_REMOVE(drec, entry);
<a name="l00998"></a>00998       qemu_free(drec);
<a name="l00999"></a>00999     }
<a name="l01000"></a>01000   }
<a name="l01001"></a>01001 
<a name="l01002"></a>01002   <span class="keywordflow">if</span> (size2)
<a name="l01003"></a>01003     <a class="code" href="taintcheck_8h.html#5f5f47ceccbe47ac9205cefd0c36db4e">taintcheck_taint_disk</a>(index + 1, taint2, 0, size2,
<a name="l01004"></a>01004                           record + size * <a class="code" href="TEMU__main_8c.html#a93b5270782d60adbbe1e95b3f87befd">temu_plugin</a>-&gt;<a class="code" href="structplugin__interface__t.html#cf6b2847bc302d9e0c94ca21fd81a75d" title="size of taint record for each tainted byte. TEMU sees taint record as untyped buffer...">taint_record_size</a>,
<a name="l01005"></a>01005                           bs);
<a name="l01006"></a>01006 <span class="preprocessor">#endif</span>
<a name="l01007"></a>01007 <span class="preprocessor"></span>  <span class="keywordflow">return</span> 0;
<a name="l01008"></a>01008 }
<a name="l01009"></a>01009 
<a name="l01010"></a><a class="code" href="taintcheck_8c.html#b2ff0eb6e17b89eae75c67f0d3746f06">01010</a> uint64_t <a class="code" href="taintcheck_8c.html#b2ff0eb6e17b89eae75c67f0d3746f06">taintcheck_disk_check</a>(uint64_t <a class="code" href="structdisk__record.html#46687f5b8517d581376fe61ce771ee67">index</a>, <span class="keywordtype">int</span> offset, <span class="keywordtype">int</span> size,
<a name="l01011"></a>01011                                uint8_t * record, <span class="keywordtype">void</span> *<a class="code" href="structdisk__record.html#6f9e4b28d8a0f4668f0aed37975a4cba">bs</a>)
<a name="l01012"></a>01012 {
<a name="l01013"></a>01013   <span class="keywordflow">if</span>(!<a class="code" href="group__main.html#gf24f155e5a9b6ee9bc9a6e6ef9c3987d" title="This flag tells if emulation mode is enabled.">TEMU_emulation_started</a>) <span class="keywordflow">return</span> 0;
<a name="l01014"></a>01014 
<a name="l01015"></a>01015 <span class="preprocessor">#ifndef NO_PROPAGATE</span>
<a name="l01016"></a>01016 <span class="preprocessor"></span>  <span class="keyword">struct </span>disk_record_list_head *head =
<a name="l01017"></a>01017       &amp;disk_record_heads[index &amp; (DISK_HTAB_SIZE - 1)];
<a name="l01018"></a>01018   <a class="code" href="structdisk__record.html">disk_record_t</a> *drec;
<a name="l01019"></a>01019   <span class="keywordtype">int</span> found = 0;
<a name="l01020"></a>01020   uint64_t taint;
<a name="l01021"></a>01021 
<a name="l01022"></a>01022   <span class="keywordflow">if</span> (offset + size &gt; 64)
<a name="l01023"></a>01023     size = 64 - offset, taint &amp;= <a class="code" href="taintcheck_8c.html#1ccca6d08d0095f0c7c74cd502c82900">size_to_taint</a>(size);   <span class="comment">//fixme:ignore the unalignment</span>
<a name="l01024"></a>01024 
<a name="l01025"></a>01025   LIST_FOREACH(drec, head, entry) {
<a name="l01026"></a>01026     <span class="keywordflow">if</span> (drec-&gt;index == index &amp;&amp; drec-&gt;bs == bs) {
<a name="l01027"></a>01027       found = 1;
<a name="l01028"></a>01028       <span class="keywordflow">break</span>;
<a name="l01029"></a>01029     }
<a name="l01030"></a>01030     <span class="keywordflow">if</span> (drec-&gt;index &gt; index)
<a name="l01031"></a>01031       <span class="keywordflow">break</span>;
<a name="l01032"></a>01032   }
<a name="l01033"></a>01033 
<a name="l01034"></a>01034   <span class="keywordflow">if</span> (!found)
<a name="l01035"></a>01035     <span class="keywordflow">return</span> 0;
<a name="l01036"></a>01036 
<a name="l01037"></a>01037   taint = (drec-&gt;bitmap &gt;&gt; offset) &amp; <a class="code" href="taintcheck_8c.html#1ccca6d08d0095f0c7c74cd502c82900">size_to_taint</a>(size);
<a name="l01038"></a>01038   <span class="keywordflow">if</span> (taint)
<a name="l01039"></a>01039     memcpy(record, drec-&gt;records + offset * <a class="code" href="TEMU__main_8c.html#a93b5270782d60adbbe1e95b3f87befd">temu_plugin</a>-&gt;<a class="code" href="structplugin__interface__t.html#cf6b2847bc302d9e0c94ca21fd81a75d" title="size of taint record for each tainted byte. TEMU sees taint record as untyped buffer...">taint_record_size</a>,
<a name="l01040"></a>01040            size * <a class="code" href="TEMU__main_8c.html#a93b5270782d60adbbe1e95b3f87befd">temu_plugin</a>-&gt;<a class="code" href="structplugin__interface__t.html#cf6b2847bc302d9e0c94ca21fd81a75d" title="size of taint record for each tainted byte. TEMU sees taint record as untyped buffer...">taint_record_size</a>);
<a name="l01041"></a>01041   <span class="keywordflow">return</span> taint;
<a name="l01042"></a>01042 <span class="preprocessor">#else</span>
<a name="l01043"></a>01043 <span class="preprocessor"></span>  <span class="keywordflow">return</span> 0;
<a name="l01044"></a>01044 <span class="preprocessor">#endif  </span>
<a name="l01045"></a>01045 <span class="preprocessor"></span>}
<a name="l01046"></a>01046 
<a name="l01047"></a>01047 
<a name="l01048"></a><a class="code" href="taintcheck_8h.html#626d73b5a37968bdb2a56e422d59e96a">01048</a> <span class="keywordtype">int</span> <a class="code" href="taintcheck_8c.html#626d73b5a37968bdb2a56e422d59e96a">taintcheck_chk_hdout</a>(<span class="keywordtype">int</span> size, int64_t sect_num, uint32_t offset,
<a name="l01049"></a>01049                          <span class="keywordtype">void</span> *s)
<a name="l01050"></a>01050 {
<a name="l01051"></a>01051 <span class="preprocessor">#ifndef NO_PROPAGATE</span>
<a name="l01052"></a>01052 <span class="preprocessor"></span>  uint8_t taint;
<a name="l01053"></a>01053   <span class="keywordtype">int</span> i, regidx = cpu_single_env-&gt;tempidx &lt;&lt; 2;
<a name="l01054"></a>01054 
<a name="l01055"></a>01055   <span class="keywordflow">if</span> (!<a class="code" href="group__main.html#gf24f155e5a9b6ee9bc9a6e6ef9c3987d" title="This flag tells if emulation mode is enabled.">TEMU_emulation_started</a>)
<a name="l01056"></a>01056     <span class="keywordflow">return</span> 0;
<a name="l01057"></a>01057 
<a name="l01058"></a>01058   taint = <a class="code" href="taintcheck_8c.html#76e98a9a904319586334f594defa87ed">taint_reg_check</a>(regidx, size);
<a name="l01059"></a>01059   <a class="code" href="taintcheck_8h.html#5f5f47ceccbe47ac9205cefd0c36db4e">taintcheck_taint_disk</a>(sect_num * 8 + offset / 64, taint, offset &amp; 63,
<a name="l01060"></a>01060                         size,
<a name="l01061"></a>01061                         <a class="code" href="taintcheck_8c.html#ba165d9e6ff6e82b3c63a9be1f6c97cc" title="taint records for registers">regs_records</a> +
<a name="l01062"></a>01062                         regidx * <a class="code" href="TEMU__main_8c.html#a93b5270782d60adbbe1e95b3f87befd">temu_plugin</a>-&gt;<a class="code" href="structplugin__interface__t.html#cf6b2847bc302d9e0c94ca21fd81a75d" title="size of taint record for each tainted byte. TEMU sees taint record as untyped buffer...">taint_record_size</a>, s);
<a name="l01063"></a>01063   <span class="keywordflow">if</span>(<a class="code" href="TEMU__main_8c.html#a93b5270782d60adbbe1e95b3f87befd">temu_plugin</a>-&gt;<a class="code" href="structplugin__interface__t.html#7f646c69e77b630c1cda6f206ca125d6">taint_disk</a>) {
<a name="l01064"></a>01064     <span class="keywordflow">for</span> (i = 0; i &lt; size; i++) {
<a name="l01065"></a>01065       <span class="keywordflow">if</span> (taint &amp; (1 &lt;&lt; i))
<a name="l01066"></a>01066         <a class="code" href="TEMU__main_8c.html#a93b5270782d60adbbe1e95b3f87befd">temu_plugin</a>-&gt;<a class="code" href="structplugin__interface__t.html#7f646c69e77b630c1cda6f206ca125d6">taint_disk</a>(sect_num * 512 + offset + i, <a class="code" href="taintcheck_8c.html#ba165d9e6ff6e82b3c63a9be1f6c97cc" title="taint records for registers">regs_records</a> +
<a name="l01067"></a>01067                               (regidx +
<a name="l01068"></a>01068                                i) * <a class="code" href="TEMU__main_8c.html#a93b5270782d60adbbe1e95b3f87befd">temu_plugin</a>-&gt;<a class="code" href="structplugin__interface__t.html#cf6b2847bc302d9e0c94ca21fd81a75d" title="size of taint record for each tainted byte. TEMU sees taint record as untyped buffer...">taint_record_size</a>,
<a name="l01069"></a>01069                               (BlockDriverState *) s);
<a name="l01070"></a>01070   }
<a name="l01071"></a>01071   }
<a name="l01072"></a>01072 <span class="preprocessor">#endif</span>
<a name="l01073"></a>01073 <span class="preprocessor"></span>  <span class="keywordflow">return</span> 0;
<a name="l01074"></a>01074 }
<a name="l01075"></a>01075 
<a name="l01076"></a><a class="code" href="taintcheck_8h.html#677efe3669f248b211360eaf631b5759">01076</a> <span class="keywordtype">int</span> <a class="code" href="taintcheck_8c.html#677efe3669f248b211360eaf631b5759">taintcheck_chk_hdin</a>(<span class="keywordtype">int</span> size, int64_t sect_num, uint32_t offset,
<a name="l01077"></a>01077                         <span class="keywordtype">void</span> *s)
<a name="l01078"></a>01078 {
<a name="l01079"></a>01079 <span class="preprocessor">#ifndef NO_PROPAGATE</span>
<a name="l01080"></a>01080 <span class="preprocessor"></span>  uint64_t taint = 0;
<a name="l01081"></a>01081   uint8_t *records;
<a name="l01082"></a>01082   <span class="keywordtype">int</span> regidx = cpu_single_env-&gt;tempidx &lt;&lt; 2;
<a name="l01083"></a>01083 
<a name="l01084"></a>01084   <span class="keywordflow">if</span> (!<a class="code" href="group__main.html#gf24f155e5a9b6ee9bc9a6e6ef9c3987d" title="This flag tells if emulation mode is enabled.">TEMU_emulation_started</a>)
<a name="l01085"></a>01085     <span class="keywordflow">return</span> 0;
<a name="l01086"></a>01086 
<a name="l01087"></a>01087   records = qemu_malloc(<a class="code" href="TEMU__main_8c.html#a93b5270782d60adbbe1e95b3f87befd">temu_plugin</a>-&gt;<a class="code" href="structplugin__interface__t.html#cf6b2847bc302d9e0c94ca21fd81a75d" title="size of taint record for each tainted byte. TEMU sees taint record as untyped buffer...">taint_record_size</a> * 4);
<a name="l01088"></a>01088   <span class="keywordflow">if</span> (!records)
<a name="l01089"></a>01089     <span class="keywordflow">return</span> 0;
<a name="l01090"></a>01090 
<a name="l01091"></a>01091   taint =
<a name="l01092"></a>01092       <a class="code" href="taintcheck_8c.html#b2ff0eb6e17b89eae75c67f0d3746f06">taintcheck_disk_check</a>(sect_num * 8 + offset / 64, offset &amp; 63, size,
<a name="l01093"></a>01093                             records, s);
<a name="l01094"></a>01094   <span class="keywordflow">if</span> (taint) {
<a name="l01095"></a>01095   <span class="keywordflow">if</span>(<a class="code" href="TEMU__main_8c.html#a93b5270782d60adbbe1e95b3f87befd">temu_plugin</a>-&gt;<a class="code" href="structplugin__interface__t.html#83d37405cce213c4766e1bfbe6f9813a">read_disk_taint</a>) {
<a name="l01096"></a>01096       <span class="keywordtype">int</span> i;
<a name="l01097"></a>01097       <span class="keywordflow">for</span> (i = 0; i &lt; size; i++) {
<a name="l01098"></a>01098         <span class="keywordflow">if</span> (taint &amp; (1 &lt;&lt; i))
<a name="l01099"></a>01099           <a class="code" href="TEMU__main_8c.html#a93b5270782d60adbbe1e95b3f87befd">temu_plugin</a>-&gt;<a class="code" href="structplugin__interface__t.html#83d37405cce213c4766e1bfbe6f9813a">read_disk_taint</a>(sect_num * 512 + offset + i,
<a name="l01100"></a>01100                                        records +
<a name="l01101"></a>01101                                        <a class="code" href="TEMU__main_8c.html#a93b5270782d60adbbe1e95b3f87befd">temu_plugin</a>-&gt;<a class="code" href="structplugin__interface__t.html#cf6b2847bc302d9e0c94ca21fd81a75d" title="size of taint record for each tainted byte. TEMU sees taint record as untyped buffer...">taint_record_size</a> * i,
<a name="l01102"></a>01102                                        s);
<a name="l01103"></a>01103       }
<a name="l01104"></a>01104     }
<a name="l01105"></a>01105     <a class="code" href="taintcheck_8c.html#5297c0dd74a0ea8ab628243ab6d6b060">taint_register</a>(regidx, size, taint);
<a name="l01106"></a>01106     memcpy(<a class="code" href="taintcheck_8c.html#ba165d9e6ff6e82b3c63a9be1f6c97cc" title="taint records for registers">regs_records</a> + regidx * <a class="code" href="TEMU__main_8c.html#a93b5270782d60adbbe1e95b3f87befd">temu_plugin</a>-&gt;<a class="code" href="structplugin__interface__t.html#cf6b2847bc302d9e0c94ca21fd81a75d" title="size of taint record for each tainted byte. TEMU sees taint record as untyped buffer...">taint_record_size</a>,
<a name="l01107"></a>01107            records, size * <a class="code" href="TEMU__main_8c.html#a93b5270782d60adbbe1e95b3f87befd">temu_plugin</a>-&gt;<a class="code" href="structplugin__interface__t.html#cf6b2847bc302d9e0c94ca21fd81a75d" title="size of taint record for each tainted byte. TEMU sees taint record as untyped buffer...">taint_record_size</a>);
<a name="l01108"></a>01108   }
<a name="l01109"></a>01109   qemu_free(records);
<a name="l01110"></a>01110 <span class="preprocessor">#endif</span>
<a name="l01111"></a>01111 <span class="preprocessor"></span>  <span class="keywordflow">return</span> 0;
<a name="l01112"></a>01112 }
<a name="l01113"></a>01113 
<a name="l01114"></a>01114 
<a name="l01115"></a><a class="code" href="taintcheck_8h.html#ad418a687204ab4e6646d4456880f16f">01115</a> <span class="keywordtype">int</span> <a class="code" href="taintcheck_8c.html#ad418a687204ab4e6646d4456880f16f">taintcheck_chk_hdwrite</a>(uint32_t paddr, <span class="keywordtype">int</span> size, int64_t sect_num,
<a name="l01116"></a>01116                            <span class="keywordtype">void</span> *s)
<a name="l01117"></a>01117 {
<a name="l01118"></a>01118 <span class="preprocessor">#ifndef NO_PROPAGATE</span>
<a name="l01119"></a>01119 <span class="preprocessor"></span>  uint32_t i, j;
<a name="l01120"></a>01120   <a class="code" href="struct__tpage__entry.html">tpage_entry_t</a> *entry;
<a name="l01121"></a>01121 
<a name="l01122"></a>01122   <span class="keywordflow">if</span> (!<a class="code" href="group__main.html#gf24f155e5a9b6ee9bc9a6e6ef9c3987d" title="This flag tells if emulation mode is enabled.">TEMU_emulation_started</a> || (paddr &amp; 63))
<a name="l01123"></a>01123     <span class="keywordflow">return</span> 0;
<a name="l01124"></a>01124   <span class="keywordflow">for</span> (i = paddr; i &lt; paddr + size; i += 64) {
<a name="l01125"></a>01125     entry = tpage_table[i &gt;&gt; 6];
<a name="l01126"></a>01126     <a class="code" href="taintcheck_8h.html#5f5f47ceccbe47ac9205cefd0c36db4e">taintcheck_taint_disk</a>(sect_num * 8 + (i - paddr) / 64,
<a name="l01127"></a>01127                           (entry) ? entry-&gt;<a class="code" href="struct__tpage__entry.html#222b55ca1f0afa174750083b33ccd275">bitmap</a> : 0, 0, 64,
<a name="l01128"></a>01128                           (entry) ? entry-&gt;<a class="code" href="struct__tpage__entry.html#5dca50c79db35c0fc6c510c7f6f3db2c">records</a> : NULL, s);
<a name="l01129"></a>01129     <span class="keywordflow">if</span> (!entry || !<a class="code" href="TEMU__main_8c.html#a93b5270782d60adbbe1e95b3f87befd">temu_plugin</a>-&gt;<a class="code" href="structplugin__interface__t.html#7f646c69e77b630c1cda6f206ca125d6">taint_disk</a>)
<a name="l01130"></a>01130       <span class="keywordflow">continue</span>;
<a name="l01131"></a>01131 
<a name="l01132"></a>01132     <span class="keywordflow">for</span> (j = 0; j &lt; 64; j++) {
<a name="l01133"></a>01133       <span class="keywordflow">if</span> (entry-&gt;<a class="code" href="struct__tpage__entry.html#222b55ca1f0afa174750083b33ccd275">bitmap</a> &amp; (1ULL &lt;&lt; j))
<a name="l01134"></a>01134         <a class="code" href="TEMU__main_8c.html#a93b5270782d60adbbe1e95b3f87befd">temu_plugin</a>-&gt;<a class="code" href="structplugin__interface__t.html#7f646c69e77b630c1cda6f206ca125d6">taint_disk</a>(sect_num * 512 + i + j - paddr,
<a name="l01135"></a>01135                                 entry-&gt;<a class="code" href="struct__tpage__entry.html#5dca50c79db35c0fc6c510c7f6f3db2c">records</a> +
<a name="l01136"></a>01136                                 j * <a class="code" href="TEMU__main_8c.html#a93b5270782d60adbbe1e95b3f87befd">temu_plugin</a>-&gt;<a class="code" href="structplugin__interface__t.html#cf6b2847bc302d9e0c94ca21fd81a75d" title="size of taint record for each tainted byte. TEMU sees taint record as untyped buffer...">taint_record_size</a>,
<a name="l01137"></a>01137                                 (BlockDriverState *) s);
<a name="l01138"></a>01138     }
<a name="l01139"></a>01139   }
<a name="l01140"></a>01140 <span class="preprocessor">#endif</span>
<a name="l01141"></a>01141 <span class="preprocessor"></span>  <span class="keywordflow">return</span> 0;
<a name="l01142"></a>01142 }
<a name="l01143"></a>01143 
<a name="l01144"></a><a class="code" href="taintcheck_8h.html#daf3a7f548545c0445833add377b03af">01144</a> <span class="keywordtype">int</span> <a class="code" href="taintcheck_8c.html#daf3a7f548545c0445833add377b03af">taintcheck_chk_hdread</a>(uint32_t paddr, <span class="keywordtype">int</span> size, int64_t sect_num,
<a name="l01145"></a>01145                           <span class="keywordtype">void</span> *s)
<a name="l01146"></a>01146 {
<a name="l01147"></a>01147 <span class="preprocessor">#ifndef NO_PROPAGATE</span>
<a name="l01148"></a>01148 <span class="preprocessor"></span>  uint32_t i, j;
<a name="l01149"></a>01149   uint64_t taint;
<a name="l01150"></a>01150   uint8_t *records;
<a name="l01151"></a>01151 
<a name="l01152"></a>01152   <span class="keywordflow">if</span> (!<a class="code" href="group__main.html#gf24f155e5a9b6ee9bc9a6e6ef9c3987d" title="This flag tells if emulation mode is enabled.">TEMU_emulation_started</a>)
<a name="l01153"></a>01153     <span class="keywordflow">return</span> 0;
<a name="l01154"></a>01154 
<a name="l01155"></a>01155   records = qemu_malloc(64 * <a class="code" href="TEMU__main_8c.html#a93b5270782d60adbbe1e95b3f87befd">temu_plugin</a>-&gt;<a class="code" href="structplugin__interface__t.html#cf6b2847bc302d9e0c94ca21fd81a75d" title="size of taint record for each tainted byte. TEMU sees taint record as untyped buffer...">taint_record_size</a>);
<a name="l01156"></a>01156   <span class="keywordflow">if</span> (!records)
<a name="l01157"></a>01157     <span class="keywordflow">return</span> 0;
<a name="l01158"></a>01158 
<a name="l01159"></a>01159   <span class="keywordflow">for</span> (i = paddr; i &lt; paddr + size; i += 64) {
<a name="l01160"></a>01160     taint =
<a name="l01161"></a>01161         <a class="code" href="taintcheck_8c.html#b2ff0eb6e17b89eae75c67f0d3746f06">taintcheck_disk_check</a>(sect_num * 8 + (i - paddr) / 64, 0, 64,
<a name="l01162"></a>01162                               records, s);
<a name="l01163"></a>01163     <span class="keywordflow">if</span> (!taint)
<a name="l01164"></a>01164       <span class="keywordflow">continue</span>;
<a name="l01165"></a>01165     <a class="code" href="taintcheck_8c.html#9282ff4d76a2b38f3cbc23e3991e6311">taint_memory</a>(i, 64, taint);
<a name="l01166"></a>01166     memcpy(tpage_table[i &gt;&gt; 6]-&gt;records, records,
<a name="l01167"></a>01167            64 * <a class="code" href="TEMU__main_8c.html#a93b5270782d60adbbe1e95b3f87befd">temu_plugin</a>-&gt;<a class="code" href="structplugin__interface__t.html#cf6b2847bc302d9e0c94ca21fd81a75d" title="size of taint record for each tainted byte. TEMU sees taint record as untyped buffer...">taint_record_size</a>);
<a name="l01168"></a>01168 
<a name="l01169"></a>01169     <span class="keywordflow">if</span> (!<a class="code" href="TEMU__main_8c.html#a93b5270782d60adbbe1e95b3f87befd">temu_plugin</a>-&gt;<a class="code" href="structplugin__interface__t.html#83d37405cce213c4766e1bfbe6f9813a">read_disk_taint</a>)
<a name="l01170"></a>01170       <span class="keywordflow">continue</span>;
<a name="l01171"></a>01171 
<a name="l01172"></a>01172     <span class="keywordflow">for</span> (j = 0; j &lt; 64; j++) {
<a name="l01173"></a>01173       <span class="keywordflow">if</span> (taint &amp; (1ULL &lt;&lt; j))
<a name="l01174"></a>01174         <a class="code" href="TEMU__main_8c.html#a93b5270782d60adbbe1e95b3f87befd">temu_plugin</a>-&gt;<a class="code" href="structplugin__interface__t.html#83d37405cce213c4766e1bfbe6f9813a">read_disk_taint</a>(sect_num * 512 + (i - paddr) + j,
<a name="l01175"></a>01175                                      records +
<a name="l01176"></a>01176                                      <a class="code" href="TEMU__main_8c.html#a93b5270782d60adbbe1e95b3f87befd">temu_plugin</a>-&gt;<a class="code" href="structplugin__interface__t.html#cf6b2847bc302d9e0c94ca21fd81a75d" title="size of taint record for each tainted byte. TEMU sees taint record as untyped buffer...">taint_record_size</a> * j,
<a name="l01177"></a>01177                                      s);
<a name="l01178"></a>01178     }
<a name="l01179"></a>01179   }
<a name="l01180"></a>01180   qemu_free(records);
<a name="l01181"></a>01181 <span class="preprocessor">#endif</span>
<a name="l01182"></a>01182 <span class="preprocessor"></span>  <span class="keywordflow">return</span> 0;
<a name="l01183"></a>01183 }
<a name="l01184"></a>01184 
<a name="l01185"></a>01185 
<a name="l01186"></a><a class="code" href="group__taintcheck.html#g86f8d5bb5b48c331c5ccca6615271508">01186</a> <span class="keywordtype">int</span> <a class="code" href="group__taintcheck.html#g86f8d5bb5b48c331c5ccca6615271508">taintcheck_get_sizeof_taintmem</a>()
<a name="l01187"></a>01187 {
<a name="l01188"></a>01188   <span class="keywordtype">int</span> i, j, size = 0;
<a name="l01189"></a>01189 
<a name="l01190"></a>01190   <span class="keywordflow">for</span> (i = 0; i &lt; ram_size / 64; i++)
<a name="l01191"></a>01191     <span class="keywordflow">if</span> (tpage_table[i]) {
<a name="l01192"></a>01192       <span class="keywordflow">for</span> (j = 0; j &lt; 64; j++)
<a name="l01193"></a>01193         <span class="keywordflow">if</span> ((1ULL &lt;&lt; j) &amp; tpage_table[i]-&gt;<a class="code" href="structdisk__record.html#32996293ceaeea3aeebf60ea925f8175">bitmap</a>)
<a name="l01194"></a>01194           size++;
<a name="l01195"></a>01195     }
<a name="l01196"></a>01196   <span class="keywordflow">return</span> size;
<a name="l01197"></a>01197 }
<a name="l01198"></a>01198 
<a name="l01199"></a>01199 
<a name="l01200"></a><a class="code" href="taintcheck_8h.html#4118f65532fb56172df951567d1c6b1d">01200</a> <span class="keywordtype">void</span> <a class="code" href="taintcheck_8c.html#4118f65532fb56172df951567d1c6b1d">taintcheck_clean_memreg</a>()
<a name="l01201"></a>01201 {
<a name="l01202"></a>01202   <span class="keywordtype">int</span> i;
<a name="l01203"></a>01203   <a class="code" href="taintcheck_8c.html#5efcc8557acedd802898b6be6e743c77" title="bitmap for registers">regs_bitmap</a> = 0;
<a name="l01204"></a>01204   <span class="keywordflow">for</span> (i = 0; i &lt; ram_size / 64; i++)
<a name="l01205"></a>01205     <span class="keywordflow">if</span> (tpage_table[i]) {
<a name="l01206"></a>01206       qemu_free(tpage_table[i]);
<a name="l01207"></a>01207       tpage_table[i] = 0;
<a name="l01208"></a>01208     }
<a name="l01209"></a>01209 }
<a name="l01210"></a>01210 
<a name="l01211"></a>01211 
<a name="l01212"></a>01212 
<a name="l01213"></a><a class="code" href="taintcheck_8h.html#b5064a6e48ffaa64eb25603e21feae88">01213</a> <span class="keywordtype">int</span> <a class="code" href="taintcheck_8c.html#b5064a6e48ffaa64eb25603e21feae88">taintcheck_nic_writebuf</a>(uint32_t addr, <span class="keywordtype">int</span> size, uint64_t <a class="code" href="structdisk__record.html#32996293ceaeea3aeebf60ea925f8175">bitmap</a>, uint8_t * records)        <span class="comment">//size&lt;=64</span>
<a name="l01214"></a>01214 {
<a name="l01215"></a>01215   <span class="keywordtype">int</span> size1 = size, size2 = 0, <a class="code" href="structdisk__record.html#46687f5b8517d581376fe61ce771ee67">index</a>, offset;
<a name="l01216"></a>01216 
<a name="l01217"></a>01217   <span class="keywordflow">if</span> (!<a class="code" href="group__main.html#gf24f155e5a9b6ee9bc9a6e6ef9c3987d" title="This flag tells if emulation mode is enabled.">TEMU_emulation_started</a> || addr &gt;= 32 * 1024)
<a name="l01218"></a>01218     <span class="keywordflow">return</span> 0;
<a name="l01219"></a>01219 
<a name="l01220"></a>01220   <a class="code" href="structdisk__record.html#46687f5b8517d581376fe61ce771ee67">index</a> = addr &gt;&gt; 6, offset = addr &amp; 63;
<a name="l01221"></a>01221   <span class="keywordflow">if</span> (offset + size &gt; 64) {
<a name="l01222"></a>01222     size2 = offset + size - 64;
<a name="l01223"></a>01223     size1 = 64 - offset;
<a name="l01224"></a>01224   }
<a name="l01225"></a>01225   <a class="code" href="taintcheck_8c.html#327231a22ed182c09b21712588339ef5" title="bitmap for nic">nic_bitmap</a>[<a class="code" href="structdisk__record.html#46687f5b8517d581376fe61ce771ee67">index</a>] &amp;= ~(((1ULL &lt;&lt; size1) - 1) &lt;&lt; offset);
<a name="l01226"></a>01226   <a class="code" href="taintcheck_8c.html#327231a22ed182c09b21712588339ef5" title="bitmap for nic">nic_bitmap</a>[<a class="code" href="structdisk__record.html#46687f5b8517d581376fe61ce771ee67">index</a>] |= (bitmap &amp; <a class="code" href="taintcheck_8c.html#1ccca6d08d0095f0c7c74cd502c82900">size_to_taint</a>(size1)) &lt;&lt; offset;
<a name="l01227"></a>01227   <span class="keywordflow">if</span> (size2) {
<a name="l01228"></a>01228     <a class="code" href="taintcheck_8c.html#327231a22ed182c09b21712588339ef5" title="bitmap for nic">nic_bitmap</a>[<a class="code" href="structdisk__record.html#46687f5b8517d581376fe61ce771ee67">index</a> + 1] &amp;= ~<a class="code" href="taintcheck_8c.html#1ccca6d08d0095f0c7c74cd502c82900">size_to_taint</a>(size2);
<a name="l01229"></a>01229     <a class="code" href="taintcheck_8c.html#327231a22ed182c09b21712588339ef5" title="bitmap for nic">nic_bitmap</a>[<a class="code" href="structdisk__record.html#46687f5b8517d581376fe61ce771ee67">index</a> + 1] |= bitmap &gt;&gt; size1;
<a name="l01230"></a>01230   }
<a name="l01231"></a>01231 
<a name="l01232"></a>01232   <span class="keywordflow">if</span> (bitmap)
<a name="l01233"></a>01233     memcpy(<a class="code" href="taintcheck_8c.html#e5345edd4e3618ea3fd53a7b8f46e832" title="taint records for nic">nic_records</a> + addr * <a class="code" href="TEMU__main_8c.html#a93b5270782d60adbbe1e95b3f87befd">temu_plugin</a>-&gt;<a class="code" href="structplugin__interface__t.html#cf6b2847bc302d9e0c94ca21fd81a75d" title="size of taint record for each tainted byte. TEMU sees taint record as untyped buffer...">taint_record_size</a>,
<a name="l01234"></a>01234            records, size * <a class="code" href="TEMU__main_8c.html#a93b5270782d60adbbe1e95b3f87befd">temu_plugin</a>-&gt;<a class="code" href="structplugin__interface__t.html#cf6b2847bc302d9e0c94ca21fd81a75d" title="size of taint record for each tainted byte. TEMU sees taint record as untyped buffer...">taint_record_size</a>);
<a name="l01235"></a>01235   <span class="keywordflow">return</span> 0;
<a name="l01236"></a>01236 }
<a name="l01237"></a>01237 
<a name="l01238"></a><a class="code" href="taintcheck_8h.html#05f4508d29963866cc3d29d039375a48">01238</a> uint64_t <a class="code" href="taintcheck_8c.html#05f4508d29963866cc3d29d039375a48">taintcheck_nic_readbuf</a>(uint32_t addr, <span class="keywordtype">int</span> size, uint8_t * records)     <span class="comment">//size&lt;=64</span>
<a name="l01239"></a>01239 {
<a name="l01240"></a>01240   <span class="keywordtype">int</span> size1 = size, size2 = 0, <a class="code" href="structdisk__record.html#46687f5b8517d581376fe61ce771ee67">index</a>, offset;
<a name="l01241"></a>01241   uint64_t taint;
<a name="l01242"></a>01242 
<a name="l01243"></a>01243   <span class="keywordflow">if</span> (!<a class="code" href="group__main.html#gf24f155e5a9b6ee9bc9a6e6ef9c3987d" title="This flag tells if emulation mode is enabled.">TEMU_emulation_started</a> || addr &gt;= 32 * 1024)
<a name="l01244"></a>01244     <span class="keywordflow">return</span> 0;
<a name="l01245"></a>01245 
<a name="l01246"></a>01246   <a class="code" href="structdisk__record.html#46687f5b8517d581376fe61ce771ee67">index</a> = addr &gt;&gt; 6, offset = addr &amp; 63;
<a name="l01247"></a>01247   <span class="keywordflow">if</span> (offset + size &gt; 64) {
<a name="l01248"></a>01248     size2 = offset + size - 64;
<a name="l01249"></a>01249     size1 = 64 - offset;
<a name="l01250"></a>01250   }
<a name="l01251"></a>01251   taint = (<a class="code" href="taintcheck_8c.html#327231a22ed182c09b21712588339ef5" title="bitmap for nic">nic_bitmap</a>[<a class="code" href="structdisk__record.html#46687f5b8517d581376fe61ce771ee67">index</a>] &gt;&gt; offset) &amp; <a class="code" href="taintcheck_8c.html#1ccca6d08d0095f0c7c74cd502c82900">size_to_taint</a>(size1);
<a name="l01252"></a>01252   <span class="keywordflow">if</span> (size2) {
<a name="l01253"></a>01253     taint |= (<a class="code" href="taintcheck_8c.html#327231a22ed182c09b21712588339ef5" title="bitmap for nic">nic_bitmap</a>[<a class="code" href="structdisk__record.html#46687f5b8517d581376fe61ce771ee67">index</a> + 1] &amp; <a class="code" href="taintcheck_8c.html#1ccca6d08d0095f0c7c74cd502c82900">size_to_taint</a>(size2)) &lt;&lt; offset;
<a name="l01254"></a>01254   }
<a name="l01255"></a>01255 
<a name="l01256"></a>01256   <span class="keywordflow">if</span> (taint)
<a name="l01257"></a>01257     memcpy(records, <a class="code" href="taintcheck_8c.html#e5345edd4e3618ea3fd53a7b8f46e832" title="taint records for nic">nic_records</a> + addr * <a class="code" href="TEMU__main_8c.html#a93b5270782d60adbbe1e95b3f87befd">temu_plugin</a>-&gt;<a class="code" href="structplugin__interface__t.html#cf6b2847bc302d9e0c94ca21fd81a75d" title="size of taint record for each tainted byte. TEMU sees taint record as untyped buffer...">taint_record_size</a>,
<a name="l01258"></a>01258            size * <a class="code" href="TEMU__main_8c.html#a93b5270782d60adbbe1e95b3f87befd">temu_plugin</a>-&gt;<a class="code" href="structplugin__interface__t.html#cf6b2847bc302d9e0c94ca21fd81a75d" title="size of taint record for each tainted byte. TEMU sees taint record as untyped buffer...">taint_record_size</a>);
<a name="l01259"></a>01259   <span class="keywordflow">return</span> taint;
<a name="l01260"></a>01260 }
<a name="l01261"></a>01261 
<a name="l01262"></a>01262 
<a name="l01263"></a><a class="code" href="taintcheck_8h.html#d74f45680a8cdbbbcda8e8091b47ffa4">01263</a> <span class="keywordtype">int</span> <a class="code" href="taintcheck_8c.html#d74f45680a8cdbbbcda8e8091b47ffa4">taintcheck_nic_out</a>(uint32_t addr, <span class="keywordtype">int</span> size)
<a name="l01264"></a>01264 {
<a name="l01265"></a>01265   uint64_t taint;
<a name="l01266"></a>01266 
<a name="l01267"></a>01267   taint = <a class="code" href="taintcheck_8c.html#76e98a9a904319586334f594defa87ed">taint_reg_check</a>(cpu_single_env-&gt;tempidx &lt;&lt; 2, size);
<a name="l01268"></a>01268   <a class="code" href="taintcheck_8c.html#b5064a6e48ffaa64eb25603e21feae88">taintcheck_nic_writebuf</a>(addr, size, taint, <a class="code" href="taintcheck_8c.html#ba165d9e6ff6e82b3c63a9be1f6c97cc" title="taint records for registers">regs_records</a> +
<a name="l01269"></a>01269                           cpu_single_env-&gt;tempidx * 4 *
<a name="l01270"></a>01270                           <a class="code" href="TEMU__main_8c.html#a93b5270782d60adbbe1e95b3f87befd">temu_plugin</a>-&gt;<a class="code" href="structplugin__interface__t.html#cf6b2847bc302d9e0c94ca21fd81a75d" title="size of taint record for each tainted byte. TEMU sees taint record as untyped buffer...">taint_record_size</a>);
<a name="l01271"></a>01271   <span class="keywordflow">return</span> 0;
<a name="l01272"></a>01272 }
<a name="l01273"></a>01273 
<a name="l01274"></a>01274 
<a name="l01275"></a><a class="code" href="taintcheck_8h.html#0ca6e469e6089275de877c25bbcce5fa">01275</a> <span class="keywordtype">int</span> <a class="code" href="taintcheck_8c.html#0ca6e469e6089275de877c25bbcce5fa">taintcheck_nic_in</a>(uint32_t addr, <span class="keywordtype">int</span> size)
<a name="l01276"></a>01276 {
<a name="l01277"></a>01277   <span class="keywordtype">char</span> * records = qemu_malloc(<a class="code" href="TEMU__main_8c.html#a93b5270782d60adbbe1e95b3f87befd">temu_plugin</a>-&gt;<a class="code" href="structplugin__interface__t.html#cf6b2847bc302d9e0c94ca21fd81a75d" title="size of taint record for each tainted byte. TEMU sees taint record as untyped buffer...">taint_record_size</a> * size);
<a name="l01278"></a>01278   <span class="keywordflow">if</span>(records) {
<a name="l01279"></a>01279   uint64_t taint = <a class="code" href="taintcheck_8c.html#05f4508d29963866cc3d29d039375a48">taintcheck_nic_readbuf</a>(addr, size, records);
<a name="l01280"></a>01280   <a class="code" href="group__taintcheck.html#g7894a326e5a09f08e92471e50d687545">taintcheck_taint_register</a>(cpu_single_env-&gt;tempidx, 0, size, taint, records);
<a name="l01281"></a>01281   qemu_free(records);
<a name="l01282"></a>01282   }
<a name="l01283"></a>01283   <span class="keywordflow">return</span> 0;
<a name="l01284"></a>01284 }
<a name="l01285"></a>01285 
<a name="l01286"></a>01286 
<a name="l01287"></a><a class="code" href="taintcheck_8h.html#7ac2451c3e8027112d395416a0b65f3f">01287</a> <span class="keywordtype">int</span> <a class="code" href="taintcheck_8c.html#7ac2451c3e8027112d395416a0b65f3f">taintcheck_patch</a>()          <span class="comment">//patch for keystroke propagation on Windows XP sp2</span>
<a name="l01288"></a>01288 {
<a name="l01289"></a>01289 <span class="preprocessor">#ifndef NO_PROPAGATE</span>
<a name="l01290"></a>01290 <span class="preprocessor"></span>  <span class="keywordflow">if</span> (cpu_single_env-&gt;eip != 0xbf8a4bde &amp;&amp;
<a name="l01291"></a>01291       cpu_single_env-&gt;eip != 0xbf84a74f)
<a name="l01292"></a>01292     <span class="keywordflow">return</span> 0;
<a name="l01293"></a>01293   
<a name="l01294"></a>01294   <span class="keywordflow">if</span>(!<a class="code" href="group__main.html#gf24f155e5a9b6ee9bc9a6e6ef9c3987d" title="This flag tells if emulation mode is enabled.">TEMU_emulation_started</a>) <span class="keywordflow">return</span> 0;
<a name="l01295"></a>01295 
<a name="l01296"></a>01296   uint32_t phys_addr, addr, addr2, phys_addr2;
<a name="l01297"></a>01297   addr = cpu_single_env-&gt;regs[R_EBP] + 8;
<a name="l01298"></a>01298   phys_addr = <a class="code" href="group__main.html#g83dc2500423a7496ae08e0a9e67ab55c" title="Convert virtual address into physical address.">TEMU_get_phys_addr</a>(addr);
<a name="l01299"></a>01299   <span class="keywordflow">if</span> (phys_addr == -1)
<a name="l01300"></a>01300     <span class="keywordflow">return</span> 0;
<a name="l01301"></a>01301 
<a name="l01302"></a>01302   <span class="keywordflow">if</span> (!<a class="code" href="taintcheck_8c.html#7ded7aac43f68faa84aaf843c2986afa">taint_mem_check</a>(phys_addr, 1))
<a name="l01303"></a>01303     <span class="keywordflow">return</span> 0;
<a name="l01304"></a>01304 
<a name="l01305"></a>01305   addr2 = cpu_single_env-&gt;regs[R_EBP] + 0x14;
<a name="l01306"></a>01306   <span class="keywordflow">if</span> (<a class="code" href="group__main.html#gb9b50db6a07dd2a391ce72501ebdb0e1" title="Read from a memory region by its virtual address.">TEMU_read_mem</a>(addr2, 4,  &amp;addr2) &gt;= 0 &amp;&amp; 
<a name="l01307"></a>01307       (phys_addr2 = <a class="code" href="group__main.html#g83dc2500423a7496ae08e0a9e67ab55c" title="Convert virtual address into physical address.">TEMU_get_phys_addr</a>(addr2)) != -1) {
<a name="l01308"></a>01308     taintcheck_mem2reg_nolookup(phys_addr, addr, 1, R_T0 * 4);
<a name="l01309"></a>01309     <a class="code" href="taintcheck_8h.html#23e63eea3b9485175199ba007ad7d7ce">taintcheck_reg2mem</a>(R_T0 * 4, 1, phys_ram_base + phys_addr2);
<a name="l01310"></a>01310   }
<a name="l01311"></a>01311 <span class="preprocessor">#endif</span>
<a name="l01312"></a>01312 <span class="preprocessor"></span>  <span class="keywordflow">return</span> 0;
<a name="l01313"></a>01313 }
<a name="l01314"></a>01314 
<a name="l01315"></a>01315 
<a name="l01316"></a><a class="code" href="group__taintcheck.html#g56605b051602c77c4f9edd6651589b19">01316</a> uint64_t <a class="code" href="group__taintcheck.html#g56605b051602c77c4f9edd6651589b19">taintcheck_memory_check</a>(uint32_t addr, <span class="keywordtype">int</span> size,
<a name="l01317"></a>01317                                  uint8_t * records)
<a name="l01318"></a>01318 {
<a name="l01319"></a>01319   uint64_t taint;
<a name="l01320"></a>01320   <span class="keywordtype">int</span> len, len2;
<a name="l01321"></a>01321   uint32_t offset = addr &amp; 63;
<a name="l01322"></a>01322   <a class="code" href="struct__tpage__entry.html">tpage_entry_t</a> *entry;
<a name="l01323"></a>01323 
<a name="l01324"></a>01324   <span class="keywordflow">if</span> (!<a class="code" href="group__main.html#gf24f155e5a9b6ee9bc9a6e6ef9c3987d" title="This flag tells if emulation mode is enabled.">TEMU_emulation_started</a> || addr &gt;= ram_size)
<a name="l01325"></a>01325     <span class="keywordflow">return</span> 0;
<a name="l01326"></a>01326   <span class="keywordflow">if</span> (!(taint = <a class="code" href="taintcheck_8c.html#7ded7aac43f68faa84aaf843c2986afa">taint_mem_check</a>(addr, size)))
<a name="l01327"></a>01327     <span class="keywordflow">return</span> 0;
<a name="l01328"></a>01328 
<a name="l01329"></a>01329   <span class="keywordflow">if</span> (!records)
<a name="l01330"></a>01330     <span class="keywordflow">return</span> taint;
<a name="l01331"></a>01331 
<a name="l01332"></a>01332   len = min(64 - offset, size);
<a name="l01333"></a>01333   <span class="keywordflow">if</span> ((entry = tpage_table[addr &gt;&gt; 6]))
<a name="l01334"></a>01334     memcpy(records,
<a name="l01335"></a>01335            entry-&gt;<a class="code" href="struct__tpage__entry.html#5dca50c79db35c0fc6c510c7f6f3db2c">records</a> + offset * <a class="code" href="TEMU__main_8c.html#a93b5270782d60adbbe1e95b3f87befd">temu_plugin</a>-&gt;<a class="code" href="structplugin__interface__t.html#cf6b2847bc302d9e0c94ca21fd81a75d" title="size of taint record for each tainted byte. TEMU sees taint record as untyped buffer...">taint_record_size</a>,
<a name="l01336"></a>01336            len * <a class="code" href="TEMU__main_8c.html#a93b5270782d60adbbe1e95b3f87befd">temu_plugin</a>-&gt;<a class="code" href="structplugin__interface__t.html#cf6b2847bc302d9e0c94ca21fd81a75d" title="size of taint record for each tainted byte. TEMU sees taint record as untyped buffer...">taint_record_size</a>);
<a name="l01337"></a>01337   len2 = size - len, entry = tpage_table[(addr &gt;&gt; 6) + 1];
<a name="l01338"></a>01338   <span class="keywordflow">if</span> (len2 &amp;&amp; entry)
<a name="l01339"></a>01339     memcpy(records + len * <a class="code" href="TEMU__main_8c.html#a93b5270782d60adbbe1e95b3f87befd">temu_plugin</a>-&gt;<a class="code" href="structplugin__interface__t.html#cf6b2847bc302d9e0c94ca21fd81a75d" title="size of taint record for each tainted byte. TEMU sees taint record as untyped buffer...">taint_record_size</a>,
<a name="l01340"></a>01340            entry-&gt;records, len2 * <a class="code" href="TEMU__main_8c.html#a93b5270782d60adbbe1e95b3f87befd">temu_plugin</a>-&gt;<a class="code" href="structplugin__interface__t.html#cf6b2847bc302d9e0c94ca21fd81a75d" title="size of taint record for each tainted byte. TEMU sees taint record as untyped buffer...">taint_record_size</a>);
<a name="l01341"></a>01341   <span class="keywordflow">return</span> taint;
<a name="l01342"></a>01342 }
<a name="l01343"></a>01343 
<a name="l01344"></a><a class="code" href="group__taintcheck.html#g0ead28cc21beca937d6b2fa455cf82d3">01344</a> uint64_t <a class="code" href="group__taintcheck.html#g0ead28cc21beca937d6b2fa455cf82d3">taintcheck_register_check</a>(<span class="keywordtype">int</span> reg, <span class="keywordtype">int</span> offset, <span class="keywordtype">int</span> size,
<a name="l01345"></a>01345                                    uint8_t * records)
<a name="l01346"></a>01346 {
<a name="l01347"></a>01347   uint64_t taint;
<a name="l01348"></a>01348   <span class="keywordflow">if</span> (!<a class="code" href="group__main.html#gf24f155e5a9b6ee9bc9a6e6ef9c3987d" title="This flag tells if emulation mode is enabled.">TEMU_emulation_started</a>)
<a name="l01349"></a>01349     <span class="keywordflow">return</span> 0;
<a name="l01350"></a>01350   taint = <a class="code" href="taintcheck_8c.html#76e98a9a904319586334f594defa87ed">taint_reg_check</a>((reg &lt;&lt; 2) + offset, size);
<a name="l01351"></a>01351   <span class="keywordflow">if</span> (taint &amp;&amp; records)
<a name="l01352"></a>01352     memcpy(records,
<a name="l01353"></a>01353            <a class="code" href="taintcheck_8c.html#ba165d9e6ff6e82b3c63a9be1f6c97cc" title="taint records for registers">regs_records</a> + (reg * 4 +
<a name="l01354"></a>01354                            offset) * <a class="code" href="TEMU__main_8c.html#a93b5270782d60adbbe1e95b3f87befd">temu_plugin</a>-&gt;<a class="code" href="structplugin__interface__t.html#cf6b2847bc302d9e0c94ca21fd81a75d" title="size of taint record for each tainted byte. TEMU sees taint record as untyped buffer...">taint_record_size</a>,
<a name="l01355"></a>01355            size * <a class="code" href="TEMU__main_8c.html#a93b5270782d60adbbe1e95b3f87befd">temu_plugin</a>-&gt;<a class="code" href="structplugin__interface__t.html#cf6b2847bc302d9e0c94ca21fd81a75d" title="size of taint record for each tainted byte. TEMU sees taint record as untyped buffer...">taint_record_size</a>);
<a name="l01356"></a>01356   <span class="keywordflow">return</span> taint;
<a name="l01357"></a>01357 }
<a name="l01358"></a>01358 
<a name="l01359"></a><a class="code" href="group__taintcheck.html#g7894a326e5a09f08e92471e50d687545">01359</a> <span class="keywordtype">int</span> <a class="code" href="group__taintcheck.html#g7894a326e5a09f08e92471e50d687545">taintcheck_taint_register</a>(<span class="keywordtype">int</span> reg, <span class="keywordtype">int</span> offset, <span class="keywordtype">int</span> size,
<a name="l01360"></a>01360                               uint64_t taint, uint8_t * records)
<a name="l01361"></a>01361 {
<a name="l01362"></a>01362   <span class="keywordflow">if</span> (!<a class="code" href="group__main.html#gf24f155e5a9b6ee9bc9a6e6ef9c3987d" title="This flag tells if emulation mode is enabled.">TEMU_emulation_started</a>)
<a name="l01363"></a>01363     <span class="keywordflow">return</span> 0;
<a name="l01364"></a>01364   <a class="code" href="taintcheck_8c.html#5297c0dd74a0ea8ab628243ab6d6b060">taint_register</a>((reg &lt;&lt; 2) + offset, size, taint);
<a name="l01365"></a>01365   <span class="keywordflow">if</span> (taint) {
<a name="l01366"></a>01366     memcpy(<a class="code" href="taintcheck_8c.html#ba165d9e6ff6e82b3c63a9be1f6c97cc" title="taint records for registers">regs_records</a> +
<a name="l01367"></a>01367            (reg * 4 + offset) * <a class="code" href="TEMU__main_8c.html#a93b5270782d60adbbe1e95b3f87befd">temu_plugin</a>-&gt;<a class="code" href="structplugin__interface__t.html#cf6b2847bc302d9e0c94ca21fd81a75d" title="size of taint record for each tainted byte. TEMU sees taint record as untyped buffer...">taint_record_size</a>, records,
<a name="l01368"></a>01368            size * <a class="code" href="TEMU__main_8c.html#a93b5270782d60adbbe1e95b3f87befd">temu_plugin</a>-&gt;<a class="code" href="structplugin__interface__t.html#cf6b2847bc302d9e0c94ca21fd81a75d" title="size of taint record for each tainted byte. TEMU sees taint record as untyped buffer...">taint_record_size</a>);
<a name="l01369"></a>01369   }
<a name="l01370"></a>01370   <span class="keywordflow">return</span> 0;
<a name="l01371"></a>01371 }
<a name="l01372"></a>01372 <span class="comment"></span>
<a name="l01373"></a>01373 <span class="comment">/** </span>
<a name="l01374"></a>01374 <span class="comment"> * Taint a physical memory region:</span>
<a name="l01375"></a>01375 <span class="comment"> * addr: physical address</span>
<a name="l01376"></a>01376 <span class="comment"> * size:  size of memory to taint (size &lt;= 64)</span>
<a name="l01377"></a>01377 <span class="comment"> * taint: bitmap of taint</span>
<a name="l01378"></a>01378 <span class="comment"> * records: an array of taint records</span>
<a name="l01379"></a>01379 <span class="comment"> */</span>
<a name="l01380"></a><a class="code" href="group__taintcheck.html#g5e8dea41356234a22eb960f0222fa36b">01380</a> <span class="keywordtype">int</span> <a class="code" href="group__taintcheck.html#g5e8dea41356234a22eb960f0222fa36b">taintcheck_taint_memory</a>(uint32_t addr, <span class="keywordtype">int</span> size, uint64_t taint, uint8_t * records) 
<a name="l01381"></a>01381 {
<a name="l01382"></a>01382   <a class="code" href="struct__tpage__entry.html">tpage_entry_t</a> *entry;
<a name="l01383"></a>01383   <span class="keywordtype">int</span> len, len2, offset = addr &amp; 63;
<a name="l01384"></a>01384 
<a name="l01385"></a>01385   <span class="keywordflow">if</span> (!<a class="code" href="group__main.html#gf24f155e5a9b6ee9bc9a6e6ef9c3987d" title="This flag tells if emulation mode is enabled.">TEMU_emulation_started</a> || addr &gt; ram_size)
<a name="l01386"></a>01386     <span class="keywordflow">return</span> 0;
<a name="l01387"></a>01387   <span class="keywordflow">if</span> (!taint)
<a name="l01388"></a>01388     <a class="code" href="taintcheck_8c.html#741ed09f5bd96a9e703040433fecb3af">clean_memory</a>(addr, size);
<a name="l01389"></a>01389   <span class="keywordflow">else</span> {
<a name="l01390"></a>01390     <a class="code" href="taintcheck_8c.html#9282ff4d76a2b38f3cbc23e3991e6311">taint_memory</a>(addr, size, taint);
<a name="l01391"></a>01391     len = min(64 - offset, size);
<a name="l01392"></a>01392     <span class="keywordflow">if</span> ((entry = tpage_table[addr &gt;&gt; 6])) {
<a name="l01393"></a>01393       memcpy(entry-&gt;<a class="code" href="struct__tpage__entry.html#5dca50c79db35c0fc6c510c7f6f3db2c">records</a> + offset * <a class="code" href="TEMU__main_8c.html#a93b5270782d60adbbe1e95b3f87befd">temu_plugin</a>-&gt;<a class="code" href="structplugin__interface__t.html#cf6b2847bc302d9e0c94ca21fd81a75d" title="size of taint record for each tainted byte. TEMU sees taint record as untyped buffer...">taint_record_size</a>,
<a name="l01394"></a>01394              records, len * <a class="code" href="TEMU__main_8c.html#a93b5270782d60adbbe1e95b3f87befd">temu_plugin</a>-&gt;<a class="code" href="structplugin__interface__t.html#cf6b2847bc302d9e0c94ca21fd81a75d" title="size of taint record for each tainted byte. TEMU sees taint record as untyped buffer...">taint_record_size</a>);
<a name="l01395"></a>01395     }
<a name="l01396"></a>01396     len2 = size - len, entry = tpage_table[(addr &gt;&gt; 6) + 1];
<a name="l01397"></a>01397     <span class="keywordflow">if</span> (len2 &amp;&amp; entry) {
<a name="l01398"></a>01398       memcpy(entry-&gt;records,
<a name="l01399"></a>01399              records + len * <a class="code" href="TEMU__main_8c.html#a93b5270782d60adbbe1e95b3f87befd">temu_plugin</a>-&gt;<a class="code" href="structplugin__interface__t.html#cf6b2847bc302d9e0c94ca21fd81a75d" title="size of taint record for each tainted byte. TEMU sees taint record as untyped buffer...">taint_record_size</a>,
<a name="l01400"></a>01400              len2 * <a class="code" href="TEMU__main_8c.html#a93b5270782d60adbbe1e95b3f87befd">temu_plugin</a>-&gt;<a class="code" href="structplugin__interface__t.html#cf6b2847bc302d9e0c94ca21fd81a75d" title="size of taint record for each tainted byte. TEMU sees taint record as untyped buffer...">taint_record_size</a>);
<a name="l01401"></a>01401     }
<a name="l01402"></a>01402   }
<a name="l01403"></a>01403   <span class="keywordflow">return</span> 0;
<a name="l01404"></a>01404 }
<a name="l01405"></a>01405 
<a name="l01406"></a><a class="code" href="group__taintcheck.html#ga9e5140be61392f6998239d520ff08e6">01406</a> <span class="keywordtype">void</span> <a class="code" href="group__taintcheck.html#ga9e5140be61392f6998239d520ff08e6">taintcheck_taint_virtmem</a>(uint32_t vaddr, uint32_t size, uint64_t taint, <span class="keywordtype">void</span> *records) 
<a name="l01407"></a>01407 {
<a name="l01408"></a>01408   uint32_t paddr =0, offset;
<a name="l01409"></a>01409   uint32_t size1, size2;
<a name="l01410"></a>01410   uint64_t taint1, taint2;
<a name="l01411"></a>01411   
<a name="l01412"></a>01412   paddr = <a class="code" href="group__main.html#g83dc2500423a7496ae08e0a9e67ab55c" title="Convert virtual address into physical address.">TEMU_get_phys_addr</a>(vaddr);
<a name="l01413"></a>01413   <span class="keywordflow">if</span>(paddr == -1) <span class="keywordflow">return</span>;
<a name="l01414"></a>01414 
<a name="l01415"></a>01415   offset = vaddr &amp; ~TARGET_PAGE_MASK;
<a name="l01416"></a>01416   <span class="keywordflow">if</span>(offset+size &gt; TARGET_PAGE_SIZE) {
<a name="l01417"></a>01417   size1 = TARGET_PAGE_SIZE - offset;
<a name="l01418"></a>01418   size2 = size - size1;
<a name="l01419"></a>01419   taint1 = <a class="code" href="taintcheck_8c.html#1ccca6d08d0095f0c7c74cd502c82900">size_to_taint</a>(size1) &amp; taint;
<a name="l01420"></a>01420   taint2 = taint&gt;&gt;size1;
<a name="l01421"></a>01421   } <span class="keywordflow">else</span> 
<a name="l01422"></a>01422   size1 = size, size2 = 0, taint1 = taint, taint2=0;
<a name="l01423"></a>01423   <a class="code" href="group__taintcheck.html#g5e8dea41356234a22eb960f0222fa36b">taintcheck_taint_memory</a>(paddr, size1, taint1, records);
<a name="l01424"></a>01424   <span class="keywordflow">if</span>(size2) {
<a name="l01425"></a>01425   paddr = <a class="code" href="group__main.html#g83dc2500423a7496ae08e0a9e67ab55c" title="Convert virtual address into physical address.">TEMU_get_phys_addr</a>((vaddr&amp;TARGET_PAGE_MASK)+TARGET_PAGE_SIZE);
<a name="l01426"></a>01426   <span class="keywordflow">if</span>(paddr != -1)
<a name="l01427"></a>01427     <a class="code" href="group__taintcheck.html#g5e8dea41356234a22eb960f0222fa36b">taintcheck_taint_memory</a>(paddr, size2, taint2, 
<a name="l01428"></a>01428         records + size1*<a class="code" href="TEMU__main_8c.html#a93b5270782d60adbbe1e95b3f87befd">temu_plugin</a>-&gt;<a class="code" href="structplugin__interface__t.html#cf6b2847bc302d9e0c94ca21fd81a75d" title="size of taint record for each tainted byte. TEMU sees taint record as untyped buffer...">taint_record_size</a>);
<a name="l01429"></a>01429   }
<a name="l01430"></a>01430 }
<a name="l01431"></a>01431 
<a name="l01432"></a><a class="code" href="group__taintcheck.html#gdb1d430fedd4df70a6329c4101309da7">01432</a> uint64_t <a class="code" href="group__taintcheck.html#gdb1d430fedd4df70a6329c4101309da7">taintcheck_check_virtmem</a>(uint32_t vaddr, uint32_t size, <span class="keywordtype">void</span> *records) 
<a name="l01433"></a>01433 {
<a name="l01434"></a>01434   uint64_t ret  = 0;
<a name="l01435"></a>01435   uint32_t paddr = 0, offset;
<a name="l01436"></a>01436   uint32_t size1, size2;
<a name="l01437"></a>01437   
<a name="l01438"></a>01438   paddr = <a class="code" href="group__main.html#g83dc2500423a7496ae08e0a9e67ab55c" title="Convert virtual address into physical address.">TEMU_get_phys_addr</a>(vaddr);
<a name="l01439"></a>01439   <span class="keywordflow">if</span>(paddr == -1) <span class="keywordflow">return</span> 0;
<a name="l01440"></a>01440 
<a name="l01441"></a>01441   offset = vaddr&amp; ~TARGET_PAGE_MASK;
<a name="l01442"></a>01442   <span class="keywordflow">if</span>(offset+size &gt; TARGET_PAGE_SIZE) {
<a name="l01443"></a>01443   size1 = TARGET_PAGE_SIZE-offset;
<a name="l01444"></a>01444   size2 = size -size1;
<a name="l01445"></a>01445   } <span class="keywordflow">else</span> 
<a name="l01446"></a>01446   size1 = size, size2 = 0;
<a name="l01447"></a>01447 
<a name="l01448"></a>01448   ret = <a class="code" href="group__taintcheck.html#g56605b051602c77c4f9edd6651589b19">taintcheck_memory_check</a>(paddr, size1, records);
<a name="l01449"></a>01449   <span class="keywordflow">if</span>(size2) {
<a name="l01450"></a>01450   paddr = <a class="code" href="group__main.html#g83dc2500423a7496ae08e0a9e67ab55c" title="Convert virtual address into physical address.">TEMU_get_phys_addr</a>((vaddr&amp;TARGET_PAGE_MASK)+TARGET_PAGE_SIZE);
<a name="l01451"></a>01451   <span class="keywordflow">if</span>(paddr != -1)
<a name="l01452"></a>01452     ret |= <a class="code" href="group__taintcheck.html#g56605b051602c77c4f9edd6651589b19">taintcheck_memory_check</a>(paddr,size2, 
<a name="l01453"></a>01453         (uint8_t *)records+size1*<a class="code" href="TEMU__main_8c.html#a93b5270782d60adbbe1e95b3f87befd">temu_plugin</a>-&gt;<a class="code" href="structplugin__interface__t.html#cf6b2847bc302d9e0c94ca21fd81a75d" title="size of taint record for each tainted byte. TEMU sees taint record as untyped buffer...">taint_record_size</a>)&lt;&lt;size1;
<a name="l01454"></a>01454   }
<a name="l01455"></a>01455 
<a name="l01456"></a>01456   <span class="keywordflow">return</span> ret;
<a name="l01457"></a>01457 }
<a name="l01458"></a>01458 
<a name="l01459"></a>01459 
<a name="l01460"></a>01460 
<a name="l01461"></a><a class="code" href="taintcheck_8h.html#5af93eb5e725f12919c6c698c8f2fcbe">01461</a> <span class="keywordtype">int</span> <a class="code" href="taintcheck_8c.html#5af93eb5e725f12919c6c698c8f2fcbe">taintcheck_jnz_T0_label</a>()
<a name="l01462"></a>01462 {
<a name="l01463"></a>01463   <span class="keywordtype">int</span> res = 0;
<a name="l01464"></a>01464   <span class="keywordflow">if</span> (!<a class="code" href="group__main.html#gf24f155e5a9b6ee9bc9a6e6ef9c3987d" title="This flag tells if emulation mode is enabled.">TEMU_emulation_started</a> || !<a class="code" href="TEMU__main_8c.html#6cce2e5fe1f6c5ef2fe46e72e9d279c7" title="this flag indicates whether the plugin should receive callback">should_monitor</a>)
<a name="l01465"></a>01465     <span class="keywordflow">return</span> 0;
<a name="l01466"></a>01466 
<a name="l01467"></a>01467   <span class="keywordflow">if</span> (<a class="code" href="taintcheck_8c.html#76e98a9a904319586334f594defa87ed">taint_reg_check</a>(R_CC_SRC * 4, 8) &amp;&amp; <a class="code" href="TEMU__main_8c.html#a93b5270782d60adbbe1e95b3f87befd">temu_plugin</a> &amp;&amp; <a class="code" href="TEMU__main_8c.html#a93b5270782d60adbbe1e95b3f87befd">temu_plugin</a>-&gt;<a class="code" href="structplugin__interface__t.html#1435a522c62938a9b98a3ba7b10cfb2d">cjmp</a>) {
<a name="l01468"></a>01468   <a class="code" href="taintcheck_8c.html#8ba4dce789e7fe78985beb63f5f0f01a" title="flag that indicates if the current instruction propagates taint">insn_tainted</a> = 1; <span class="comment">//set it to indicate cjmp propagating taint</span>
<a name="l01469"></a>01469     res = <a class="code" href="TEMU__main_8c.html#a93b5270782d60adbbe1e95b3f87befd">temu_plugin</a>-&gt;<a class="code" href="structplugin__interface__t.html#1435a522c62938a9b98a3ba7b10cfb2d">cjmp</a>(cpu_single_env-&gt;regs[R_T0]);
<a name="l01470"></a>01470     <span class="comment">/* res = 1 or 2 */</span>
<a name="l01471"></a>01471     <a class="code" href="taintcheck_8c.html#974495ac1261e65922b3590a970613a6">clean_register</a>(R_CC_SRC * 4, 8);
<a name="l01472"></a>01472     <span class="comment">//if(jcc_inv) res ^= 3;</span>
<a name="l01473"></a>01473   }
<a name="l01474"></a>01474   <span class="keywordflow">return</span> res;
<a name="l01475"></a>01475 }
<a name="l01476"></a>01476 
<a name="l01477"></a><a class="code" href="taintcheck_8h.html#8ec174aa929ff34f9808c14a60120904">01477</a> <span class="keywordtype">int</span> <a class="code" href="taintcheck_8c.html#8ec174aa929ff34f9808c14a60120904">taintcheck_check_eip</a>(uint32_t reg)
<a name="l01478"></a>01478 {
<a name="l01479"></a>01479 <span class="preprocessor">#ifdef DEFINE_EIP_TAINTED</span>
<a name="l01480"></a>01480 <span class="preprocessor"></span>  uint8_t taint;
<a name="l01481"></a>01481   <span class="keywordflow">if</span> (!<a class="code" href="group__main.html#gf24f155e5a9b6ee9bc9a6e6ef9c3987d" title="This flag tells if emulation mode is enabled.">TEMU_emulation_started</a> || !<a class="code" href="TEMU__main_8c.html#6cce2e5fe1f6c5ef2fe46e72e9d279c7" title="this flag indicates whether the plugin should receive callback">should_monitor</a>
<a name="l01482"></a>01482       || !(taint = <a class="code" href="taintcheck_8c.html#76e98a9a904319586334f594defa87ed">taint_reg_check</a>(R_T0 * 4, 4))
<a name="l01483"></a>01483       || !<a class="code" href="TEMU__main_8c.html#a93b5270782d60adbbe1e95b3f87befd">temu_plugin</a>-&gt;<a class="code" href="structplugin__interface__t.html#9121b74277d2d4bff2042f16462f7eec">eip_tainted</a>)
<a name="l01484"></a>01484     <span class="keywordflow">return</span> 0;
<a name="l01485"></a>01485 
<a name="l01486"></a>01486   <span class="keywordtype">int</span> i;
<a name="l01487"></a>01487   <span class="keywordflow">for</span> (i = 0; i &lt; 4; i++)
<a name="l01488"></a>01488     <span class="keywordflow">if</span> (taint &amp; (1 &lt;&lt; i)) {
<a name="l01489"></a>01489       <a class="code" href="TEMU__main_8c.html#a93b5270782d60adbbe1e95b3f87befd">temu_plugin</a>-&gt;<a class="code" href="structplugin__interface__t.html#9121b74277d2d4bff2042f16462f7eec">eip_tainted</a>(<a class="code" href="taintcheck_8c.html#ba165d9e6ff6e82b3c63a9be1f6c97cc" title="taint records for registers">regs_records</a> +
<a name="l01490"></a>01490                                (R_T0 * 4 +
<a name="l01491"></a>01491                                 i) * <a class="code" href="TEMU__main_8c.html#a93b5270782d60adbbe1e95b3f87befd">temu_plugin</a>-&gt;<a class="code" href="structplugin__interface__t.html#cf6b2847bc302d9e0c94ca21fd81a75d" title="size of taint record for each tainted byte. TEMU sees taint record as untyped buffer...">taint_record_size</a>);
<a name="l01492"></a>01492       <span class="keywordflow">break</span>;
<a name="l01493"></a>01493     }
<a name="l01494"></a>01494 <span class="preprocessor">#endif</span>
<a name="l01495"></a>01495 <span class="preprocessor"></span><span class="preprocessor">#ifdef DEFINE_MEMREG_EIP_CHANGE</span>
<a name="l01496"></a>01496 <span class="preprocessor"></span>  uint8_t taint;
<a name="l01497"></a>01497   <span class="keywordflow">if</span> (!<a class="code" href="group__main.html#gf24f155e5a9b6ee9bc9a6e6ef9c3987d" title="This flag tells if emulation mode is enabled.">TEMU_emulation_started</a> || !<a class="code" href="TEMU__main_8c.html#6cce2e5fe1f6c5ef2fe46e72e9d279c7" title="this flag indicates whether the plugin should receive callback">should_monitor</a>)
<a name="l01498"></a>01498     <span class="keywordflow">return</span> 0;
<a name="l01499"></a>01499 
<a name="l01500"></a>01500   <a class="code" href="TEMU__main_8c.html#a93b5270782d60adbbe1e95b3f87befd">temu_plugin</a>-&gt;<a class="code" href="structplugin__interface__t.html#738038bc4fd5a2ab5399a878886a6e63">memreg_eip_change</a>();
<a name="l01501"></a>01501 
<a name="l01502"></a>01502 <span class="preprocessor">#endif</span>
<a name="l01503"></a>01503 <span class="preprocessor"></span> 
<a name="l01504"></a>01504   <span class="keywordflow">return</span> 0;
<a name="l01505"></a>01505 }
<a name="l01506"></a>01506 
<a name="l01507"></a>01507 
<a name="l01508"></a><a class="code" href="taintcheck_8c.html#ae92e45e8ba05229d11ceecd16e99065">01508</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="taintcheck_8c.html#ae92e45e8ba05229d11ceecd16e99065">taintcheck_save</a>(<a class="code" href="TEMU__lib_8h.html#652d9ff75e9a5ca7a6667335be7755f7">QEMUFile</a> * f, <span class="keywordtype">void</span> *opaque)
<a name="l01509"></a>01509 {
<a name="l01510"></a>01510   TEMU_CompressState_t state;
<a name="l01511"></a>01511   uint32_t ending = -1;
<a name="l01512"></a>01512   uint8_t separator = 0;
<a name="l01513"></a>01513   
<a name="l01514"></a>01514   <span class="keywordflow">if</span>(TEMU_compress_open(&amp;state, f) &lt; 0)
<a name="l01515"></a>01515     <span class="keywordflow">return</span>;
<a name="l01516"></a>01516   
<a name="l01517"></a>01517   TEMU_compress_buf(&amp;state, (uint8_t *)&amp;<a class="code" href="TEMU__main_8c.html#a93b5270782d60adbbe1e95b3f87befd">temu_plugin</a>-&gt;<a class="code" href="structplugin__interface__t.html#cf6b2847bc302d9e0c94ca21fd81a75d" title="size of taint record for each tainted byte. TEMU sees taint record as untyped buffer...">taint_record_size</a>, 4);  
<a name="l01518"></a>01518   <span class="comment">/*save registers' taint info */</span>
<a name="l01519"></a>01519   TEMU_compress_buf(&amp;state, (uint8_t *)&amp;<a class="code" href="taintcheck_8c.html#5efcc8557acedd802898b6be6e743c77" title="bitmap for registers">regs_bitmap</a>, 8);  
<a name="l01520"></a>01520   TEMU_compress_buf(&amp;state, <a class="code" href="taintcheck_8c.html#ba165d9e6ff6e82b3c63a9be1f6c97cc" title="taint records for registers">regs_records</a>, 64 * <a class="code" href="TEMU__main_8c.html#a93b5270782d60adbbe1e95b3f87befd">temu_plugin</a>-&gt;<a class="code" href="structplugin__interface__t.html#cf6b2847bc302d9e0c94ca21fd81a75d" title="size of taint record for each tainted byte. TEMU sees taint record as untyped buffer...">taint_record_size</a>);
<a name="l01521"></a>01521 
<a name="l01522"></a>01522   <span class="comment">/*save memory taint info */</span>
<a name="l01523"></a>01523   <span class="keywordtype">int</span> i;
<a name="l01524"></a>01524   <span class="keywordflow">for</span> (i = 0; i &lt; ram_size / 64; i++) {
<a name="l01525"></a>01525     <span class="keywordflow">if</span> (!tpage_table[i])
<a name="l01526"></a>01526       <span class="keywordflow">continue</span>;
<a name="l01527"></a>01527 
<a name="l01528"></a>01528   TEMU_compress_buf(&amp;state, (uint8_t *)&amp;i, 4);
<a name="l01529"></a>01529   TEMU_compress_buf(&amp;state, (uint8_t *)&amp;tpage_table[i]-&gt;<a class="code" href="structdisk__record.html#32996293ceaeea3aeebf60ea925f8175">bitmap</a>, 8);
<a name="l01530"></a>01530     TEMU_compress_buf(&amp;state, tpage_table[i]-&gt;records,
<a name="l01531"></a>01531                     64 * <a class="code" href="TEMU__main_8c.html#a93b5270782d60adbbe1e95b3f87befd">temu_plugin</a>-&gt;<a class="code" href="structplugin__interface__t.html#cf6b2847bc302d9e0c94ca21fd81a75d" title="size of taint record for each tainted byte. TEMU sees taint record as untyped buffer...">taint_record_size</a>);
<a name="l01532"></a>01532   TEMU_compress_buf(&amp;state, &amp;separator, 1); <span class="comment">//separator</span>
<a name="l01533"></a>01533   }
<a name="l01534"></a>01534   TEMU_compress_buf(&amp;state, (uint8_t *)&amp;ending, 4); <span class="comment">//ending</span>
<a name="l01535"></a>01535   <span class="comment">/*TODO: save disk and nic info */</span>
<a name="l01536"></a>01536   
<a name="l01537"></a>01537   TEMU_compress_close(&amp;state);
<a name="l01538"></a>01538 }
<a name="l01539"></a>01539 
<a name="l01540"></a>01540 
<a name="l01541"></a><a class="code" href="taintcheck_8c.html#384e6552dddb802516cb07dcaffbce10">01541</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="taintcheck_8c.html#384e6552dddb802516cb07dcaffbce10">taintcheck_load</a>(<a class="code" href="TEMU__lib_8h.html#652d9ff75e9a5ca7a6667335be7755f7">QEMUFile</a> * f, <span class="keywordtype">void</span> *opaque, <span class="keywordtype">int</span> version_id)
<a name="l01542"></a>01542 {
<a name="l01543"></a>01543   uint32_t val;
<a name="l01544"></a>01544   uint8_t separator;
<a name="l01545"></a>01545   TEMU_CompressState_t state;
<a name="l01546"></a>01546   <span class="keywordflow">if</span>(TEMU_decompress_open(&amp;state, f) &lt; 0)
<a name="l01547"></a>01547     <span class="keywordflow">return</span> -EINVAL;
<a name="l01548"></a>01548 
<a name="l01549"></a>01549   <a class="code" href="taintcheck_8c.html#4118f65532fb56172df951567d1c6b1d">taintcheck_clean_memreg</a>();
<a name="l01550"></a>01550 
<a name="l01551"></a>01551   TEMU_decompress_buf(&amp;state, (uint8_t *)&amp;val, 4);
<a name="l01552"></a>01552   <span class="keywordflow">if</span> (val != <a class="code" href="TEMU__main_8c.html#a93b5270782d60adbbe1e95b3f87befd">temu_plugin</a>-&gt;<a class="code" href="structplugin__interface__t.html#cf6b2847bc302d9e0c94ca21fd81a75d" title="size of taint record for each tainted byte. TEMU sees taint record as untyped buffer...">taint_record_size</a>)
<a name="l01553"></a>01553     <span class="keywordflow">return</span> -EINVAL;
<a name="l01554"></a>01554 
<a name="l01555"></a>01555   TEMU_decompress_buf(&amp;state, (uint8_t *)&amp;<a class="code" href="taintcheck_8c.html#5efcc8557acedd802898b6be6e743c77" title="bitmap for registers">regs_bitmap</a>, 8);
<a name="l01556"></a>01556   TEMU_decompress_buf(&amp;state, <a class="code" href="taintcheck_8c.html#ba165d9e6ff6e82b3c63a9be1f6c97cc" title="taint records for registers">regs_records</a>, 64 * val);
<a name="l01557"></a>01557 
<a name="l01558"></a>01558   <span class="keywordtype">int</span> i;
<a name="l01559"></a>01559   <span class="keywordflow">for</span> (TEMU_decompress_buf(&amp;state, (uint8_t *)&amp;i, 4); 
<a name="l01560"></a>01560        i != -1; 
<a name="l01561"></a>01561        TEMU_decompress_buf(&amp;state, (uint8_t *)&amp;i, 4)
<a name="l01562"></a>01562        ) 
<a name="l01563"></a>01563   {
<a name="l01564"></a>01564     <a class="code" href="struct__tpage__entry.html">tpage_entry_t</a> *entry =
<a name="l01565"></a>01565         (<a class="code" href="struct__tpage__entry.html">tpage_entry_t</a> *) qemu_mallocz(<span class="keyword">sizeof</span>(<a class="code" href="struct__tpage__entry.html">tpage_entry_t</a>) + 64 * val);
<a name="l01566"></a>01566     <span class="keywordflow">if</span> (!entry)
<a name="l01567"></a>01567       <span class="keywordflow">return</span> -EINVAL;
<a name="l01568"></a>01568 
<a name="l01569"></a>01569     TEMU_decompress_buf(&amp;state, (uint8_t *)&amp;entry-&gt;<a class="code" href="struct__tpage__entry.html#222b55ca1f0afa174750083b33ccd275">bitmap</a>, 8);
<a name="l01570"></a>01570     TEMU_decompress_buf(&amp;state, entry-&gt;<a class="code" href="struct__tpage__entry.html#5dca50c79db35c0fc6c510c7f6f3db2c">records</a>, 64 * val);
<a name="l01571"></a>01571     TEMU_decompress_buf(&amp;state, &amp;separator, 1);
<a name="l01572"></a>01572     <span class="keywordflow">if</span>(separator != 0) {
<a name="l01573"></a>01573       fprintf(stderr, <span class="stringliteral">"Invalid taintcheck vm state\n"</span>);
<a name="l01574"></a>01574       <span class="keywordflow">return</span> -EINVAL;
<a name="l01575"></a>01575     }
<a name="l01576"></a>01576     tpage_table[i] = entry;
<a name="l01577"></a>01577   }
<a name="l01578"></a>01578 
<a name="l01579"></a>01579   <span class="keywordflow">return</span> 0;
<a name="l01580"></a>01580 }
<a name="l01581"></a>01581 
<a name="l01582"></a>01582 
<a name="l01583"></a><a class="code" href="taintcheck_8h.html#0198f483b97eebf43575cabc19a98341">01583</a> <span class="keywordtype">int</span> <a class="code" href="taintcheck_8c.html#0198f483b97eebf43575cabc19a98341">taintcheck_init</a>()
<a name="l01584"></a>01584 {
<a name="l01585"></a>01585   <span class="keywordtype">int</span> i;
<a name="l01586"></a>01586   <span class="keywordflow">for</span> (i = 0; i &lt; DISK_HTAB_SIZE; i++)
<a name="l01587"></a>01587     LIST_INIT(&amp;disk_record_heads[i]);
<a name="l01588"></a>01588 
<a name="l01589"></a>01589   <span class="keywordflow">return</span> 0;
<a name="l01590"></a>01590 }
<a name="l01591"></a>01591 
<a name="l01592"></a>01592 
<a name="l01593"></a><a class="code" href="taintcheck_8h.html#ea2c34b72ea61e4c47182e6b3fa68694">01593</a> <span class="keywordtype">int</span> <a class="code" href="taintcheck_8c.html#ea2c34b72ea61e4c47182e6b3fa68694">taintcheck_create</a>()
<a name="l01594"></a>01594 {
<a name="l01595"></a>01595   <span class="keywordtype">int</span> nic_records_len, reg_records_len;
<a name="l01596"></a>01596 
<a name="l01597"></a>01597   assert(tpage_table == NULL); <span class="comment">//make sure it is not double created</span>
<a name="l01598"></a>01598 
<a name="l01599"></a>01599   tpage_table = (<a class="code" href="struct__tpage__entry.html">tpage_entry_t</a> **) qemu_malloc((ram_size/64) * <span class="keyword">sizeof</span>(<span class="keywordtype">void</span>*));
<a name="l01600"></a>01600   nic_records_len = 32 * 1024 * <a class="code" href="TEMU__main_8c.html#a93b5270782d60adbbe1e95b3f87befd">temu_plugin</a>-&gt;<a class="code" href="structplugin__interface__t.html#cf6b2847bc302d9e0c94ca21fd81a75d" title="size of taint record for each tainted byte. TEMU sees taint record as untyped buffer...">taint_record_size</a>;
<a name="l01601"></a>01601   <a class="code" href="taintcheck_8c.html#e5345edd4e3618ea3fd53a7b8f46e832" title="taint records for nic">nic_records</a> = qemu_malloc(nic_records_len);
<a name="l01602"></a>01602   reg_records_len = 64 * <a class="code" href="TEMU__main_8c.html#a93b5270782d60adbbe1e95b3f87befd">temu_plugin</a>-&gt;<a class="code" href="structplugin__interface__t.html#cf6b2847bc302d9e0c94ca21fd81a75d" title="size of taint record for each tainted byte. TEMU sees taint record as untyped buffer...">taint_record_size</a>;
<a name="l01603"></a>01603   <a class="code" href="taintcheck_8c.html#ba165d9e6ff6e82b3c63a9be1f6c97cc" title="taint records for registers">regs_records</a> = qemu_mallocz(reg_records_len);
<a name="l01604"></a>01604 <span class="preprocessor">#if TAINT_FLAGS</span>
<a name="l01605"></a>01605 <span class="preprocessor"></span>  <a class="code" href="taintcheck_8c.html#761549a83ed3004382812e355cef7c1e" title="taint records for eflags">eflags_records</a> = qemu_mallocz(32 * <a class="code" href="TEMU__main_8c.html#a93b5270782d60adbbe1e95b3f87befd">temu_plugin</a>-&gt;<a class="code" href="structplugin__interface__t.html#cf6b2847bc302d9e0c94ca21fd81a75d" title="size of taint record for each tainted byte. TEMU sees taint record as untyped buffer...">taint_record_size</a>);
<a name="l01606"></a>01606 <span class="preprocessor">#endif</span>
<a name="l01607"></a>01607 <span class="preprocessor"></span>
<a name="l01608"></a>01608   <span class="keywordflow">if</span> (!tpage_table || !<a class="code" href="taintcheck_8c.html#e5345edd4e3618ea3fd53a7b8f46e832" title="taint records for nic">nic_records</a> || !<a class="code" href="taintcheck_8c.html#ba165d9e6ff6e82b3c63a9be1f6c97cc" title="taint records for registers">regs_records</a> 
<a name="l01609"></a>01609 #<span class="keywordflow">if</span> TAINT_FLAGS
<a name="l01610"></a>01610   || !<a class="code" href="taintcheck_8c.html#761549a83ed3004382812e355cef7c1e" title="taint records for eflags">eflags_records</a>
<a name="l01611"></a>01611 #endif
<a name="l01612"></a>01612     ) {
<a name="l01613"></a>01613     fprintf(stderr, <span class="stringliteral">"out of memory\n"</span>);
<a name="l01614"></a>01614     exit(-1);
<a name="l01615"></a>01615   }
<a name="l01616"></a>01616 
<a name="l01617"></a>01617   bzero(tpage_table, (ram_size/64) * <span class="keyword">sizeof</span>(<span class="keywordtype">void</span>*));
<a name="l01618"></a>01618   bzero(<a class="code" href="taintcheck_8c.html#e5345edd4e3618ea3fd53a7b8f46e832" title="taint records for nic">nic_records</a>, nic_records_len);
<a name="l01619"></a>01619   <a class="code" href="taintcheck_8c.html#5efcc8557acedd802898b6be6e743c77" title="bitmap for registers">regs_bitmap</a> = 0;
<a name="l01620"></a>01620   bzero(<a class="code" href="taintcheck_8c.html#327231a22ed182c09b21712588339ef5" title="bitmap for nic">nic_bitmap</a>, <span class="keyword">sizeof</span>(<a class="code" href="taintcheck_8c.html#327231a22ed182c09b21712588339ef5" title="bitmap for nic">nic_bitmap</a>));
<a name="l01621"></a>01621 <span class="preprocessor">#if TAINT_FLAGS</span>
<a name="l01622"></a>01622 <span class="preprocessor"></span>  eflags_bitmap = 0;
<a name="l01623"></a>01623   bzero(<a class="code" href="taintcheck_8c.html#761549a83ed3004382812e355cef7c1e" title="taint records for eflags">eflags_records</a>, 32 * <a class="code" href="TEMU__main_8c.html#a93b5270782d60adbbe1e95b3f87befd">temu_plugin</a>-&gt;<a class="code" href="structplugin__interface__t.html#cf6b2847bc302d9e0c94ca21fd81a75d" title="size of taint record for each tainted byte. TEMU sees taint record as untyped buffer...">taint_record_size</a>);
<a name="l01624"></a>01624 <span class="preprocessor">#endif</span>
<a name="l01625"></a>01625 <span class="preprocessor"></span>  
<a name="l01626"></a>01626   <a class="code" href="group__main.html#g655c4a0d124e52ec2188c6af01fd8362" title="Register a VM entity for saving and restoring VM states.">register_savevm</a>(<span class="stringliteral">"taintcheck"</span>, 0, 1, <a class="code" href="taintcheck_8c.html#ae92e45e8ba05229d11ceecd16e99065">taintcheck_save</a>, <a class="code" href="taintcheck_8c.html#384e6552dddb802516cb07dcaffbce10">taintcheck_load</a>,
<a name="l01627"></a>01627                   NULL);
<a name="l01628"></a>01628   <span class="keywordflow">return</span> 0;
<a name="l01629"></a>01629 }
<a name="l01630"></a>01630 
<a name="l01631"></a><a class="code" href="taintcheck_8h.html#f61fde817e4429b6e0f0462599ba106e">01631</a> <span class="keywordtype">void</span> <a class="code" href="taintcheck_8c.html#f61fde817e4429b6e0f0462599ba106e">taintcheck_cleanup</a>()
<a name="l01632"></a>01632 {
<a name="l01633"></a>01633   <span class="keywordtype">int</span> i;
<a name="l01634"></a>01634  
<a name="l01635"></a>01635   <span class="comment">//clean nic buffer</span>
<a name="l01636"></a>01636   bzero(<a class="code" href="taintcheck_8c.html#327231a22ed182c09b21712588339ef5" title="bitmap for nic">nic_bitmap</a>, <span class="keyword">sizeof</span>(<a class="code" href="taintcheck_8c.html#327231a22ed182c09b21712588339ef5" title="bitmap for nic">nic_bitmap</a>));
<a name="l01637"></a>01637   qemu_free(<a class="code" href="taintcheck_8c.html#e5345edd4e3618ea3fd53a7b8f46e832" title="taint records for nic">nic_records</a>);
<a name="l01638"></a>01638   <a class="code" href="taintcheck_8c.html#e5345edd4e3618ea3fd53a7b8f46e832" title="taint records for nic">nic_records</a> = NULL;
<a name="l01639"></a>01639  
<a name="l01640"></a>01640   <span class="comment">//clean registers</span>
<a name="l01641"></a>01641   <a class="code" href="taintcheck_8c.html#5efcc8557acedd802898b6be6e743c77" title="bitmap for registers">regs_bitmap</a> = 0;
<a name="l01642"></a>01642   qemu_free(<a class="code" href="taintcheck_8c.html#ba165d9e6ff6e82b3c63a9be1f6c97cc" title="taint records for registers">regs_records</a>);
<a name="l01643"></a>01643   <a class="code" href="taintcheck_8c.html#ba165d9e6ff6e82b3c63a9be1f6c97cc" title="taint records for registers">regs_records</a> = NULL;
<a name="l01644"></a>01644 
<a name="l01645"></a>01645 <span class="preprocessor">#if TAINT_FLAGS</span>
<a name="l01646"></a>01646 <span class="preprocessor"></span>  eflags_bitmap = 0;
<a name="l01647"></a>01647   qemu_free(<a class="code" href="taintcheck_8c.html#761549a83ed3004382812e355cef7c1e" title="taint records for eflags">eflags_records</a>);
<a name="l01648"></a>01648   <a class="code" href="taintcheck_8c.html#761549a83ed3004382812e355cef7c1e" title="taint records for eflags">eflags_records</a> = NULL;
<a name="l01649"></a>01649 <span class="preprocessor">#endif</span>
<a name="l01650"></a>01650 <span class="preprocessor"></span>
<a name="l01651"></a>01651   <span class="comment">//clean memory</span>
<a name="l01652"></a>01652   <span class="keywordflow">for</span> (i = 0; i &lt; ram_size / 64; i++)
<a name="l01653"></a>01653     <span class="keywordflow">if</span> (tpage_table[i]) {
<a name="l01654"></a>01654       qemu_free(tpage_table[i]);
<a name="l01655"></a>01655       tpage_table[i] = 0;
<a name="l01656"></a>01656     }
<a name="l01657"></a>01657   qemu_free(tpage_table);
<a name="l01658"></a>01658   tpage_table = NULL;
<a name="l01659"></a>01659 
<a name="l01660"></a>01660   <span class="comment">//clean disk</span>
<a name="l01661"></a>01661   <span class="keyword">struct </span>disk_record_list_head *head;
<a name="l01662"></a>01662   <a class="code" href="structdisk__record.html">disk_record_t</a> *rec;
<a name="l01663"></a>01663   <span class="keywordflow">for</span> (i = 0; i &lt; DISK_HTAB_SIZE; i++) {
<a name="l01664"></a>01664     head = &amp;disk_record_heads[i];
<a name="l01665"></a>01665     <span class="keywordflow">while</span> (!LIST_EMPTY(head)) {
<a name="l01666"></a>01666       rec = LIST_FIRST(head);
<a name="l01667"></a>01667       LIST_REMOVE(rec, entry);
<a name="l01668"></a>01668       qemu_free(rec);
<a name="l01669"></a>01669     }
<a name="l01670"></a>01670   }
<a name="l01671"></a>01671 
<a name="l01672"></a>01672   <a class="code" href="group__main.html#g5fa8d036145c4828d8eb9b4a8e6a1edd" title="Deregister a VM entity.">deregister_savevm</a>(<span class="stringliteral">"taintcheck"</span>, 0);
<a name="l01673"></a>01673 }
<a name="l01674"></a>01674 
<a name="l01675"></a>01675 
<a name="l01676"></a><a class="code" href="taintcheck_8h.html#7ac7aa2fc9be3b6e2f36004ccf346db5">01676</a> <span class="keywordtype">void</span> <a class="code" href="taintcheck_8c.html#7ac7aa2fc9be3b6e2f36004ccf346db5">taintcheck_mov_i2m</a>()
<a name="l01677"></a>01677 {
<a name="l01678"></a>01678   <span class="keywordtype">int</span> i;
<a name="l01679"></a>01679   <span class="keywordflow">for</span> (i = 0; i &lt; physaddr_index; i++)
<a name="l01680"></a>01680     <a class="code" href="taintcheck_8h.html#7c2754f30df90a588e62ad40d6f27b72">taintcheck_mem_clean</a>(physaddr_info_list[i].ptr,
<a name="l01681"></a>01681                          physaddr_info_list[i].size);
<a name="l01682"></a>01682 
<a name="l01683"></a>01683   physaddr_index = 0;
<a name="l01684"></a>01684 }
<a name="l01685"></a>01685 
<a name="l01686"></a><a class="code" href="taintcheck_8h.html#a8d3a85939ccf47f79662315754b30ab">01686</a> <span class="keywordtype">void</span> <a class="code" href="taintcheck_8c.html#a8d3a85939ccf47f79662315754b30ab">taintcheck_mov_m2r</a>(<span class="keywordtype">int</span> base, <span class="keywordtype">int</span> <a class="code" href="structdisk__record.html#46687f5b8517d581376fe61ce771ee67">index</a>, <span class="keywordtype">int</span> dreg_id)
<a name="l01687"></a>01687 {
<a name="l01688"></a>01688   <span class="keywordtype">int</span> i, regid;
<a name="l01689"></a>01689   <a class="code" href="taintcheck_8h.html#0b668d7779aba29ec1ddfc194618d519">taintcheck_fn2regs</a>(base, index, R_A0, 4);
<a name="l01690"></a>01690 
<a name="l01691"></a>01691   <span class="keywordflow">for</span> (i = 0, regid = dreg_id; i &lt; physaddr_index;
<a name="l01692"></a>01692        i++, regid += physaddr_info_list[i].size) {
<a name="l01693"></a>01693     <a class="code" href="taintcheck_8h.html#a59de35e3cf6276a15845cbe7bc8b0c3">taintcheck_mem2reg</a>(physaddr_info_list[i].ptr,
<a name="l01694"></a>01694                        physaddr_info_list[i].size, regid);
<a name="l01695"></a>01695   }
<a name="l01696"></a>01696   physaddr_index = 0;
<a name="l01697"></a>01697 }
<a name="l01698"></a>01698 
<a name="l01699"></a><a class="code" href="taintcheck_8h.html#6e9df78cb227f27c6a119e5bb454c58a">01699</a> <span class="keywordtype">void</span> <a class="code" href="taintcheck_8c.html#6e9df78cb227f27c6a119e5bb454c58a">taintcheck_mov_r2m</a>(<span class="keywordtype">int</span> base, <span class="keywordtype">int</span> <a class="code" href="structdisk__record.html#46687f5b8517d581376fe61ce771ee67">index</a>, <span class="keywordtype">int</span> reg_id)
<a name="l01700"></a>01700 {
<a name="l01701"></a>01701   <span class="keywordtype">int</span> i, regid;
<a name="l01702"></a>01702   <a class="code" href="taintcheck_8h.html#0b668d7779aba29ec1ddfc194618d519">taintcheck_fn2regs</a>(base, index, R_A0, 4);
<a name="l01703"></a>01703 
<a name="l01704"></a>01704   <span class="keywordflow">for</span> (i = 0, regid = reg_id; i &lt; physaddr_index;
<a name="l01705"></a>01705        i++, regid += physaddr_info_list[i].size) {
<a name="l01706"></a>01706     <a class="code" href="taintcheck_8h.html#23e63eea3b9485175199ba007ad7d7ce">taintcheck_reg2mem</a>(regid, physaddr_info_list[i].size,
<a name="l01707"></a>01707                        physaddr_info_list[i].ptr);
<a name="l01708"></a>01708   }
<a name="l01709"></a>01709   physaddr_index = 0;
<a name="l01710"></a>01710 }
<a name="l01711"></a>01711 
<a name="l01712"></a>01712 
<a name="l01713"></a><a class="code" href="taintcheck_8h.html#a0f41040465808fc502a8e5c6d6ba31c">01713</a> <span class="keywordtype">void</span> <a class="code" href="taintcheck_8c.html#a0f41040465808fc502a8e5c6d6ba31c">taintcheck_reg2TN</a>(<span class="keywordtype">int</span> reg, <span class="keywordtype">int</span> t, <span class="keywordtype">int</span> size)
<a name="l01714"></a>01714 {
<a name="l01715"></a>01715   <a class="code" href="taintcheck_8c.html#974495ac1261e65922b3590a970613a6">clean_register</a>(t &lt;&lt; 2, 4);
<a name="l01716"></a>01716   <a class="code" href="taintcheck_8h.html#4120a768d0dbb8afcf2fddb01f4e9ff1">taintcheck_reg2reg</a>(reg, t, size);
<a name="l01717"></a>01717 }
<a name="l01718"></a>01718 
<a name="l01719"></a><a class="code" href="taintcheck_8h.html#e7560c8a2d2969762890d87b6c498d8c">01719</a> <span class="keywordtype">void</span> <a class="code" href="taintcheck_8c.html#e7560c8a2d2969762890d87b6c498d8c">taintcheck_regh2TN</a>(<span class="keywordtype">int</span> reg, <span class="keywordtype">int</span> t)
<a name="l01720"></a>01720 {
<a name="l01721"></a>01721   <a class="code" href="taintcheck_8c.html#974495ac1261e65922b3590a970613a6">clean_register</a>(t &lt;&lt; 2, 4);
<a name="l01722"></a>01722   <a class="code" href="taintcheck_8h.html#41a4825f78d427d602a03ac29a0bf03f">taintcheck_reg2reg_shift</a>(reg * 4 + 1, t &lt;&lt; 2, 1);
<a name="l01723"></a>01723 }
<a name="l01724"></a>01724 
<a name="l01725"></a><a class="code" href="taintcheck_8h.html#1a221d7cebf28c6d71d0f977db36390a">01725</a> uint32_t <a class="code" href="taintcheck_8c.html#a8822dd37943db4f583fc75f7117d4bd">taintcheck_sidt</a>()
<a name="l01726"></a>01726 {
<a name="l01727"></a>01727   <span class="keywordflow">if</span> (!<a class="code" href="group__main.html#gf24f155e5a9b6ee9bc9a6e6ef9c3987d" title="This flag tells if emulation mode is enabled.">TEMU_emulation_started</a>)
<a name="l01728"></a>01728     <span class="keywordflow">goto</span> no_cheat;
<a name="l01729"></a>01729 <span class="preprocessor">#ifdef CHEAT_SIDT</span>
<a name="l01730"></a>01730 <span class="preprocessor"></span>  <span class="keywordflow">if</span> (<a class="code" href="TEMU__main_8c.html#a93b5270782d60adbbe1e95b3f87befd">temu_plugin</a>-&gt;<a class="code" href="structplugin__interface__t.html#414abf8a059b4015cea043be17e34da6">cheat_sidt</a>()) {
<a name="l01731"></a>01731 <span class="comment">/*    uint32_t val;</span>
<a name="l01732"></a>01732 <span class="comment">    asm ("sidt %0;"</span>
<a name="l01733"></a>01733 <span class="comment">        : :"m"(val)</span>
<a name="l01734"></a>01734 <span class="comment">        );*/</span>
<a name="l01735"></a>01735     <span class="keywordflow">return</span> 0xe59007ff;
<a name="l01736"></a>01736   }
<a name="l01737"></a>01737 <span class="preprocessor">#endif</span>
<a name="l01738"></a>01738 <span class="preprocessor"></span>no_cheat:
<a name="l01739"></a>01739   <span class="keywordflow">return</span> cpu_single_env-&gt;idt.base;
<a name="l01740"></a>01740 }
<a name="l01741"></a>01741 
<a name="l01742"></a><a class="code" href="taintcheck_8h.html#1de71d4872d5c066f413c05c3bcd9938">01742</a> <span class="keywordtype">void</span> <a class="code" href="taintcheck_8c.html#1de71d4872d5c066f413c05c3bcd9938">taintcheck_code2TN</a>(uint32_t vaddr, uint32_t regid, <span class="keywordtype">int</span> size)
<a name="l01743"></a>01743 {
<a name="l01744"></a>01744   <span class="comment">//in the execution context, there should be no page fault</span>
<a name="l01745"></a>01745   uint32_t phys_addr = <a class="code" href="group__main.html#g83dc2500423a7496ae08e0a9e67ab55c" title="Convert virtual address into physical address.">TEMU_get_phys_addr</a>(vaddr);
<a name="l01746"></a>01746   taintcheck_mem2reg_nolookup(phys_addr, vaddr, size, regid);
<a name="l01747"></a>01747 }
<a name="l01748"></a>01748 
<a name="l01749"></a>01749 
<a name="l01750"></a>01750 <span class="comment">/*</span>
<a name="l01751"></a>01751 <span class="comment"> * This is the default taint_propagate implementation.</span>
<a name="l01752"></a>01752 <span class="comment"> * For a Temu plugin, if it does not need to handle it specially, </span>
<a name="l01753"></a>01753 <span class="comment"> * it can specify this function in its callback function definitions</span>
<a name="l01754"></a>01754 <span class="comment"> */</span>
<a name="l01755"></a><a class="code" href="group__taintcheck.html#gf9411e493b746336120fb58c3449135a">01755</a> <span class="keywordtype">void</span> <a class="code" href="group__taintcheck.html#gf9411e493b746336120fb58c3449135a">default_taint_propagate</a>(<span class="keywordtype">int</span> nr_src,
<a name="l01756"></a>01756                             <a class="code" href="structtaint__operand__t.html">taint_operand_t</a> * src_oprnds,
<a name="l01757"></a>01757                             <a class="code" href="structtaint__operand__t.html">taint_operand_t</a> * dst_oprnd,
<a name="l01758"></a>01758                             <span class="keywordtype">int</span> mode)
<a name="l01759"></a>01759 {
<a name="l01760"></a>01760   <span class="keywordtype">int</span> i, j;
<a name="l01761"></a>01761   uint8_t *dst_rec, *src_rec=NULL;
<a name="l01762"></a>01762 
<a name="l01763"></a>01763   <span class="keywordflow">if</span> (mode == PROP_MODE_MOVE &amp;&amp; nr_src == 1) {
<a name="l01764"></a>01764     <span class="comment">//assert(src_oprnds[0].taint);</span>
<a name="l01765"></a>01765     memmove(dst_oprnd-&gt;<a class="code" href="structtaint__operand__t.html#dec24928b14ad823f99afff44dfbe045">records</a>, src_oprnds[0].<a class="code" href="structtaint__operand__t.html#dec24928b14ad823f99afff44dfbe045">records</a>, 
<a name="l01766"></a>01766                  <a class="code" href="TEMU__main_8c.html#a93b5270782d60adbbe1e95b3f87befd">temu_plugin</a>-&gt;<a class="code" href="structplugin__interface__t.html#cf6b2847bc302d9e0c94ca21fd81a75d" title="size of taint record for each tainted byte. TEMU sees taint record as untyped buffer...">taint_record_size</a> * src_oprnds[0].<a class="code" href="structtaint__operand__t.html#4950a2ce5b28b9e1c9fc99fe6c5c4149">size</a>);
<a name="l01767"></a>01767     <span class="keywordflow">return</span>;
<a name="l01768"></a>01768   }
<a name="l01769"></a>01769 
<a name="l01770"></a>01770   <span class="comment">/* deal with multiple sources and tainted index*/</span>
<a name="l01771"></a>01771   <span class="keywordflow">for</span> (i = 0; i &lt; nr_src; i++) {
<a name="l01772"></a>01772     <span class="keywordflow">if</span> (src_oprnds[i].taint == 0)
<a name="l01773"></a>01773       <span class="keywordflow">continue</span>;
<a name="l01774"></a>01774 
<a name="l01775"></a>01775     <span class="keywordflow">for</span> (j = 0; j &lt; src_oprnds[i].<a class="code" href="structtaint__operand__t.html#4950a2ce5b28b9e1c9fc99fe6c5c4149">size</a>; j++)
<a name="l01776"></a>01776       <span class="keywordflow">if</span> (src_oprnds[i].taint &amp; (1 &lt;&lt; j)) {
<a name="l01777"></a>01777         src_rec = src_oprnds[i].<a class="code" href="structtaint__operand__t.html#dec24928b14ad823f99afff44dfbe045">records</a> + j*<a class="code" href="TEMU__main_8c.html#a93b5270782d60adbbe1e95b3f87befd">temu_plugin</a>-&gt;<a class="code" href="structplugin__interface__t.html#cf6b2847bc302d9e0c94ca21fd81a75d" title="size of taint record for each tainted byte. TEMU sees taint record as untyped buffer...">taint_record_size</a>;
<a name="l01778"></a>01778         <span class="keywordflow">goto</span> copy_taint_record;
<a name="l01779"></a>01779       }
<a name="l01780"></a>01780 
<a name="l01781"></a>01781   }
<a name="l01782"></a>01782 
<a name="l01783"></a>01783   <span class="keywordflow">if</span> (!src_rec) <span class="keywordflow">return</span>;
<a name="l01784"></a>01784 
<a name="l01785"></a>01785 copy_taint_record:
<a name="l01786"></a>01786 
<a name="l01787"></a>01787   <span class="keywordflow">for</span> (i = 0; i &lt; dst_oprnd-&gt;<a class="code" href="structtaint__operand__t.html#4950a2ce5b28b9e1c9fc99fe6c5c4149">size</a>; i++) {
<a name="l01788"></a>01788     dst_rec = dst_oprnd-&gt;<a class="code" href="structtaint__operand__t.html#dec24928b14ad823f99afff44dfbe045">records</a> + i*<a class="code" href="TEMU__main_8c.html#a93b5270782d60adbbe1e95b3f87befd">temu_plugin</a>-&gt;<a class="code" href="structplugin__interface__t.html#cf6b2847bc302d9e0c94ca21fd81a75d" title="size of taint record for each tainted byte. TEMU sees taint record as untyped buffer...">taint_record_size</a>;
<a name="l01789"></a>01789     memmove(dst_rec, src_rec, <a class="code" href="TEMU__main_8c.html#a93b5270782d60adbbe1e95b3f87befd">temu_plugin</a>-&gt;<a class="code" href="structplugin__interface__t.html#cf6b2847bc302d9e0c94ca21fd81a75d" title="size of taint record for each tainted byte. TEMU sees taint record as untyped buffer...">taint_record_size</a>);
<a name="l01790"></a>01790   }
<a name="l01791"></a>01791 }
<a name="l01792"></a>01792 
<a name="l01793"></a><a class="code" href="taintcheck_8h.html#91e35fdb7dcd2e97c0aeaab87f1d163d">01793</a> <span class="keywordtype">void</span> <a class="code" href="taintcheck_8c.html#91e35fdb7dcd2e97c0aeaab87f1d163d">do_info_taintmem</a>(<span class="keywordtype">void</span>)
<a name="l01794"></a>01794 {
<a name="l01795"></a>01795   <a class="code" href="group__main.html#g2c35c4aad7c5f7a9e1832adf50950e36" title="print a message to TEMU terminal">term_printf</a>(<span class="stringliteral">"Tainted memory: %d \n"</span>, <a class="code" href="group__taintcheck.html#g86f8d5bb5b48c331c5ccca6615271508">taintcheck_get_sizeof_taintmem</a>());
<a name="l01796"></a>01796 }
<a name="l01797"></a>01797 
<a name="l01798"></a>01798 
<a name="l01799"></a>01799 <span class="preprocessor">#endif //#if TAINT_ENABLED</span>
</pre></div></div>
<hr>
<p class="footer">
Generated on Fri Mar 30 16:18:24 2012 for <a href="http://bitblaze.cs.berkeley.edu/temu.html">TEMU</a> by
<a href="http://www.doxygen.org"><img src="doxygen.png" alt="Doxygen"
align="middle" border="0"/>1.5.8</a><br/>
Copyright &copy; 2008-2009, BitBlaze Project. All Rights Reserved.</p>

<hr>
<!--#include virtual="/attrib.incl" -->

</body>
</html>
